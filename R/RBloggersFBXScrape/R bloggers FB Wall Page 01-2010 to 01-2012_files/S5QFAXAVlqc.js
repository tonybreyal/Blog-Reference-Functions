/*1325632159,176832695*/

if (window.CavalryLogger) { CavalryLogger.start_js(["doIvE"]); }

function TinyPresence(g,c,b,a,e,d,f){this.user=g;this.name=c;this.firstName=b;this.alias=a;this.sitevars=f;this.jslog=JSLogger.create('presence');this._init(d);}TinyPresence.prototype={shutdownDelay:5000,restartDelay:3000,_init:function(a){this.isShutdown=false;this.isShuttingDown=false;this.isRestarting=false;this.isPermaShutdown=false;this.shutdownTime=0;},init:function(){require.ensure(['PresenceUtil'],function(a){this.windowID=a.getSessionID();var c={ON_CONNECT:function(){Arbiter.inform(PresenceMessage.STARTED,{sender:this});this.restart();},ON_SHUTDOWN:function(e,d){switch(e){case channel.HINT_AUTH:return this.loginShutdown();case channel.HINT_CONN:return this.connectionShutdown();case channel.HINT_MAINT:return this.maintenanceShutdown();default:return this.permaShutdown();}}};for(var b in c)Arbiter.subscribe(channel[b],c[b].bind(this));}.bind(this));},updateServerTime:function(a){ServerTime&&ServerTime.update(a);},getTime:function(){return ServerTime&&ServerTime.get();},debug:bagofholding,warn:bagofholding,error:bagofholding,logError:bagofholding,doSync:bagofholding,pauseSync:bagofholding,resumeSync:bagofholding,getErrorDescription:function(a){return window.PresenceUtil&&window.PresenceUtil.getErrorDescription(a);},checkLoginError:function(a){var b=a.getError();if(b==1357001||b==1357004||b==1348009){this.loginShutdown();return true;}return false;},checkMaintenanceError:function(a){return window.PresenceUtil&&PresenceUtil.checkMaintenanceError(a);},permaShutdown:function(){this.isPermaShutdown=true;var a=_tx("Facebook {Chat} is currently unavailable.",{Chat:"Chat"});this.shutdown(false,a,"perma_shutdown");},loginShutdown:function(){var a="Your session has timed out. Please log in.";this.shutdown(false,a,"login_shutdown");},connectionShutdown:function(b){var a=_tx("Facebook {Chat} is currently unavailable.",{Chat:"Chat"});this.shutdown(b,a,"connection_shutdown");},maintenanceShutdown:function(){var a=_tx("Facebook {Chat} is currently down for maintenance.",{Chat:"Chat"});this.shutdown(false,a,"maintenance_shutdown");},versionShutdown:function(){var a=_tx("Please refresh the page to get the latest version of Facebook {Chat}.",{Chat:"Chat"});this.shutdown(false,a,"version_shutdown");},shutdown:function(d,c,a){this.isRestarting=false;this.isShuttingDown=true;var b=Date.now();this.shutdownTime=b;if(!d){this._shutdown(c,0,a);}else setTimeout(this._shutdown.bind(this,c,b,a),this.shutdownDelay,false);},_shutdown:function(b,c,a){if(!this.isShuttingDown&&c==this.shutdownTime)return;if(c&&this.isShutdown)return;if(typeof b!='string'||!b)b=_tx("Facebook {Chat} is currently unavailable.",{Chat:"Chat"});if(typeof a!='string'||!a)a="undefined";this.jslog.warn("displaying_shutdown",{e:a});if(this.isShutdown)return;this.jslog.error("shutdown",{e:a});this.isShutdown=true;Arbiter.inform(PresenceMessage.SHUTDOWN,{sender:this,reason:b});},restart:function(a){this.isShuttingDown=false;this.isRestarting=true;if(!a){this._restart(0);}else this._restart.bind(this,this.shutdownTime).defer(this.restartDelay,false);},_restart:function(a){if(!this.isRestarting||(a&&a!=this.shutdownTime))return;this.isShutdown=false;Arbiter.inform(PresenceMessage.RESTARTED,{sender:this});},start:function(){Arbiter.inform(PresenceMessage.STARTED,{sender:this});},registerStateStorer:bagofholding,registerStateLoader:bagofholding,hasUserCookie:function(a){var b=this.user==getCookie('c_user');if(!b&&a)this.permaShutdown();return b;}};
function Presence(g,c,b,a,e,d,f){this.parent.construct(this,g,c,b,a,e,d,f);}Class.extend(Presence,'TinyPresence');Presence.prototype={_init:function(b){this.parent._init(b);var c=ua.safari();this.isSafari2=(c&&c<500);var a=ua.firefox();this.isFF2=(a&&a<3);this.isWindows=ua.windows();},renderLink:function(b,c,a){return '<a href="'+b+'"'+(a?a:'')+'>'+c+'</a>';},_shutdown:function(b,c,a){this.parent._shutdown(b,c,a);if((!this.isShuttingDown&&c===this.shutdownTime)||(c&&this.isShutdown))return;},_restart:function(a){this.parent._restart(a);if(!this.isRestarting||(a&&a!=this.shutdownTime))return;},isOnline:function(){return Chat.isOnline();}};
function BuddyListNub(){this.parent.construct(this);}Class.extend(BuddyListNub,'NubController');copy_properties(BuddyListNub,{ITEM_HEIGHT:32,TYPEAHEAD_MIN_FRIENDS:10});BuddyListNub.prototype={init:function(b,a,d){this.parent.init(b);this.root=b;this.buddyList=a;this.typeahead=d;this.button=DOM.find(b,'a.fbNubButton');this.label=DOM.find(b,'span.label');this.body=DOM.scry(b,'div.fbNubFlyoutBody')[0];var c=DOM.find(b,'div.fbNubFlyoutTitlebar');Toggler.createInstance(c).setSticky(false);a.subscribe('render',this.flyoutContentChanged.bind(this));a.setScrollContainer(this.body);require.ensure(['ChatConfig','ChannelConnection','ChannelConstants'],function(g,e,f){this.chatConfig=g;this.channelConnection=e;this.channelConstants=f;Arbiter.subscribe('buddylist/availability-changed',this._updateCount.bind(this));Arbiter.subscribe('chat/connect',this._handleConnect.bind(this));if(this.chatConfig.get('blackbird')){require.ensure(['PresencePrivacy'],function(h){h.subscribe(['initialized','privacy-user-presence-changed'],this._handleVisibilityChange.bind(this));}.bind(this));}else Arbiter.subscribe('chat/visibility-changed',this._handleVisibilityChange.bind(this));if(this.chatConfig.get('channel_disconnect_warning')){this.message=DOM.find(b,'div.fbDockChatBuddyListNubMessage div.message');this.warningMsgText=null;this.warningMsgEventListener=null;this.showWarningTimeout=null;this.channelConnection.subscribe(this.channelConnection.CONNECTED,this._handleChannelConnected.bind(this));this.channelConnection.subscribe(this.channelConnection.SHUTDOWN,this._handleChannelShutdown.bind(this));this.channelConnection.subscribe(this.channelConnection.RECONNECTING,this._handleChannelReconnecting.bind(this));this.channelConnection.subscribe([this.channelConnection.MUTE_WARNING,this.channelConnection.UNMUTE_WARNING],this._updateView.bind(this));}this.subscribe('show',this.onShow.bind(this));this.subscribe('hide',this.onHide.bind(this));this.subscribe('resize',this.onResize.bind(this));}.bind(this));Event.listen(b,'keydown',this._onKeyDown.bind(this));Event.listen(this.button,'click',this.onButtonClick.bind(this));d.subscribe(['respond','reset'],function(e,g){if(this._isOpen){var f=this.buddyList.isVisible();if(g&&g.value&&g.value===d.getCore().getValue()&&d.getView().isVisible()){Dock.setUseMaxHeight(this.root,false);this.buddyList.hide();}else this._showBuddyList();if(f!==this.buddyList.isVisible())this.flyoutContentChanged();}}.bind(this));Arbiter.subscribe('sidebar/show',this.hide.bind(this));OrderedFriendsList.subscribe('initialized',function(){this._orderedListCount=OrderedFriendsList.getList().length;}.bind(this));Arbiter.inform('buddylist-nub/initialized',this,Arbiter.BEHAVIOR_PERSISTENT);},getButton:function(){return this.button;},getRoot:function(){return this.root;},_handleConnect:function(a){this._updateView(true);},_getShutdownReason:function(a){switch(a){case this.channelConstants.HINT_AUTH:return "Your session has timed out. Please log in.";case this.channelConstants.HINT_CONN:return _tx("Facebook {Chat} is currently unavailable.",{Chat:"Chat"});case this.channelConstants.HINT_MAINT:return _tx("Facebook {Chat} is currently down for maintenance.",{Chat:"Chat"});default:return _tx("Facebook {Chat} is currently unavailable.",{Chat:"Chat"});}},_getReconnectMsg:function(d){var e;if(d>this.chatConfig.get('warning_countdown_threshold_msec')){var a=$N('a',{href:'#',className:'fbChatReconnectLink'},"Try again");var c=$N('div',a);var b=c.innerHTML;e=HTML(_tx("Unable to connect to chat. {try-again-link}",{'try-again-link':b}));}else if(d>1000){e=_tx("Unable to connect to chat. Reconnecting in {seconds}...",{seconds:Math.floor(d/1000)});}else e="Unable to connect to chat. Reconnecting...";return e;},_resetShowWarningTimeout:function(){if(this.showWarningTimeout){clearTimeout(this.showWarningTimeout);this.showWarningTimeout=null;}},_handleChannelConnected:function(a){this._resetShowWarningTimeout();if(this.buddyList.isVisible())Chat.goOnline();this.warningMsgText=null;this._updateView();},_handleChannelShutdown:function(b,a){this._resetShowWarningTimeout();this.warningMsgText=this._getShutdownReason(a);this._updateView();},_handleChannelReconnecting:function(b,a){this._resetShowWarningTimeout();this.warningMsgText=this._getReconnectMsg(a);if(a>1000){if(a>this.chatConfig.get('warning_countdown_threshold_msec')){if(this.warningMsgEventListener){this.warningMsgEventListener.remove();this.warningMsgEventListener=null;}this.warningMsgEventListener=Event.listen(this.message,'click',function(event){if(CSS.hasClass(event.getTarget(),'fbChatReconnectLink')){this._tryReconnect();event.kill();}}.bind(this));}this.showWarningTimeout=setTimeout(this._handleChannelReconnecting.bind(this,b,a-1000),1000,false);}this._updateView();},_tryReconnect:function(){if(this.channelConnection.disconnected())this.channelConnection.reconnect();},_handleVisibilityChange:function(){this._updateView();if(!Chat.isOnline())this.hide();},_updateView:function(d){var b=ge('fbDockChat');CSS.conditionClass(b,'offline',!Chat.isOnline());if(this.chatConfig.get('channel_disconnect_warning'))CSS.conditionClass(b,'error',this.channelConnection.disconnected());if(this.chatConfig.get('channel_disconnect_warning')&&this.channelConnection.disconnected())DOM.setContent(this.message,this.warningMsgText);if(!Chat.isOnline()){this._setLabel(_tx("{Chat} (Offline)",{Chat:"Chat"}));}else if(this.chatConfig.get('channel_disconnect_warning')&&this.channelConnection.disconnected()){this._setLabel(_tx("{Chat} (Disconnected)",{Chat:"Chat"}));}else{var a=AvailableList.getOnlineCount(true);if(a){var c=_tx("{Chat} {number-available}",{Chat:"Chat",'number-available':['<span class="count">','(<strong>',a,'</strong>)','</span>'].join('')});this._setLabel(HTML(c));}else this._setLabel("Chat",d);}},onButtonClick:function(){this._conditionallyShowTypeahead();if(CSS.shown(this.typeahead.getElement())){var a=this.subscribe('show',function(){this.typeahead.getCore().getElement().focus();}.bind(this));this.unsubscribe.bind(this,a).defer();}},onHide:function(){this._isOpen=false;this.buddyList.subscribe('initialized',function(){if(this._buddyListRenderSubscription)this.buddyList.unsubscribe(this._buddyListRenderSubscription);this.buddyList.hide();}.bind(this));this.typeahead.getCore().reset();},_onKeyDown:function(event){var a=Event.getKeyCode(event);if(a===KEYS.ESC&&!CSS.hasClass(this.root,'menuOpened')){this.hide();return false;}},onResize:function(){var a=Vector2.getElementDimensions(this.body).y-5;this.buddyList.setNumTopFriends(Math.floor(a/BuddyListNub.ITEM_HEIGHT));},_showBuddyList:function(){this._buddylistRenderSubscription=this.buddyList.subscribe('render',Dock.setUseMaxHeight.bind(Dock,this.root,false));this.buddyList.show();},onShow:function(){this._isOpen=true;if(this.chatConfig.get('channel_disconnect_warning')&&this.channelConnection.disconnected()){this._tryReconnect();this._showBuddyList();}else Chat.goOnline(function(){this.buddyList.subscribe('initialized',this._showBuddyList.bind(this));}.bind(this));},_setLabel:function(a,c){var b=this.label.cloneNode(true);DOM.setContent(b,a);DOM.replace(this.label,b);this.label=b;this.throbber&&CSS.conditionShow(this.throbber,!!c);},_conditionallyShowTypeahead:function(){CSS.conditionShow(this.typeahead.getElement(),this._orderedListCount>=BuddyListNub.TYPEAHEAD_MIN_FRIENDS);},_updateCount:function(){this._updateView();this._conditionallyShowTypeahead();}};
var OrderedFriendsList=window.OrderedFriendsList||(function(){var a=[];var b={};var c=false;return copy_properties(new Arbiter(),{init:function(d){this.init=bagofholding;a=d;a.forEach(function(f,e){b[f]=e;});c=true;this.inform('initialized',{},Arbiter.BEHAVIOR_PERSISTENT);},contains:function(d){return d in b;},compare:function(d,e){var j=OrderedFriendsList.getRank(d);var k=OrderedFriendsList.getRank(e);if(j!==k)return j-k;var h=window.ShortProfiles&&window.ShortProfiles.getNow(d);var i=window.ShortProfiles&&window.ShortProfiles.getNow(e);var f=((h||{}).name||'~').toLowerCase();var g=((i||{}).name||'~').toLowerCase();if(f!==g)return f<g?-1:1;return 0;},getList:function(){var d=$A(a);d=d.filter(function(e){var f=window.ShortProfiles&&ShortProfiles.getNow(e);return !f||f.type=="friend";});return d;},getRank:function(d){return d in b?b[d]:a.length;},isReady:function(){return c;}});})();
function ChatOrderedList(a){this._root=a;this._items={};this._isVisible=false;this._excludedIds={};this._numTopFriends=5;this._chatConfig=null;this._channelConnection=null;this._hasRendered=false;this._preventRendering=false;}Class.mixin(ChatOrderedList,'Arbiter',{init:function(b,a){require.ensure(['AvailableList','ChatConfig','ChannelConnection','ChatVisibility','PresencePrivacy'],function(c,e,d,f,g){this._template=b;this._messageTemplate=a;this._availableList=c;this._chatConfig=e;this._channelConnection=d;this._chatVisibility=f;this._presencePrivacy=g;Event.listen(this._root,'click',this._onClick.bind(this));Event.listen(this._root,'mouseenter',this._mouseEnter.bind(this));Event.listen(this._root,'mouseleave',this._mouseLeave.bind(this));OrderedFriendsList.subscribe('initialized',this.update.shield(this));Arbiter.subscribe(['chat-visibility/initialized',AvailableListConstants.ON_AVAILABILITY_CHANGED],this.update.shield(this));if(this._chatConfig.get('blackbird'))this._presencePrivacy.subscribe('privacy-changed',this.update.shield(this));if(this._chatConfig.get('channel_disconnect_warning'))this._channelConnection.subscribe([this._channelConnection.CONNECTED,this._channelConnection.RECONNECTING,this._channelConnection.SHUTDOWN,this._channelConnection.MUTE_WARNING,this._channelConnection.UNMUTE_WARNING],this.update.shield(this));this.inform('initialized',this,Arbiter.BEHAVIOR_PERSISTENT);this._inited=true;this.render();}.bind(this));},_getAvailableList:function(){return this._availableList.getOnlineIDs().filter(function(a){return !(a in this._excludedIds);}.bind(this));},_getListItem:function(c){var d=this._items[c];if(d){var b=this._availableList.get(c);var a=(!this._chatConfig.get('blackbird')||this._presencePrivacy.allows(c))&&(!this._chatConfig.get('channel_disconnect_warning')||!this._channelConnection.disconnected());CSS.conditionClass(d,'active',b===AvailableListConstants.ACTIVE&&a);CSS.conditionClass(d,'idle',b===AvailableListConstants.IDLE&&a);CSS.conditionClass(d,'mobile',b===AvailableListConstants.MOBILE&&a);CSS.conditionClass(d,'invis',!a);}return d;},getRoot:function(){return this._root;},getSortedList:function(d){var m=OrderedFriendsList.getList().filter(function(r){return !(r in this._excludedIds);}.bind(this));if(this._chatConfig.get('blackbird'))m=m.filter(function(r){return this._presencePrivacy.getFriendVisibility(r)!==this._presencePrivacy.BLACKLISTED;}.bind(this));var h=[];var l=this._chatVisibility.isOnline();if(l){if(this._chatConfig.get('blackbird')&&this._presencePrivacy.getOnlinePolicy()===this._presencePrivacy.ONLINE_TO_WHITELIST){var p=m,a={};var e,f;m=[];for(e=0;e<p.length;++e){f=p[e];if(this._presencePrivacy.allows(f)){a[f]=true;m.push(f);}}var q=this._presencePrivacy.getWhitelist();for(e=0;e<q.length;++e){f=q[e];if(!(f in a))m.push(f);}for(e=0;e<p.length;++e){f=p[e];if(!this._presencePrivacy.allows(f))m.push(f);}}var k=this._chatConfig.get('ordered_list.top_friends',0);var c=this._chatConfig.get('ordered_list.available_target',0);var o=Math.floor(this._numTopFriends*c);var n=[];for(var e=0,g=m.length;e<g&&o>0;e++){var f=m[e];var b=this._availableList.get(f)===AvailableListConstants.ACTIVE;if(b||e<k){h.push(f);b&&o--;}else n.push(f);}if(e<g)Array.prototype.push.apply(n,m.slice(e));if(h.length<this._numTopFriends)Array.prototype.push.apply(h,n);}else Array.prototype.push.apply(h,m);h=h.slice(0,this._numTopFriends);if(h.length===this._numTopFriends){var i=Object.from(h);var j=this._getAvailableList().filter(function(r){return !(r in i);}).length;j&&h.splice(-1);}h.sort(this._sort.bind(this));return h;},hide:function(){if(!this._isVisible)return;this._isVisible=false;CSS.hide(this._root);this.inform('hide');},_onClick:function(event){var e=event.getTarget();var b=Parent.byTag(e,'li');if(b){var a=DataStore.get(b,'id');if(a){var d='ordered_list';var c=b;while(b.previousSibling){b=b.previousSibling;if(CSS.hasClass(b,'separator')){d='more_online_friends';break;}}require.ensure(['ShortProfiles'],function(f){f.get(a,function(g){Chat.openTab(a,g.name,'friend',d);});});Arbiter.inform('chat-ordered-list/click',{id:a});this.inform('click',{id:a});if(!this._chatConfig.get('blackbird'))Chat.goOnline();}else if(CSS.hasClass(b,'separator')&&Parent.byClass(e,'inner'))this.scrollTo(b);return false;}},_mouseEnter:function(){this._preventRendering=true;},_mouseLeave:function(){this._preventRendering=false;},setExcludedIds:function(a){this._excludedIds=Object.from(a||[]);},setNumTopFriends:function(a){if(a!==this._numTopFriends){this._numTopFriends=a;this.render();}},_sort:function(a,d){if(this._chatConfig.get('blackbird')){var b=this._sortByAllowed(a,d);if(b!==0)return b;}var c=this._sortAlphabetical(a,d);if(c!==0)return c;return OrderedFriendsList.compare(a,d);},_sortByAllowed:function(a,d){var b=this._presencePrivacy.allows(a);var c=this._presencePrivacy.allows(d);if(b!==c)return b?-1:1;return 0;},_sortAlphabetical:function(a,b){var e=window.ShortProfiles&&window.ShortProfiles.getNow(a);var f=window.ShortProfiles&&window.ShortProfiles.getNow(b);var c=((e||{}).name||'~').toLowerCase();var d=((f||{}).name||'~').toLowerCase();if(c!==d)return c<d?-1:1;return 0;},_sortMobile:function(a,c){var b=this._availableList.get(a)===AvailableListConstants.MOBILE;var d=this._availableList.get(c)===AvailableListConstants.MOBILE;if(b^d)return d?-1:1;return this._sortAlphabetical(a,c);},render:function(){this.render=debounce(function(){if(!this._inited||!this._isVisible||!OrderedFriendsList.isReady()||(this._preventRendering&&this._hasRendered))return;this._hasRendered=true;var j=this.getSortedList();var e=[];var c;var d;for(var b=0,g=j.length;b<g;b++){c=j[b];d=this._getListItem(c);if(d){e.push(d);}else this._renderListItem(c,this.render.bind(this));}var a=this._getAvailableList();var k=Object.from(j);a=a.filter(function(m){return !(m in k);});a.sort(this._sortMobile.bind(this));if(a.length&&e.length)e.push(HTML('<li class="separator">'+'<div class="outer">'+'<div class="inner">'+'<span class="text">'+_tx("{MORE ONLINE FRIENDS} ({=count})",{'MORE ONLINE FRIENDS':"MORE ONLINE FRIENDS",'=count':a.length})+'</span>'+'<div class="dive"><span class="bar"></span></div>'+'</div>'+'</div>'+'</li>'));for(var f=0,h=a.length;f<h;f++){c=a[f];d=this._getListItem(c);if(d){e.push(d);}else this._renderListItem(c,this.render.bind(this));}if(!j.length&&!a.length){var i=this._messageTemplate.render();var l=XHPTemplate.getNode(i,'message');DOM.setContent(l,"No one is available to chat.");e.push(i);}if(e.length){DOM.setContent(this._root,e);this.inform('render',{},Arbiter.BEHAVIOR_PERSISTENT);}}.bind(this),0,false);this.render();},_renderListItem:function(b,a){require.ensure(['ShortProfiles'],function(c){c.get(b,function(g){if(g.type==='friend'){var d=this._template.render();ChatQuietLinks.silence(d);var f=XHPTemplate.getNode(d,'profile-photo');f.setAttribute('src',g.thumbSrc);var e=XHPTemplate.getNode(d,'name');DOM.setContent(e,g.name);DataStore.set(d,'id',b);this._items[b]=d;a&&a(d);}}.bind(this));}.bind(this));},show:function(){if(this._isVisible)return;this._isVisible=true;CSS.show(this._root);this.render();this.inform('show');},isVisible:function(){return this._isVisible;},update:function(){this.render();},setScrollContainer:function(a){if(DOM.contains(a,this._root))this._scrollContainer=a;},scrollTo:function(c){if(!this._scrollContainer)return;var e=this._scrollContainer.scrollHeight;var a=this._scrollContainer.clientHeight;var d=this._scrollContainer.scrollTop;var f=Math.min(c.offsetTop,e-a);if(d!==f){var b=Math.abs(f-d)/this._scrollContainer.clientHeight*500;animation(this._scrollContainer).to('scrollTop',f).ease(animation.ease.end).duration(b).go();}}});
(function(){if(window.ChatSendQueue)return;window.ChatSendQueue=function(k,j){this._id=k;this._handler=j;this._messages=[];this._timeout=null;this._started=false;};var e='pending',h='sent',a='acked',c='delivered',d=3,g=false,i=1000,b=10000,f=20000;copy_properties(ChatSendQueue.prototype,{_getLogger:function(){return Chat.getLogger('chat_msg');},_indexOf:function(k){for(var j=0;j<this._messages.length;j++)if(this._messages[j].id==k)return j;return -1;},_setExpiration:function(j){var k=(new Date()).getTime();if(j.state==e){j.expiration=k+f;}else j.expiration=k+b;return true;},_setState:function(j,k){j.state=k;return this._setExpiration(j);},_onTimeout:function(){var k=(new Date()).getTime();if(this._handler.isTransportAvailable()){if(!this._started){this._started=true;this._startedTime=k;this._messages.filter(this._setExpiration);}}else if(this._messages.length>0){this._getLogger().warn('queued_send');this._started=false;clearTimeout(this._timeout);this._timeout=this._onTimeout.bind(this).defer(i,g);return;}var m=0;var l=null;var j=0;this._messages=this._messages.filter(function(n){if(n.expiration<k){this._getLogger().error('drop_'+n.state,{id:n.id});this._handler.onTimeout(n.id,n.state,n.msg);return false;}if(!j||j>n.expiration)j=n.expiration;if(n.state==h){m++;}else if(n.state==e&&!l)l=n;return true;}.bind(this));if(m===0&&l){this._setState(l,h);this._setExpiration(l);this._getLogger().log('send',{id:l.id,retries:l.retries});this._handler.sendToServer(l.id,l.msg);}if(this._timeout){clearTimeout(this._timeout);this._timeout=null;}if(j){j=Math.min(i,j-k);this._timeout=this._onTimeout.bind(this).defer(j,g);}},_logAckStatus:function(j,k){var l=function(){this._getLogger().rate('send_t'+k,j.state=='delivered');}.bind(this);setTimeout(l,k*1000,false);},sendToServer:function(l,k,j){require.ensure(['ChatConfig'],function(m){j=j||b;var q=(new Date()).getTime();var p={id:l,state:e,msg:k,retries:m.get('ChatSendQueue.NumRetries',d),now:q,times:[{created:q}]};this._setExpiration(p);this._messages.push(p);var n=m.get('ack_checks',[2,5,10,20]);for(var o=0;o<n.length;o++)this._logAckStatus(p,n[o]);this._getLogger().debug('queue',{id:l});this._onTimeout();}.bind(this));},onSend:function(n,k,j){this._getLogger().debug('on_send',{id:n,error:k});var o=(new Date()).getTime();var l=this._indexOf(n);if(l>=0){var m=this._messages[l];m.times.push({on_send:o});if(m.state==a){this._getLogger().warn('on_send_already_acked',{id:n});}else{if(m.state==e)this._getLogger().warn('on_send_pending',{id:n});if(!k){this._setState(m,a);}else if(k=='transport_error'&&m.retries>0){this._getLogger().warn('on_send_retrying',{id:n});m.retries--;this._setState(m,e);}else{this._getLogger().error('drop_error',{id:n,state:m.state,error:k});this._messages.splice(l,1);this._handler.onTimeout(m.id,m.state,m.msg,k,j);}}}else this._getLogger().warn('on_send_unknown',{id:n});this._onTimeout();},onReceive:function(m){var n=(new Date()).getTime();var j=false;for(var k=0;k<this._messages.length;k++){var l=this._messages[k];if(l.id!=m)continue;j=true;l.times.push({on_receive:n});if(l.state!=a)this._getLogger().warn('on_receive_out_of_order',{id:m,state:l.state});this._messages.splice(k,1);this._setState(l,c);this._getLogger().log('on_delivered',{id:m});this._handler.onDelivered(l.id,l.msg);break;}if(!j)this._getLogger().warn('on_receive_unknown',{id:m});this._onTimeout();return j;},forEach:function(j){this.inForEach=true;this._messages=this._messages.filter(function(k){return !j(k.id,k.msg,k.state);}.bind(this));this.inForEach=false;this._onTimeout();},findById:function(k){var j=this._indexOf(k);return (j<0)?null:this._messages[j].msg;},discard:function(l){if(this.inForEach){throw "discard cannot be called from within a forEach call.";}else if(l===undefined){if(this._messages.length>0)this._getLogger().log('discard',{id:'all'});this._messages=[];clearTimeout(this._timeout);this._timeout=null;}else{var j=this._indexOf(l);if(j>=0){var k=this._messages[j];this._getLogger().log('discard',{id:l});this._messages.splice(j,1);this._onTimeout();}}},onDump:function(k,j){j.pending_messages=j.pending_messages||[];j.pending_messages.push({id:this._id,messages:this._messages});j.channel_start_time=this._startedTime;}});})();
LogMessageType={VIDEO_CALL:0,THREAD_NAME:4,THREAD_IMAGE:5};
function ChatTabActions(a){this._container=a;this._actions={};this._actionOrder=[];this._visibilityChanged=false;this._anyVisible=false;this.actionClass='action';}copy_properties(ChatTabActions.prototype,{anyVisible:function(){return this._anyVisible;},appendAction:function(c,b,a){this._addAction(c,b,a);this._actionOrder.push(c);return this;},prependAction:function(c,b,a){this._addAction(c,b,a);this._actionOrder.unshift(c);return this;},removeAction:function(a){delete this._actions[a];return this;},setVisible:function(b,c){var a=this._actions[b];if(a&&a.visible!=c){a.visible=c;this._visibilityChanged=true;}return this;},refresh:function(){if(this._visibilityChanged){this._render();this._visibilityChanged=false;return true;}return false;},_render:function(){DOM.empty(this._container);var c=this._actions;var b=this._actionOrder;this._anyVisible=false;var d=[];for(var e=0;e<b.length;++e){var a=c[b[e]];if(a.visible){if(this._anyVisible)d.push($N('span',{className:'divider'},HTML(' &middot; ')));d.push(a.create_element());this._anyVisible=true;}}DOM.appendContent(this._container,d);this._container.style.display=this._anyVisible?'block':'none';},_addAction:function(c,b,a){if(typeof b=='string'){var d=b;b=function(){return $N('a',{className:this.actionClass,href:'#'},d);}.bind(this);}this._actions[c]={create_element:function(){var e=b();Event.listen(e,'click',a);return e;},visible:false};this._visibilityChanged=true;}});
function TypingIndicator(a,b,d,c){this.id=a;this.input=b;this.source=d;this.callback=null;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('typ'),this.onTyping.bind(this));this.remoteState=TypingDetector.INACTIVE;this.notifyTimer=null;c=c||{};this.notifyDelay=c.notifyDelay||this.notifyDelay;this._typingDetector=new TypingDetector(b);this._typingDetector.init(c);this._typingDetector.subscribe('change',this._stateChange.bind(this));}copy_properties(TypingIndicator.prototype,{notifyDelay:1000,setIgnoreEnter:function(a){var b=a?[KEYS.RETURN]:[];this._typingDetector.setIgnoreKeys(b);},resetState:function(){this.remoteState=TypingIndicator.INACTIVE;this._typingDetector.reset();clearTimeout(this.notifyTimer);this.notifyTimer=null;},_stateChange:function(a,b){if(b!=TypingDetector.QUITTING){clearTimeout(this.notifyTimer);this.notifyTimer=this._notifyState.shield(this,b).defer(this.notifyDelay,false);}else this._notifyState(b,true);},_notifyState:function(b,a){require.ensure(['ChannelManager','ChatConfig','PresencePrivacy'],function(c,d,e){var i=this.id;var g=window.ShortProfiles&&ShortProfiles.getNow(i);var h=Chat.isOnline()&&g&&g.type=="friend";if(d.get('blackbird'))h&=e.allows(i);if(h&&b!=this.remoteState){this.remoteState=b;if(!c.iframeEverLoaded)return;var f={typ:b,to:i,source:this.source};new AsyncRequest().setHandler(this._onTypResponse.bind(this,i)).setErrorHandler(bagofholding).setData(f).setURI('/ajax/messaging/typ.php').setAllowCrossPageTransition(true).setOption('asynchronous',!a).send();}}.bind(this));},_onTypResponse:function(b,a){require.ensure(['AvailableList'],function(c){var d=a.getPayload()||{};if(d.offline)c.set(b,AvailableListConstants.OFFLINE,'typing_response');}.bind(this));},setCallback:function(a){this.callback=a;},onTyping:function(b,a){this.callback&&this.callback(a.obj);}});
function ChatThreadTab(a,e,f,b,d,c){this.parent.construct(this,a,e,f,b,d,c);}Class.extend(ChatThreadTab,'ChatTab');ChatThreadTab.prototype={rendererName:'chat-thread-tab',hasThread:true,_lastStatusUpdateTime:0,_participantStatuses:null,_toolbarUpdateTimeoutID:null,getPostType:function(){return 'thread';},getTabMsgType:function(){return 'thread_msg';},getAvailability:function(){return AvailableListConstants.ACTIVE;},_handleStatusChange:function(){var a=false;if(this._participantStatuses===null){a=true;}else for(var b in this._participantStatuses)if(this._participantStatuses[b]!=this.chatDisplay.availableList.get(b)){a=true;break;}if(a)require.ensure(['ChatConfig'],function(c){var d=Math.floor(c.get('chat_tab_user_status_update_variation_range_ms')*Math.random());this._toolbarUpdateTimeoutID=setTimeout(this._sendToolbarUpdateRequest.bind(this),d,false);}.bind(this));},close:function(){this.parent.close();if(this._toolbarUpdateTimeoutID)clearTimeout(this._toolbarUpdateTimeoutID);},_sendToolbarUpdateRequest:function(){require.ensure(['ChatConfig'],function(a){this._toolbarUpdateTimeoutID=null;var b=(new Date()).getTime();if(b-this._lastStatusUpdateTime>a.get('chat_tab_user_status_update_min_interval_ms'))new AsyncRequest().setData({id:this.id,has_thread:this.getHasThread()}).setURI('/ajax/chat/multichat/update_toolbar.php').setErrorHandler(this._onUpdateError.bind(this)).send();}.bind(this));},_onUpdateError:function(b){var a=this.chatDisplay.templates['chat-sheet-notice'].render();DOM.setContent(XHPTemplate.getNode(a,'text'),b.errorDescription);this.openSheet(a,true);},setParticipantStatuses:function(a){this._participantStatuses=a;},refreshStatusUpdateTime:function(){this._lastStatusUpdateTime=(new Date()).getTime();},addRecipients:function(b){this.parent.addRecipients(b);if(!this.getHasThread())for(var a=0;a<b.length;a++)this.pendingNewRecipients.push(b[a]);return this;},showSendAsMessageLinks:bagofholding,getSendData:function(a){send_data=this.parent.getSendData(a);if(this.pendingNewRecipients.length>0||!this.hasThread)send_data.new_thread=true;return send_data;},_onSendResponse:function(b,a,c){this.setHasThread(true);this.parent._onSendResponse(b,a,c);},reloadHistoryOnRestart:function(){return this.getHasThread();},isCanonical:function(){return false;},_buildUI:function(){var c=this.parent._buildUI();var b=XHPTemplate.getNode(c,'dropdown');if(b){var a=XHPTemplate.getNode(c,'addToThreadLink');if(a)this._handlers.push(Event.listen(a,'click',this.showAddFriendFromIcon.bind(this)));var d=XHPTemplate.getNode(c,'unsubscribeLink');if(d)this._handlers.push(Event.listen(d,'click',this.unsubscribeFromThread.bind(this)));}return c;},unsubscribeFromThread:function(){if(this.getHasThread())Messaging.unsubscribeFromThread(this.id);this.chatDisplay.closeTab(this.id);},showAddFriendFromIcon:function(){this.showAddFriend();return false;},_messagingMarkThreadAsRead:function(a){Messaging.markAsRead(a);},getConversationURI:bagof(''),getProfileURI:function(){return Messaging.getInboxThreadURI(this.id);},setHasThread:function(a){this.hasThread=a;if(!a)this.historyLoaded=true;this.setShowConversationLink(a);},setShowConversationLink:function(b){var a=XHPTemplate.getNode(this.tabHandle,'conversationLink');if(a)if(b){CSS.show(a);}else CSS.hide(a);},getHasThread:function(){return this.hasThread;}};
function ChatGroupTab(a,b,d,f,e,c){this.parent.construct(this,a,b,d,d,e,c);this._facepileHandlers=[];this.chatDisplay.shortProfiles.get(Env.user,bagofholding);}Class.extend(ChatGroupTab,'ChatTab');ChatGroupTab.prototype={rendererName:'chat-group-tab',getPostType:function(){return 'group';},getTabMsgType:function(){return 'group_msg';},focus:function(c,a,b){this.parent.focus(c,a,b);this._setUpdateFacepiles(true);},unfocus:function(){this.parent.unfocus();this._setUpdateFacepiles(false);},close:function(){this.parent.close();this._setUpdateFacepiles(false);this._removeFacepileHandlers();},_facepilesToken:null,_lastUpdateRequestTimeMS:0,_memberStatuses:null,_setUpdateFacepiles:function(a){require.ensure(['ChatConfig'],function(b){if(a){if(!this._facepilesToken){this._facepilesToken=setInterval(this._sendFacepileRequest.bind(this),b.get('group_chat_facepile_update_interval_ms'),false);this._sendFacepileRequest();}}else if(this._facepilesToken){clearInterval(this._facepilesToken);this._facepilesToken=null;}}.bind(this));},_resetUpdateFacepiles:function(){this._setUpdateFacepiles(false);this._setUpdateFacepiles(true);},_sendFacepileRequest:function(){this._lastUpdateRequestTimeMS=(new Date()).getTime();new AsyncRequest().setData({id:this.id}).setURI('/ajax/groups/chat/update_facepiles.php').setHandler(this._renderFacepile.bind(this)).send();},_renderFacepile:function(b){this._removeFacepileHandlers();var a=b.getPayload();this._updateMemberStatuses(a.statuses);if(a.response_html)DOM.setContent(this.chatInfo,HTML(a.response_html));if(a.facepile_click_info)a.facepile_click_info.each(function(d){var c=DOM.scry($(d.id),'a');if(c.length)this._facepileHandlers.push(Event.listen(c[0],"click",function(){chatDisplay.focusTab(d.uid,true,d.name,d.firstName);return false;}));}.bind(this));this.handleResize();},_updateMemberStatuses:function(a){this._memberStatuses=a;},_removeFacepileHandlers:function(){while(this._facepileHandlers.length)this._facepileHandlers.pop().remove();},showSendAsMessageLinks:bagofholding,playSound:bagofholding,_buildUI:function(){var d=this.parent._buildUI();var c=XHPTemplate.getNode(d,'reportLink');if(c)CSS.addClass(c,'hidden_elem');this.chatInfo=XHPTemplate.getNode(d,'facepileHolder');var a=XHPTemplate.getNode(d,'dropdown');if(a){var b=XHPTemplate.getNode(d,'muteGroupLink');if(b)b.setAttribute('ajaxify',URI(b.getAttribute('ajaxify')).addQueryData({id:this.id}));}},isCanonical:function(){return false;},getAvailability:function(){return AvailableListConstants.ACTIVE;},_handleStatusChange:function(){require.ensure(['ChatConfig'],function(a){if(this.focused&&this._memberStatuses){var d=keys(this._memberStatuses);var b=false;for(var c=0;c<d.length;c++)if(this._memberStatuses[d[c]]!=this.chatDisplay.availableList.get(d[c])){b=true;break;}var e=(new Date()).getTime();if(b&&e-this._lastUpdateRequestTimeMS>a.get('chat_tab_user_status_update_min_interval_ms'))this._resetUpdateFacepiles();}}.bind(this));},mentionsUser:function(a){if(a.from==Env.user)return false;var b=this.chatDisplay.shortProfiles.getNow(Env.user);if(b){var c=a.msg.text;if(b.vanity&&c.indexOf(b.vanity)!=-1)return true;if(b.firstName&&c.toLowerCase().indexOf(b.firstName.toLowerCase())!=-1)return true;}return false;},newMsg:function(a){if(this.mentionsUser(a))this.parent.playSound();this.parent.newMsg(a);},getConversationURI:bagof(''),getProfileURI:function(){return URI(Env.www_base).setPath('/').setQueryData({sk:'group_'+this.id});}};
function ChatTab(a,d,f,b,h,e){this.chatDisplay=a;this.id=d;this.name=f||"";this.firstName=b||this._guessFirstName();this.tabRef='chatDisplay.tabs['+this.id+']';this._jslog=JSLogger.create('tabs');this.tabDisabled=false;this.numMissed=h||0;this.missedTime=e;this.focused=false;this.lastLogItem=null;this.historyLoaded=false;this.failedSentMsgs=[];this.historyRequestID=0;this.bounceAnimation=null;this.pendingNewRecipients=[];this.allRecipients=[];this.minTextHeight=this.minTextHeightPopin;this.lastMessageAt=null;this._handlers=[];this._subscriptions=[];var i=this;var c={isTransportAvailable:function(){return i.chatDisplay.channelManager.iframeEverLoaded;},sendToServer:function(k,j){i._sendMessage(j);},onTimeout:this._handleSendErrors.bind(this),onDelivered:function(k,j){i._setMsgInfoMarkup(k,'');}};this.queue=new ChatSendQueue(this.id,c);this._buildUI();this.loadData();this.timeBuilt=new Date();this._handleStatusChange(true);this._textareaListener=null;this.isWindowFocused=true;this.resetAutoCloseTimeout(true);this._handlers.push(Event.listen(window,'blur',this._onWindowBlur.bind(this)),Event.listen(window,'focus',this._onWindowFocus.bind(this)));this._subscriptions.push(Arbiter.subscribe(['chat/visibility-changed','buddylist/availability-changed'],this._handleStatusChange.shield(this,false)));this._enableJSLoggerDump();if(this.chatDisplay.chatConfig.get('blackbird'))this.chatDisplay.presencePrivacy.subscribe(['privacy-changed','privacy-availability-changed'],this._handleStatusChange.shield(this,false));var g=new NubController();g.init(this.tabHandle);g.subscribe('show',this.handleShow.bind(this));g.subscribe('hide',this.handleHide.bind(this));g.subscribe('resize',this.scrollToBottom.bind(this));g.subscribe(['show','hide'],g.buttonContentChanged.shield(g));this._subscriptions.push(Arbiter.subscribe('overflow-applied-to-body',this.scrollToBottom.bind(this)));this._messagingToken=MessagingEvents.subscribe('read',function(j,k){if(k.chat_ids&&k.chat_ids.contains(this.id)){this._clearMessagingMarkAsRead();if(k.mark_as_read)this._markRead();this.chatDisplay.doStopBlinking();}}.bind(this));Sound.init(['audio/ogg','audio/mpeg']);this._sidebarInitialized=false;Arbiter.subscribe('sidebar/initialized',function(){this._sidebarInitialized=true;}.bind(this));}Class.mixin(ChatTab,'Arbiter',{currentMsgGroup:null,rendererName:'chat-tab',pendingToLogCompareWindow:60000,resendDelay:5000,handleWidth:150,popinWidth:258,popinHeight:250,minTextHeightPopin:13,maxTextHeight:77,msgBunchTime:300000,maxHandleLen:16,maxTitleLen:20,bounceDuration:50,_ACTION_LOG_SUBSCRIBE:1,_ACTION_LOG_UNSUBSCRIBE:2,handleShow:function(){if(this.chatDisplay.focused!=this.id)this.chatDisplay.focusTab(this.id);},handleHide:function(){if(this.focused)this.chatDisplay.unfocus();},_getLogger:function(){return Chat.getLogger('chat_msg');},_getBlackbirdLogger:function(){return Chat.getLogger('blackbird');},_enableJSLoggerDump:function(){this._subscriptions.push(Arbiter.subscribe(JSLogger.DUMP_EVENT,function(f,a){var d=['id','name','inDock','numMissed','focused','lastLogItem','historyLoaded','failedSentMsgs','timeBuilt','isWindowFocused','allRecipients','focused'];var b={};var e=this;var c=a.other_uids||[];c.push(this.id);a.other_uids=c;d.forEach(function(g){b[g]=e[g];});b.selfAvailableListDebugInfo=this.chatDisplay.availableList.getDebugInfo(Env.user);b.otherAvailableListDebugInfo=this.chatDisplay.availableList.getDebugInfo(this.id);this.queue.onDump(f,a);a[this.id]={tab_info:b};}.bind(this)));},_onWindowFocus:function(event){this.isWindowFocused=true;if(this.focused)this._markRead();},_onWindowBlur:function(event){this.isWindowFocused=false;},isTabVisible:function(){return this.focused;},start:function(){},restart:function(){if(this.reloadHistoryOnRestart())if(this.focused){this.getHistory(true);}else this.historyLoaded=false;this.handleResize.bind(this).defer();},reloadHistoryOnRestart:function(){return true;},loadData:function(){if(this.chatDisplay.histories[this.id])this._setHistory(this.chatDisplay.histories[this.id]);if(!this.name)this._waitForInfo(this.id,function(a){this.updateName(a.name,a.firstName);}.bind(this));},_waitForInfo:function(b,a){require.ensure(['ShortProfiles'],function(c){c.get(b,a);}.bind(this));},_onHistoryInitialHandler:function(a,b){if(a!=this.historyRequestID)return false;return null;},_compareHistoryMessages:function(b,a){var c=Math.abs(b.time-a.time);if(c<this.pendingToLogCompareWindow&&b.text==a.msg.text)this._setMsgInfoMarkup(b.msgID,'');return false;},_onHistoryResponse:function(a,j){var b=j.getPayload();var k=b.userInfo;var h=b.history;this._getLogger().log('history_send_responded',{request_id:this.historyRequestID,from_restart:a});if(k){require.ensure(['ShortProfiles'],function(l){l.set(this.id,k);}.bind(this));this.updateName(k.name,k.firstName);}if(!h)return;if(h.length>0){var c;for(c=h.length-1;c>=0;c--){var g=h[c];if(g.to!=this.chatDisplay.user)this.queue.forEach(function(m,l){this._compareHistoryMessages(l,g);}.bind(this));}var e=h[h.length-1].time;this.queue.forEach(function(m,l){if(l.time<e)l.time=(++e);});}var i=this.chatDisplay.histories[this.id];if(i)if(h.length>0){var d=h[h.length-1];var f=d.time;for(var c=0;c<i.length;c++){var g=i[c];if(g.time>f)h.push(g);}}else h=i;this._setHistory(h);this.chatDisplay.histories[this.id]=h;},getHistory:function(a){var b=++(this.historyRequestID);this._getLogger().log('history_sent',{request_id:b,from_restart:a});new AsyncRequest().setInitialHandler(this._onHistoryInitialHandler.bind(this,b)).setHandler(this._onHistoryResponse.bind(this,a)).setErrorHandler(bagofholding).setMethod('GET').setReadOnly(true).setOption('suppressErrorAlerts',true).setData({type:this.getPostType(),id:this.id}).setURI('/ajax/chat/history.php').setAllowCrossPageTransition(true).send();},getPostType:function(){return 'friend';},_setHistory:function(d){this.lastLogItem=null;DOM.empty(this.chatConvContent);var f=0;var i=[];Array.prototype.push.apply(i,this.failedSentMsgs);this.queue.forEach(function(k,j){i.push(j);});var e=0;for(var a=0;a<d.length;a++){var b=d[a];var c=this.getMessageTypeInfo(b.type);if(c.unknown)continue;for(;f<i.length;f++){var g=i[f];var h=this.getMessageTypeInfo(g.type);if(g.time>e&&g.time<=b.time){if(h.visible)this.renderMsg(Env.user,this.id,g.time,g,g.msgID,g.isError,g.infoMarkup);}else break;}if(c.msg){this.renderMsg(b.from,b.to,b.time,b.msg,b.msgId);}else if(c.logMessage){this._renderLogMessage(b);}else if(c.actionLog)this._renderActionLogMessage(b.actor,b.new_recipients,b.action,b.time);this.lastLogItem=b;e=b.time;}for(;f<i.length;f++){var g=i[f];if(this.getMessageTypeInfo(g.type).visible){this.renderMsg(Env.user,this.id,g.time,g,g.msgID,g.isError,g.infoMarkup);this.lastLogItem={type:g.type,from:Env.user,to:this.id,time:g.time,msg:g};}}this.scrollToBottom();this.historyLoaded=true;},addRecipients:function(b){for(var a=0;a<b.length;a++)this.allRecipients.push(b[a]);return this;},setRecipients:function(a){this.allRecipients=a;return this;},getRecipients:function(){return this.allRecipients;},newActionLogMsg:function(c){var d=c.time||ServerTime.get();var b={type:'actionlog',action:c.actionType,time:c.timestampMsec,actor:c.actorInfo,new_recipients:c.newRecipientsInfo};var a=this.isUserScrolled();this._renderActionLogMessage(c.actorInfo,c.newRecipientsInfo,c.actionType,c.timestampMsec);!a&&this.scrollToBottom();this.lastLogItem=b;this.chatDisplay.addToHistory(this.id,b);},_renderActionLogMessage:function(b,e,i,g){var a=this.chatDisplay.templates['chat-msg-event'].render();var c=XHPTemplate.getNode(a,'icon');var d=XHPTemplate.getNode(a,'message');var h=XHPTemplate.getNode(a,'timestamp');var f=this.chatDisplay.renderServerTime(g);DOM.setContent(h,f);this._checkDateBreak(g);switch(i){case this._ACTION_LOG_SUBSCRIBE:if(!e||e.length===0)return;CSS.addClass(c,'addActionIcon');DOM.setContent(d,this._getSubscribeMessage(this.chatDisplay.user,b,e));break;case this._ACTION_LOG_UNSUBSCRIBE:CSS.addClass(c,'leaveActionIcon');DOM.setContent(d,this._getUnsubscribeMessage(this.chatDisplay.user,b));break;default:return;}DOM.appendContent(this.chatConvContent,a);this.currentMsgGroup=null;},_getSubscribeMessage:function(c,a,b){var d=this._indexOfUser(c,b);if(a.fbid&&a.fbid==c){switch(b.length){case 1:return DOM._tx("You added {subscriber1}.",{subscriber1:this._getLinkifiedName(c,b[0])});case 2:return DOM._tx("You added {subscriber1} and {subscriber2}.",{subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1])});case 3:return DOM._tx("You added {subscriber1}, {subscriber2} and {subscriber3}.",{subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1]),subscriber3:this._getLinkifiedName(c,b[2])});default:return DOM._tx("You added {subscriber1}, {subscriber2} and {more_people}.",{subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1]),more_people:b.length-2});}}else if(d!=-1){b.splice(d,1);switch(b.length){case 0:return DOM._tx("{actor} added you.",{actor:this._getLinkifiedName(c,a)});case 1:return DOM._tx("{actor} added you and {subscriber2}.",{actor:this._getLinkifiedName(c,a),subscriber2:this._getLinkifiedName(c,b[0])});case 2:return DOM._tx("{actor} added you, {subscriber2} and {subscriber3}.",{actor:this._getLinkifiedName(c,a),subscriber2:this._getLinkifiedName(c,b[0]),subscriber3:this._getLinkifiedName(c,b[1])});default:return DOM._tx("{actor} added you, {subscriber2} and {more_people}.",{actor:this._getLinkifiedName(c,a),subscriber2:this._getLinkifiedName(c,b[0]),more_people:b.length-1});}}else switch(b.length){case 1:return DOM._tx("{actor} added {subscriber1}.",{actor:this._getLinkifiedName(c,a),subscriber1:this._getLinkifiedName(c,b[0])});case 2:return DOM._tx("{actor} added {subscriber1} and {subscriber2}.",{actor:this._getLinkifiedName(c,a),subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1])});case 3:return DOM._tx("{actor} added {subscriber1}, {subscriber2} and {subscriber3}.",{actor:this._getLinkifiedName(c,a),subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1]),subscriber3:this._getLinkifiedName(c,b[2])});default:return DOM._tx("{actor} added {subscriber1}, {subscriber2} and {more_people}.",{actor:this._getLinkifiedName(c,a),subscriber1:this._getLinkifiedName(c,b[0]),subscriber2:this._getLinkifiedName(c,b[1]),more_people:b.length-2});}},_indexOfUser:function(b,c){for(var a=0;a<c.length;a++)if(c[a].fbid&&c[a].fbid==b)return a;return -1;},_getUnsubscribeMessage:function(b,a){if(a.fbid&&a.fbid==b){return DOM._tx("You left the conversation.");}else return DOM._tx("{actor} left the conversation.",{actor:this._getLinkifiedName(b,a)});},_getLinkifiedName:function(b,a){if(!a.fbid){return document.createTextNode(a.name);}else return this._renderLink(a.href,a.name);},_renderLink:function(a,b){return $N('a',{href:a},b);},clearHistory:function(){new AsyncRequest().setHandler(bagofholding).setErrorHandler(bagofholding).setData({clear_history_id:this.id}).setURI(this.chatDisplay.settingsURL).setAllowCrossPageTransition(true).send();this.failedSentMsgs=[];this.queue.discard();this._setHistory(this.chatDisplay.histories[this.id]=[]);},reportLinkAction:function(){Bootloader.loadComponents('dialog',(function(){var a=URI(this.chatDisplay.reportURL).addQueryData({id:this.id}).addQueryData({src:'top_report_link'});Dialog.bootstrap(a.toString(),null,false);}).bind(this));},_onSendServerDialogCancel:function(a){this.queue.onSend(a,'transport_error');},_showPayloadWarning:function(a,c){var b=c.getPayload();if(b&&b.warning){var d=this._renderMsgWarning(['title' in b.warning?$N('div',b.warning.title):'',b.warning.body]);this._setMsgInfoMarkup(a,d,'msg_warning');}},getTabMsgType:function(){return 'msg';},_onSendResponse:function(b,a,d){this.queue.onSend(b);this._showPayloadWarning(b,d);var c={type:this.getTabMsgType(),msg:a,from:Env.user,to:this.id,time:a.time};this.chatDisplay.addToHistory(this.id,c);},showVideoCallout:function(a){var c=DOM.scry(this.tabHandle,'.videoicon');var b={recipient_id:this.id,alt:!!a};if(c.length==1)new AsyncRequest().setData(b).setRelativeTo(c[0]).setURI('/ajax/chat/video/callout.php').setAllowCrossPageTransition(true).send();},showOrcaCallout:function(b){var c=DOM.scry(this.tabHandle,'.titlebar');if(c.length>0){var a={sender_id:b};new AsyncRequest().setData(a).setRelativeTo(c[0]).setURI('/ajax/chat/orca/callout.php').setAllowCrossPageTransition(true).send();}},_onSendTransportError:function(a,b){this.queue.onSend(a,'transport_error',b);},_handleSendErrors:function(e,h,d,b,g){var f=g?g.getPayload():null;var a=null;if(b){a="An error occurred.";if(g&&b!='transport_error')a=this.chatDisplay.presenceUtil.getErrorDescription(g);}if(b==1356002){chatOptions.setVisibility(false);}else if(b==1356008){a=f.error.title;ErrorDialog.show(f.error.title,f.error.body);}else if(b==1356026){(new Function(f.do_onload))();}else if(b==1356038){ErrorDialog.show(g.errorSummary,g.errorDescription);}else if(b){ErrorDialog.show(g.errorSummary,g.errorDescription);return;}if(a){var c=this._renderMsgError(a);this._setMsgInfoMarkup(d.msgID,c,'msg_error');}},_onSendError:function(a,b){this.queue.onSend(a,b.getError(),b);},_renderMsgWarning:function(b){var a=this.chatDisplay.templates['chat-msg-warning'].render();DOM.setContent(XHPTemplate.getNode(a,'message'),b);return a;},_renderMsgError:function(a){var b=this.chatDisplay.templates['chat-msg-error'].render();DOM.setContent(XHPTemplate.getNode(b,'message'),a);return b;},_createMessage:function(e,c){var b=(new Date()).getTime()+':'+(rand32()+1);var f=ServerTime.get();var a=Date.now();if(this.lastLogItem&&f<this.lastLogItem.time)f=this.lastLogItem.time+1;var d={text:e,msgID:b,type:c,created:a,time:f,asyncSuccess:false,isError:false,errorMarkup:''};return d;},_updateChatActivity:function(b,a){this.lastLogItem={type:b.type,from:Env.user,to:this.id,time:b.time,msg:a};},sendInput:function(){var d=this.chatInput.value;if(/^\s*$/.test(d||''))return;this.chatInput.value='';var c=this._createMessage(d,'msg');this.queue.sendToServer(c.msgID,c);var b={text:d};var a=this.isUserScrolled();this.renderMsg(Env.user,this.id,c.time,b,c.msgID);!a&&this.scrollToBottom();this._updateChatActivity(c,b);this.typingIndicator&&this.typingIndicator.resetState();},_sendMessage:function(b){b.time=ServerTime.get();if(this.lastLogItem&&b.time<this.lastLogItem.time)b.time=this.lastLogItem.time+1;clearTimeout(this.resendTimeout);this.resendTimeout=null;var c=this.getSendData(b);Arbiter.inform('chat/message-sent',c);if(!Chat.isOnline())this._getLogger().log('send_offline_message');var a=b.msgID;var d=this.chatDisplay.chatConfig.get('chat_send1')?'/ajax/chat/send1.php':'/ajax/chat/send.php';new AsyncRequest().setServerDialogCancelHandler(this._onSendServerDialogCancel.bind(this,a)).setHandler(this._onSendResponse.bind(this,a,b)).setErrorHandler(this._onSendError.bind(this,a)).setTransportErrorHandler(this._onSendTransportError.bind(this,a)).setMethod('POST').setData(c).setURI(d).setAllowCrossPageTransition(true).send();this.pendingNewRecipients=[];},getSendData:function(e){var c=this.chatDisplay.histories[this.id];var d=null;var a=this.getAvailability();var h=a!=AvailableListConstants.ACTIVE;var g=a==AvailableListConstants.IDLE;var f={msg_id:e.msgID,client_time:e.time,to:this.id,num_tabs:this.chatDisplay.numTabs,pvs_time:d,msg_text:e.text,to_offline:h,to_idle:g,window_id:this.chatDisplay.presenceUtil.getSessionID()};if(h){var b=this.chatDisplay.availableList.getDebugInfo(this.id);f.overlaySource=b.overlaySource;f.overlayTime=b.overlayTime;f.presence=b.presence;f.presenceTime=ServerTime.get();f.clock=(new Date()).getTime();}if(this._sidebarInitialized){f.sidebar_launched=true;f.sidebar_enabled=ChatSidebar.isEnabled();f.sidebar_capable=ChatSidebar.isViewportCapable();f.sidebar_should_show=ChatSidebar.shouldShowSidebar();f.sidebar_visible=ChatSidebar.isVisible();}return f;},_setMsgInfoMarkup:function(d,c,a){var b=ge('msg_'+this.id+'_'+d);if(!b)return;DOM.insertAfter(b,c);a&&CSS.addClass(b,a);this.scrollToBottom();},tabHitAreaOnClick:function(){if(this.suppressHeaderCollapse)return;this.chatDisplay.toggleTab(this.id,true,this.name,this.firstName);this.chatDisplay.doStopBlinking();},tabXOnClick:function(a){this.chatDisplay.closeTab(this.id);this.chatDisplay.doStopBlinking();$E(a).kill();return false;},headerLinkMouseOver:function(){CSS.addClass(this.chatHeader,'suppress_hover');this.suppressHeaderCollapse=true;},headerLinkMouseOut:function(){CSS.removeClass(this.chatHeader,'suppress_hover');this.suppressHeaderCollapse=false;},chatConvOnMouseDown:function(event){if(event.button!=0)return;this.chatDisplay.doStopBlinking();},chatConvOnMouseUp:function(){if(DOM.getSelection()=='')this.focusChatInput(true);},focusChatInput:function(a){if(this.isTabVisible())if(a||this.canStealFocus())this.chatInput.focus();},canStealFocus:function(){if(undefined!=document.activeElement){var a=document.activeElement;if(a){var b='INPUT'==a.nodeName||'TEXTAREA'==a.nodeName||('DIV'==a.nodeName&&a.contentEditable=="true");return !b;}}return false;},displayPrivacyLinkInGearMenu:function(){var a=this._getBlackbirdLogger();var b=XHPTemplate.getNode(this.tabHandle,'privacyLink');var c;if(this.viewerIsOnline()){if(!this.isBlocked()){this._waitForInfo(this.id,function(d){c=_tx("Go Offline to {name}",{name:d.firstName});DOM.setContent(b,c);});}else{this._waitForInfo(this.id,function(d){c=_tx("Go Online to {name}",{name:d.firstName});DOM.setContent(b,c);});a.log('open_tab_with_blocked_friend',{tab_id:this.id});}}else{c="Go online";DOM.setContent(b,c);a.log('open_tab_offline',{tab_id:this.id});}},togglePrivacy:function(){if(!this.chatDisplay.chatConfig.get('blackbird'))return;var b=this._getBlackbirdLogger();var a='go_online';if(this.viewerIsOnline())a=this.isBlocked()?'unblock':'block';switch(a){case 'go_online':if(!this.chatDisplay.chatVisibility){b.error('tabs_visibility_undefined');break;}if(this.chatDisplay.chatVisibility.isOnline()){b.error('tabs_already_online');break;}this.chatDisplay.chatVisibility.goOnline();b.log('tabs_go_online',{tab_id:this.id});if(!this.isBlocked()){this.closeSheet();break;}case 'unblock':this.chatDisplay.presencePrivacy.allow(this.id);this.closeSheet();b.log('tabs_unblock',{tab_id:this.id});break;case 'block':this.chatDisplay.presencePrivacy.disallow(this.id);b.log('tabs_block',{tab_id:this.id});break;}this.displayPrivacyLinkInGearMenu();},showAddFriendFromActionMenu:function(){this.showAddFriend();return true;},showAddFriend:function(){if(this._sheetOpen&&DOM.scry(this._sheetEl,'.addFriends').length)return;var a={canonical:this.isCanonical(),id:this.id};if(this.isCanonical()){a.recipient_id=this.id;}else{a.thread_id=this.id;a.recipients=this.getRecipients();}new AsyncRequest().setURI('/ajax/chat/show_add_friends.php').setData(a).setHandler(bagofholding).setErrorHandler(bagofholding).setAllowCrossPageTransition(true).send();},_buildUI:function(){var l=this.chatDisplay.templates[this.rendererName].render();this.nubNameNode=XHPTemplate.getNode(l,'name');this.titlebarTextNode=XHPTemplate.getNode(l,'titlebarText');this._sheetEl=XHPTemplate.getNode(l,'sheet');var b=XHPTemplate.getNode(l,'chatConv');var f=XHPTemplate.getNode(l,'closeButton');var c=XHPTemplate.getNode(l,'input');this._handlers.push(Event.listen(b,'mousedown',this.chatConvOnMouseDown.bind(this)),Event.listen(b,'mouseup',this.chatConvOnMouseUp.bind(this)),Event.listen(f,'click',this.tabXOnClick.bind(this)),Event.listen(c,'keydown',this.inputKeyDown.bind(this)),Event.listen(c,'click',this.chatDisplay.doStopBlinking.bind(this.chatDisplay)));var i=XHPTemplate.getNode(l,'maximizeButton');if(i)this._handlers.push(Event.listen(i,'click',this.maximizeOnClick.bind(this)));ChatQuietLinks.silence(l);this.tabHandle=l;this.statusEl=XHPTemplate.getNode(l,'status');this.tabCount=XHPTemplate.getNode(l,'numMessages');this.chatWrapper=XHPTemplate.getNode(l,'chatWrapper');this.chatConv=b;this.chatConvContent=XHPTemplate.getNode(l,'conversation');this.chatInput=c;var d=ge('fbDockChatTabs');DOM.prependContent(d,this.tabHandle);if(this.chatDisplay.chatConfig.get('typing_notifications')){this.typingIndicator=new TypingIndicator(this.id,c,'chat');var n=XHPTemplate.getNode(l,'typingIndicator');if(n){var j;this._waitForInfo(this.id,function(o){j=_tx("{name} is typing...",{name:o.firstName});DOM.setContent(n,j);});}}this._updateName();this._updateNumMissedDisplay();this.videoCallLink=XHPTemplate.getNode(l,'videoCallLink');if(this.videoCallLink){this._handlers.push(Event.listen(this.videoCallLink,'click',function(){var o=this.getAvailability();if(this._isVideoCallAvail(o)){VideoEvents.inform(VideoEvents.START_CALL_UI,{idTarget:this.id});this.focused&&this.chatDisplay.unfocus();}return false;}.bind(this)));this._callIncomingToken=VideoEvents.subscribe(VideoEvents.CALL_INCOMING,function(o,p){if(p.idTarget==this.id&&this.focused&&/^\s*$/.test(this.chatInput.value||''))this.chatDisplay.unfocus();}.bind(this));}var h=XHPTemplate.getNode(l,'dropdown');if(h){Toggler.createInstance(h).setSticky(false);var g=XHPTemplate.getNode(l,'conversationLink');if(g)if(this.isCanonical()){g.href=Messaging.getUserThreadURI(this.id);}else g.href=Messaging.getInboxThreadURI(this.id);var k=XHPTemplate.getNode(l,'reportSpamLink');if(k)this._handlers.push(Event.listen(k,'click',this.reportLinkAction.bind(this)));var e=XHPTemplate.getNode(l,'clearWindowLink');if(e)this._handlers.push(Event.listen(e,'click',this.clearHistory.bind(this)));var a=XHPTemplate.getNode(l,'addFriendLink');if(a)this._handlers.push(Event.listen(a,'click',this.showAddFriendFromActionMenu.bind(this)));if(this.chatDisplay.chatConfig.get('blackbird'))this.chatDisplay.presencePrivacy.subscribe('initialized',function(){var o=XHPTemplate.getNode(l,'privacyLink');if(o)this._handlers.push(Event.listen(o,'click',function(){this._getBlackbirdLogger().log('gear_menu_toggle_privacy',{tab_id:this.id});this.togglePrivacy();}.bind(this)));}.bind(this));}var m=XHPTemplate.getNode(l,'titlebarCloseButton');this._handlers.push(Event.listen(m,'click',this.tabXOnClick.bind(this)));return l;},isCanonical:function(){return true;},_updateName:function(){var a=this.nubNameNode.cloneNode(true);DOM.setContent(a,this.name);DOM.replace(this.nubNameNode,a);this.nubNameNode=a;DOM.setContent(this.titlebarTextNode,this.name);this.chatInput.setAttribute('title',_tx("Message to {name}",{name:DOM.getText(this.titlebarTextNode)}));},_guessFirstName:function(){if(typeof(this.name)=="string")return this.chatDisplay.getFirstName(this.name);return this.name;},maximizeOnClick:function(){var a=this.getConversationURI();if(a){goURI(a);this.focused&&this.chatDisplay.unfocus();}return false;},getConversationURI:function(){return Messaging.getUserThreadURI(this.id);},getProfileURI:function(){return URI(Env.www_base).setPath('/profile.php').setQueryData({id:this.id});},show:function(){CSS.show(this.tabHandle);},hide:function(){CSS.hide(this.tabHandle);},inputKeyDown:function(event){this.chatDisplay.doStopBlinking();if(!this._textareaListener){var c=DataStore.get(this.chatInput,'DOMControl');this._textareaListener=c.subscribe('resize',this.handleResize.bind(this));}var a;switch(event.keyCode){case KEYS.RETURN:if(!event.shiftKey){this.sendInput();event.kill();return;}break;case KEYS.ESC:a=this.chatDisplay.getNextTabId(this.id,true)||this.chatDisplay.getNextTabId(this.id,false);this.chatDisplay.closeTab(this.id);if(a)this.chatDisplay.focusTab(a,true);return event.kill();case KEYS.TAB:var b=event.shiftKey;a=this.chatDisplay.getNextTabId(this.id,!b);if(a){this.chatDisplay.focusTab(a,true);return event.kill();}break;}},updateName:function(b,a){this.name=b;this.firstName=a||this._guessFirstName();this._updateName();},trimName:function(a){var b=this.name;if(b.length>a)b=b.substring(0,a-2)+'...';return b;},viewerIsOnline:function(){if(this.chatDisplay.chatVisibility)return this.chatDisplay.chatVisibility.isOnline();},_handleStatusChange:function(a){Arbiter.subscribe('chat-visibility/initialized',this._handleStatusChangeAfterVisInit.bind(this,a));},_handleStatusChangeAfterVisInit:function(f){var e=this.viewerIsOnline();var i=(this._visibility!==e);var a=e?this.getAvailability():AvailableListConstants.OFFLINE;var b=(this._availability!==a);var c=this.isBlocked();var d=(this._blocked!=c);if(!b&&!d&&!i)return;if(d)this.displayPrivacyLinkInGearMenu();var g=!f||chatDisplay.loadedInitialTabs;if(this._blocked&&!c)g=false;this._availability=a;this._blocked=c;this._visibility=e;var h;this._waitForInfo(this.id,function(t){var o=false;var n=this.chatDisplay.templates['chat-sheet-notice'].render();var q=XHPTemplate.getNode(n,'text');var p=XHPTemplate.getNode(n,'image');var j=null;var r='offline';if(e){if(a===AvailableListConstants.ACTIVE){var s=(new Date()).getTime()-this.timeBuilt.getTime();var m=this.chatDisplay.chatConfig.get('available_sheet_min_tab_age_ms');if(!f&&s>m){h=this.chatDisplay.chatConfig.get('blackbird')?DOM._tx("{name} is now online.",{name:t.firstName}):DOM._tx("{name} is now available.",{name:t.firstName});}else if(t.showVideoSheet)if(VideoChatPlugin.isSupported()){h=this._getVideoCallSheet(t);this._sheetLinkHandler=Event.listen(q,'click',this._callUserOnClick.bind(this));r='video';CSS.addClass(p,'sheet_img_video');j=10000;new AsyncRequest().setURI('/ajax/chat/video/log_promo.php').setData({viewedUserID:this.id}).setAllowCrossPageTransition(true).setErrorHandler(bagofholding).send();}}else if(a===AvailableListConstants.OFFLINE||a==AvailableListConstants.MOBILE)if(this.chatDisplay.chatConfig.get('titan')){r='offline';if(c){r='blocked';o=true;}else if(a==AvailableListConstants.MOBILE)r='mobile';switch(t.gender){case GenderConst.FEMALE_SINGULAR:case GenderConst.FEMALE_SINGULAR_GUESS:switch(r){case 'offline':h=this.chatDisplay.chatConfig.get('blackbird')?DOM._tx("{name} is offline, but you can still send her a message.",{name:t.firstName}):DOM._tx("{name} is unavailable, but you can still send her a message.",{name:t.firstName});break;case 'mobile':h=DOM._tx("Your messages will be sent to {name}'s phone.",{name:t.firstName});break;case 'blocked':h=DOM._tx("{name} sees you as offline on chat, but you can still send her a message. ",{name:t.firstName});break;}break;case GenderConst.MALE_SINGULAR:case GenderConst.MALE_SINGULAR_GUESS:switch(r){case 'offline':h=this.chatDisplay.chatConfig.get('blackbird')?DOM._tx("{name} is offline, but you can still send him a message.",{name:t.firstName}):DOM._tx("{name} is unavailable, but you can still send him a message.",{name:t.firstName});break;case 'mobile':h=DOM._tx("Your messages will be sent to {name}'s phone.",{name:t.firstName});break;case 'blocked':h=DOM._tx("{name} sees you as offline on chat, but you can still send him a message. ",{name:t.firstName});break;}break;default:switch(r){case 'offline':h=this.chatDisplay.chatConfig.get('blackbird')?DOM._tx("{name} is offline, but you can still send them a message.",{name:t.firstName}):DOM._tx("{name} is unavailable, but you can still send them a message.",{name:t.firstName});break;case 'mobile':h=DOM._tx("Your messages will be sent to {name}'s phone.",{name:t.firstName});break;case 'blocked':h=DOM._tx("{name} sees you as offline on chat, but you can still send them a message. ",{name:t.firstName});break;}break;}if(r=='mobile'&&this.chatDisplay.chatConfig.get('orca_landing_page')){h=DOM._tx("{name} is on Facebook Messenger",{name:t.firstName});j=this.chatDisplay.chatConfig.get('orca_chat_sheet_timeout');}}else h=DOM._tx("{name} is offline.",{name:t.firstName});}else if(this.chatDisplay.chatConfig.get('blackbird')){var k='fbChatGoOnlineLink';var l=$N('a',{href:'#',className:k},DOM._tx("go online"));h=DOM._tx("You are now offline. To chat with {name} and other friends, {link}.",{name:t.firstName,link:l});Event.listen(q,'click',function(event){if(CSS.hasClass(event.getTarget(),k)){var u=this._getBlackbirdLogger();if(this.chatDisplay.chatVisibility.isOnline())u.error('tab_sheet_already_online');this.togglePrivacy();u.log('tab_sheet_go_online',{tab_id:this.id});return false;}}.bind(this));o=true;}CSS.removeClass(p,'sheet_img_msgr');if(g&&h){DOM.setContent(q,h);if(e&&c)this._appendGoOnlineLink(n,t.firstName);if(r=='mobile'&&this.chatDisplay.chatConfig.get('orca_landing_page')){if(!this.chatDisplay.chatConfig.get('has_messenger'))this._appendOrcaDownloadLink(n);CSS.addClass(p,'sheet_img_msgr');}if(f){this.setSheet(n,o,j);}else this.closeSheet(this.openSheet.bind(this,n,o,j));}else this.closeSheet();}.bind(this));if(e&&a!=AvailableListConstants.ACTIVE)CSS.removeClass(this.tabHandle,'typing');if(e&&a&&!c){this._enableTab(a);}else this._disableTab();this._updateVideoCallLink(a);},_getVideoCallSheet:function(c){var b=$N('a',{href:'#',className:'fbVideoCallLink'},DOM._tx("Call {name}",{name:c.firstName}));var a=$N('a',{href:'/videocalling',target:'_blank'},DOM._tx("learn more about video calling"));if(VideoChatPlugin.isInstalled()){text=DOM._tx("{name} has set up video calling. {callFriendLink}",{name:c.firstName,callFriendLink:b});}else text=DOM._tx("{name} has set up video calling. {callFriendLink} or {learnMoreLink}.",{name:c.firstName,callFriendLink:b,learnMoreLink:a});return text;},_callUserOnClick:function(event){if(CSS.hasClass(event.getTarget(),'fbVideoCallLink')){if(this._isVideoCallAvail(this.getAvailability())){VideoEvents.inform(VideoEvents.START_CALL_UI,{idTarget:this.id});this.focused&&this.chatDisplay.unfocus();}return false;}},_appendOrcaDownloadLink:function(c){var a=this.chatDisplay.chatConfig.get('orca_landing_page');var d=XHPTemplate.getNode(c,'text');var b=$N('a',{href:a,target:'_blank'},"Facebook Messenger");d.textContent=d.textContent.replace("Facebook Messenger",'');DOM.appendContent(d,b);},_appendGoOnlineLink:function(b,a){var d=$N('a',{href:'#',classname:'unlistLink'},_tx("Go Online to {name}",{name:a}));Event.listen(d,'click',(function(){this.togglePrivacy();this._getBlackbirdLogger().log('tab_sheet_go_online_to',{tab_id:this.id});return false;}).bind(this));var c=XHPTemplate.getNode(b,'text');DOM.appendContent(c,$N('br'));DOM.appendContent(c,d);},_isVideoCallAvail:function(a){return a==AvailableListConstants.ACTIVE||a==AvailableListConstants.IDLE;},_updateVideoCallLink:function(a){if(this.videoCallLink)if(this.viewerIsOnline()){if(this._isVideoCallAvail(a)){Tooltip.set(this.videoCallLink,_tx("Start a video call with {firstname}",{firstname:this.firstName}));}else{Tooltip.set(this.videoCallLink,_tx("{firstname} is currently unavailable for video calling",{firstname:this.firstName}));this._hideVideoCallouts();}}else Tooltip.set(this.videoCallLink,"You must be online to make a call.");},_enableTab:function(a){this.tabDisabled=false;var c=a==AvailableListConstants.IDLE;var d=a==AvailableListConstants.MOBILE;var b=a==AvailableListConstants.ACTIVE;CSS.removeClass(this.tabHandle,'disabled');CSS.removeClass(this.tabHandle,'blocked');CSS.removeClass(this.tabHandle,'chatOffline');CSS.conditionClass(this.tabHandle,'idle',c);CSS.conditionClass(this.tabHandle,'mobile',d);CSS.conditionClass(this.tabHandle,'active',b);},_disableTab:function(){this.tabDisabled=true;CSS.addClass(this.tabHandle,'disabled');CSS.conditionClass(this.tabHandle,'blocked',this.isBlocked());CSS.conditionClass(this.tabHandle,'chatOffline',!this.viewerIsOnline());CSS.removeClass(this.tabHandle,'idle');CSS.removeClass(this.tabHandle,'active');CSS.removeClass(this.tabHandle,'mobile');this._hideCallouts();},_hideCallouts:function(){this._hideVideoCallouts();var c=DOM.scry(document,'div.multiChatCallout');for(var b=0;b<c.length;b++)DOM.remove(c[b]);var d=DOM.scry(document,'div.orcaCallout');for(var a=0;a<d.length;a++)DOM.remove(d[a]);},_hideVideoCallouts:function(){var b=DOM.scry(document,'div.videoChatCallout');for(var a=0;a<b.length;a++)DOM.remove(b[a]);},handleResize:function(){var a=this.isUserScrolled();Dock._resizeNubFlyout(this.tabHandle);!a&&this.scrollToBottom();},resizeSheet:function(){if(!this._sheetEl||!this.focused||!this._sheetOpen)return;var a=Vector2.getElementDimensions(this.chatConvContent);a.setElementWidth(this._sheetEl);},setSheet:function(b,d,a){if(!this._sheetEl)return;clearTimeout(this._sheetCloseTimeout);var c=5000;if(!a)a=c;DOM.setContent(this._sheetEl,b);CSS.setStyle(this._sheetEl,'bottom','0px');CSS.show(this._sheetEl);this._sheetOpen=true;this.resizeSheet();if(!d)this._sheetCloseTimeout=this.closeSheet.shield(this).defer(a,false);this._sheetKeepOpen=!!d;},_stopSheetAnimation:function(){this._sheetAnimation&&this._sheetAnimation.stop();this._sheetAnimation=null;CSS.removeClass(this.tabHandle,'sheetSlide');},openSheet:function(c,e,b,a){if(!this._sheetEl)return;if(this._sheetOpen){var f=$N('div',{className:'hidden_elem'},c);DOM.appendContent(this._sheetEl,f);if(this._sheetKeepOpen&&!e)return;this._stopSheetAnimation();c=$A(f.childNodes);this.closeSheet(this.openSheet.bind(this,c,e,b,a));return;}this.inform('sheet/open');if(!this.focused){this.setSheet(c,e,b);a&&a();this.closeSheet();return;}CSS.setStyle(this._sheetEl,'visibility','hidden');this.setSheet(c,e,b);var d=Vector2.getElementDimensions(this._sheetEl).y;CSS.addClass(this.tabHandle,'sheetSlide');CSS.setStyle(this._sheetEl,'bottom',d+'px');CSS.setStyle(this._sheetEl,'visibility','');this._sheetAnimation=animation(this._sheetEl).to('bottom',0).duration(150).ease(animation.ease.both).ondone(function(){CSS.removeClass(this.tabHandle,'sheetSlide');this._sheetAnimation=null;a&&a();}.bind(this)).go();},closeSheet:function(a){if(!this._sheetEl)return;clearTimeout(this._sheetCloseTimeout);if(!this._sheetOpen){a&&a();return;}if(this._sheetLinkHandler){this._sheetLinkHandler.remove();this._sheetLinkHandler=null;}this.inform('sheet/close');if(!this.focused){CSS.hide(this._sheetEl);a&&a();return;}this._stopSheetAnimation();CSS.addClass(this.tabHandle,'sheetSlide');this._sheetAnimation=animation(this._sheetEl).to('bottom',Vector2.getElementDimensions(this._sheetEl).y+'px').duration(100).ease(animation.ease.begin).ondone(function(){CSS.hide(this._sheetEl);CSS.removeClass(this.tabHandle,'sheetSlide');this._sheetAnimation=null;this._sheetOpen=this._sheetKeepOpen=false;a&&a();}.bind(this)).go();},isUserScrolled:function(){return (this.chatConv.scrollHeight>this.chatConv.scrollTop+this.chatConv.clientHeight);},scrollToBottom:function(){if(!this.focused)return;this.chatConv.scrollTop=this.chatConv.scrollHeight;this.resizeSheet();},unfocus:function(){if(!this.focused)return;this.focused=false;this.resetAutoCloseTimeout(true);Dock.hide(this.tabHandle);this._hideCallouts();Arbiter.inform('layer_hidden',{type:'ChatTab'});this.inform('unfocus');},focus:function(c,a,b){if(!this.focused){this.focused=true;this.clearAutoCloseTimeout();this._isFragileMode=false;this._markRead();Dock.show(this.tabHandle);if(!this.historyLoaded)this.getHistory(false);Arbiter.inform('layer_shown',{type:'ChatTab'});}if(!c)this._onFocusUIActions(b);this.inform('focus');},_onFocusUIActions:function(a){this.handleResize();this.scrollToBottom();this.focusChatInput(a);},_startBounce:function(){var a=-8;this.bounceAnimation=animation(this.tabCount).to('top',-16).duration(this.bounceDuration+40).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().to('top',-16).duration(this.bounceDuration+40).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().to('top',-12).duration(this.bounceDuration).checkpoint().to('top',-10).duration(this.bounceDuration).checkpoint().to('top',a).duration(this.bounceDuration).checkpoint().go();},_stopBounce:function(){if(this.bounceAnimation){this.bounceAnimation.stop();this.bounceAnimation=null;}},close:function(){Dock.unregisterNubController(this.tabHandle);while(this._handlers.length)this._handlers.pop().remove();this._subscriptions.each(Arbiter.unsubscribe);MessagingEvents.unsubscribe(this._messagingToken);this._callIncomingToken&&VideoEvents.unsubscribe(this._callIncomingToken);if(this._textareaListener){var a=DataStore.get(this.chatInput,'DOMControl');a.unsubscribe(this._textareaListener);delete this._textareaListener;this._textareaListener=null;}this.clearAutoCloseTimeout();this.tabHandle.parentNode.removeChild(this.tabHandle);this._hideCallouts();if(this.focused)Arbiter.inform('layer_hidden',{type:'ChatTab'});},newTyping:function(c){var a=c.from;var f=c.to;var g=c.st;var d=c.offline;var b=c.from_mobile;if(!this.chatDisplay.chatConfig.get('typing_notifications')||new Date()-this.lastMessageAt<this.typingIndicator.notifyDelay)return;this._jslog.log('typing',{from:a,typ:g});var e=g==TypingDetector.TYPING&&this.numMissed===0&&(!d||b);if(f!=this.id){CSS.conditionClass(this.tabHandle,'typing',e);if(!b)this.chatDisplay.availableList.set(this.id,AvailableListConstants.ACTIVE,'typing_notification');}},newMsg:function(e){var a=e.from;var j=e.to;var k=e.type;var c=e.msg;var i=c.time;var d=c.msgID;var f=(a==this.chatDisplay.user);var g;f=f&&e.window_id&&e.window_id==this.chatDisplay.presenceUtil.getSessionID();g=!f&&this.chatDisplay.addToHistory(this.id,e);if(this.autoCloseTimeoutID)this.resetAutoCloseTimeout(false);this.lastMessageAt=new Date();if(a!=this.chatDisplay.user){var h=this.chatDisplay.isSquelched()||this.chatDisplay.isSquelchedTab(this.id);this._isFragileMode=false;if(h){this._markRead(i);}else{if(this.focused){this._markRead(i);if(!this.isWindowFocused)this.playSound();}else this._markUnread(i);this._messagingMarkAsRead();}CSS.removeClass(this.tabHandle,'typing');}else if(f){this._markRead();this.queue.onReceive(d);}g=this.getMessageTypeInfo(k).visible&&g;if(g){var b=this.isUserScrolled();this.renderMsg(a,j,i,c,d);!b&&this.scrollToBottom();this.lastLogItem=e;}},getInputElem:function(){return this.chatInput;},_messagingMarkAsRead:function(){if(!this.chatDisplay.chatConfig.get('titan'))return;this._clearMessagingMarkAsRead();var a=chatOptions.getSetting('idle_cutoff');if(a&&UserActivity.isActive(a)){this._messagingMarkThreadAsRead(this.id);}else this._pendingMessagingMarkAsRead=UserActivity.subscribe(this._messagingMarkAsRead.bind(this));},_messagingMarkThreadAsRead:function(a){Messaging.markUserThreadAsRead(a);},_clearMessagingMarkAsRead:function(){if(this._pendingMessagingMarkAsRead){UserActivity.unsubscribe(this._pendingMessagingMarkAsRead);delete this._pendingMessagingMarkAsRead;}},_markRead:function(){this._updateNumMissed(0);this._stopBounce();},_markUnread:function(a){this._updateNumMissed(this.numMissed+1,a);this._startBounce();this.playSound();},squelch:function(){this._markRead();},_updateNumMissed:function(a,b){if(a==this.numMissed||(b&&b<=this.missedTime))return;if(a>99)a=99;this.numMissed=a;this.missedTime=b;this._updateNumMissedDisplay();},_updateNumMissedDisplay:function(){DOM.setContent(this.tabCount,this.numMissed);window.chatTabSlider&&chatTabSlider.updateMissedCount();CSS.conditionClass(this.tabHandle,'highlight',this.numMissed>0);CSS.conditionShow(this.tabCount,this.numMissed>0);},_checkDateBreak:function(d){var c=new Date();c.setTime(d);var b=new Date();if(this.lastLogItem)b.setTime(this.lastLogItem.time);var a=null;if(!this.lastLogItem||c.getDate()!==b.getDate()||c.getMonth()!==b.getMonth()){a=this.chatDisplay.templates['chat-msg-date-break'].render();DOM.setContent(a,renderDate(c,true));DOM.appendContent(this.chatConvContent,a);this.currentMsgGroup=null;}},_renderLogMessage:function(a){var c=this.chatDisplay.templates['chat-msg-event'].render();var d=XHPTemplate.getNode(c,'timestamp');var b=this.chatDisplay.renderServerTime(a.time);DOM.setContent(d,b);this._checkDateBreak(a.time);switch(a.log_type){case LogMessageType.VIDEO_CALL:this._renderVideoMsg(c,a.videoMsg,a.params);break;case LogMessageType.THREAD_NAME:this._renderThreadNameMsg(c,a);break;case LogMessageType.THREAD_IMAGE:this._renderThreadImageMsg(c,a);break;}},_renderVideoMsg:function(d,b,c){var a=(b=='installing'||b=='installed')?c.installer:this.id;this._waitForInfo(a,function(e){this._renderVideoMsgWithName(d,b,c,e.firstName);}.bind(this));},_renderVideoMsgWithName:function(h,f,g,b){var d=XHPTemplate.getNode(h,'icon');CSS.addClass(d,'videoCallIcon');var e=XHPTemplate.getNode(h,'message');var a=true;switch(f){case 'missed-call':Bootloader.loadComponents('VideoChatPlugin',function(){DOM.setContent(e,DOM._tx("You missed a call from {firstname}. ",{firstname:b}));if(VideoChatPlugin.isSupported()){var j=$N('a',{href:'#',className:'callBackLink'},DOM._tx("Call Back"));j.setAttribute('data-gt',JSON.stringify({videochat:'clicked_callback_link'}));Event.listen(j,'click',(function(){VideoEvents.inform(VideoEvents.START_CALL_UI,{idTarget:this.id});this.focused&&this.chatDisplay.unfocus();return false;}).bind(this));DOM.appendContent(e,j);}DOM.appendContent(this.chatConvContent,h);}.bind(this));a=false;break;case 'installing':DOM.setContent(e,DOM._tx("{firstname} is setting up video calling...",{firstname:b}));break;case 'installed':DOM.setContent(e,DOM._tx("{firstname} finished setting up video calling.",{firstname:b}));break;default:var c=f=='caller-history'||(f=='connected-call'&&g.to==Env.user);var i=c?DOM._tx("You called {firstname}.",{firstname:b}):DOM._tx("{firstname} called you.",{firstname:b});DOM.setContent(e,i);break;}a&&DOM.appendContent(this.chatConvContent,h);this.currentMsgGroup=null;},_renderThreadNameMsg:function(f,e){var b=XHPTemplate.getNode(f,'icon');CSS.addClass(b,'editNameIcon');var a=this._getLinkifiedName(this.chatDisplay.user,e.actor_info);var d=null;if(e.cleared){d=DOM._tx("{actor} removed the conversation name.",{actor:a});}else{var g=$N('b',{},e.thread_name);d=DOM._tx("{actor} named the conversation: {name}.",{actor:a,name:g});}var c=XHPTemplate.getNode(f,'message');DOM.setContent(c,d);DOM.appendContent(this.chatConvContent,f);},_renderThreadImageMsg:function(f,e){var b=XHPTemplate.getNode(f,'icon');CSS.addClass(b,'changePictureIcon');var a=this._getLinkifiedName(this.chatDisplay.user,e.actor_info);var d=null;if(e.cleared){d=DOM._tx("{actor} removed the conversation picture.",{actor:a});}else d=DOM._tx("{actor} changed the conversation picture.",{actor:a});var c=XHPTemplate.getNode(f,'message');DOM.setContent(c,d);DOM.appendContent(this.chatConvContent,f);},renderMsg:function(g,w,v,m,p,i,d){this._checkDateBreak(v);var k=this.chatDisplay.templates['chat-msg'].render();k.id='msg_'+this.id+'_'+p;CSS.addClass(k,is_rtl(m.text)?'direction_rtl':'direction_ltr');var h=m.text.substr(0,4)=='?OTR';var s=false;CSS.conditionClass(k,'cyphertext',h);if(h){DOM.setContent(k,"[encrypted message]");}else{var n=[];var o=m.text;var u;var q;var j;if(m.spoof){q=new RegExp('^\\s*<([^<>]+?)>\\s+');j=o.match(q);if(j){o=o.substr(j[0].length);d=this._renderMsgWarning(j[1]);}if(m.subject){j=m.subject.match(q);if(j){m.subject=m.subject.substr(j[0].length);d=this._renderMsgWarning(j[1]);}}}if(m.subject){var t=this.chatDisplay.templates['chat-msg-subject'].render();DOM.setContent(t,m.subject);DOM.appendContent(k,t);this.currentMsgGroup=null;}if(m.truncated||m.forward||m.attachment){q=new RegExp('(?:\\.{3}\\s+)?'+'(?:<([^<>]+?)>\\s+)?'+'(?:<([^<>]+?)>\\s+)?'+'(\\S+)\\s*$');j=o.match(q);if(j){o=o.substr(0,o.lastIndexOf(j[0]));var u=j[3];if(m.truncated){n.push('\u2026 ');var l=$N('a',{href:u,className:'more'},"See All");n.push(l);}if(m.forward){var f=this.chatDisplay.templates['chat-msg-forward'].render();f.href=u;var e=XHPTemplate.getNode(f,'label');DOM.setContent(e,j[1]);n.push($N('div',f));s=true;}if(m.attachment){var b=this.chatDisplay.templates['chat-msg-attachment'].render();b.href=u;var a=XHPTemplate.getNode(b,'label');DOM.setContent(a,j[2]||j[1]);n.push($N('div',b));s=true;}}}if(!s&&URLScraper.match(o))s=true;if(!this.chatDisplay.user||this.chatDisplay.user==g)s=false;n.unshift(this._formatMessageText(o));DOM.appendContent(k,n);}var c=this.getCurrentMsgGroup(g,w,v);if(s&&this.chatDisplay.chatConfig.get('report')){CSS.show(XHPTemplate.getNode(c,'reportLinkWithDot'));var r=URI(this.chatDisplay.reportURL).addQueryData({id:g}).addQueryData({src:'timestamp_report_link'});reportLink=XHPTemplate.getNode(c,'reportLink');reportLink.setAttribute('href',r);}this.addMessageToGroup(k,c);d&&this.addMessageToGroup(d,c);},_formatMessageText:function(a){return HTML(html_hyperlink(a||'',Emote.htmlEmote,null,true));},newVideoMsg:function(d,b){this.clearAutoCloseTimeout();var c=b.time||ServerTime.get();var a={type:'logmessage',log_type:LogMessageType.VIDEO_CALL,videoMsg:d,time:c,params:b};if(d==='missed-call')if(this.focused){this._markRead(c);this._messagingMarkAsRead();if(!this.isWindowFocused)this.playSound();}else this._markUnread(c);this.newLogMessage(a);},newLogMessage:function(b){var a=this.isUserScrolled();this._renderLogMessage(b);!a&&this.scrollToBottom();this.lastLogItem=b;this.chatDisplay.addToHistory(this.id,b);},playSound:function(){if(this.chatDisplay.chatConfig.get('sound_enabled')&&chatOptions.getSetting('sound'))Sound.play(['/sound/pling.ogg','/sound/pling.mp3'],true,false);},getMessageTypeInfo:function(a){if(a=='logmessage'){return {visible:true,user:false,preserveHistory:true,logMessage:true};}else if(a=='actionlog'){return {visible:true,user:false,preserveHistory:false,actionLog:true};}else return {visible:true,user:true,preserveHistory:false,msg:true};},addMessageToGroup:function(b,a){DOM.appendContent(XHPTemplate.getNode(a,'messages'),b);},getCurrentMsgGroup:function(a,h,f){if(!this.currentMsgGroup||!this.lastLogItem||this.lastLogItem.from!=a||(f-this.lastLogItem.time)>this.msgBunchTime){var c=this.chatDisplay.templates['chat-msg-group'].render();var d=XHPTemplate.getNode(c,'profileLink');var e=XHPTemplate.getNode(c,'profilePhoto');var b=a==this.chatDisplay.user;this._waitForInfo(a,function(j){e.src=j.thumbSrc;e.setAttribute('alt',j.name);if(j.exist){var i=Env.www_base;if(j.vanity){i+=j.vanity;}else i+='profile.php?id='+a;d.setAttribute('href',i);}Tooltip.set(d,b?"You":j.name,'left');});var g=this.chatDisplay.renderServerTime(f);DOM.setContent(XHPTemplate.getNode(c,'timestamp'),g);DOM.appendContent(this.chatConvContent,c);this.currentMsgGroup=c;}return this.currentMsgGroup;},getAvailability:function(){return this.chatDisplay.availableList.get(this.id);},isBlocked:function(){return this.chatDisplay.chatConfig.get('blackbird')&&!this.chatDisplay.presencePrivacy.allows(this.id);},getTabDOM:function(){return this.tabHandle;},_isFragileMode:false,setFragileMode:function(){this._isFragileMode=true;this._subscriptions.push(Arbiter.subscribe('page_transition',this._removeFragileTab.bind(this)));},isFragileMode:function(){return this._isFragileMode;},_removeFragileTab:function(){if(!this._isFragileMode)return;this.chatDisplay.closeTab(this.id);},resetAutoCloseTimeout:function(a){if(this.getPostType()=='group')return;if(this.autoCloseTimeoutID)clearTimeout(this.autoCloseTimeoutID);var b=this.chatDisplay.chatConfig.get('tab_auto_close_timeout_ms');var c=Math.floor(this.chatDisplay.chatConfig.get('tab_auto_close_timeout_variation_range_ms')*Math.random());this.autoCloseTimeoutID=setTimeout(this._autoCloseTab.shield(this),b+c,false);if(a)this.staleTime=(new Date()).getTime();},clearAutoCloseTimeout:function(){if(this.getPostType()=='group'||this.getPostType()=='livelisten')return;if(this.autoCloseTimeoutID){clearTimeout(this.autoCloseTimeoutID);delete this.autoCloseTimeoutID;}this.staleTime=null;},_autoCloseTab:function(){if(!this.staleTime)this.staleTime=(new Date()).getTime();if(!this.focused&&this.chatDisplay.isUserIdle()&&!this.chatDisplay.inNLatestActiveTabs(this.id,this.chatDisplay.chatConfig.get('tab_auto_close_min_tab_count'))){this._jslog.log('auto_close',{id:this.id});this.chatDisplay.closeTab(this.id);delete this.autoCloseTimeoutID;}else this.resetAutoCloseTimeout(false);}});function renderDate(a,e){if(e){var f=new Date();f.setHours(0);f.setMinutes(0);f.setSeconds(0);f.setMilliseconds(0);var b=24*60*60*1000;var c=f.getTime()-a.getTime();if(c<=0){return "Today";}else if(c<b)return "Yesterday";}var d='';switch(a.getMonth()){case 0:d="January";break;case 1:d="February";break;case 2:d="March";break;case 3:d="April";break;case 4:d="May";break;case 5:d="June";break;case 6:d="July";break;case 7:d="August";break;case 8:d="September";break;case 9:d="October";break;case 10:d="November";break;case 11:d="December";break;}return _tx("{month} {date}",{month:d,date:a.getDate()});}onloadRegister(function(){if(ua.firefox()){var a=function(){return CSS.getStyle(document.body,'overflowX')+' '+CSS.getStyle(document.body,'overflowY');};var b=a();document.body.addEventListener('DOMAttrModified',function(event){if(event.getTarget()===document.body&&(event.attrName==='class'||event.attrName==='style')){var c=a();if(c!==b){b=c;Arbiter.inform('overflow-applied-to-body');}}},false);}});
function ChatLiveListenTab(a,c,e,g,f,d){this._renderedSongs={};this._renderedPlayErrors={};this._renderedListenerUpdates={};this._session=null;this._sessionEnded=false;this._hasBeginSessionItem=false;this.parent.construct(this,a,c,e,e,f,d);var h=this.chatDisplay.tabs;for(var b in h)if(h[b].getPostType()=='livelisten'&&b!=c)this.chatDisplay.closeTab(b);}Class.extend(ChatLiveListenTab,'ChatGroupTab');ChatLiveListenTab.prototype={rendererName:'chat-livelisten-tab',jslogger:JSLogger.create('music_live_listen'),SHOW_FACEPILE_LISTENER_THRESHOLD:3,getPostType:function(){return 'livelisten';},getTabMsgType:function(){return 'livelisten_msg';},playSound:function(){require.ensure(['ChatConfig'],function(a){if(a.get('sound_enabled')&&chatOptions.getSetting('sound'))Sound.play(['/sound/pling.ogg','/sound/pling.mp3'],true,false);});},loadData:function(){this.parent.loadData();MusicEvents.subscribe([MusicConstants.LIVE_LISTEN_OP.NOW_LEADING,MusicConstants.LIVE_LISTEN_OP.NOW_LISTENING],this._handleNewSessionUpdate.bind(this));MusicEvents.subscribe([MusicConstants.LIVE_LISTEN_OP.END_SESSION],this._handleEndSession.bind(this));MusicEvents.subscribe([MusicConstants.LIVE_LISTEN_OP.SONG_PLAYING],this._handleSongUpdate.bind(this));MusicEvents.subscribe([MusicConstants.LIVE_LISTEN_OP.LISTENER_UPDATE],this._handleListenerUpdate.bind(this));MusicEvents.subscribe([MusicConstants.LIVE_LISTEN_OP.PLAY_ERROR],this._handlePlayErrorUpdate.bind(this));MusicEvents.subscribe([MusicConstants.LIVE_LISTEN_OP.SESSION_UPDATED],this._handleSessionUpdated.bind(this));},_handleSessionUpdated:function(c,b){if(b&&b.session_id==this.id){var a=(!this._session||this._session.current_count!=b.current_count);this._session=b;if(a&&this.focused)if(b.current_count<this.SHOW_FACEPILE_LISTENER_THRESHOLD){this._setUpdateFacepiles(false);}else this._setUpdateFacepiles(true);}},_setUpdateFacepiles:function(a){var b=(!this._session||this._session.current_count<this.SHOW_FACEPILE_LISTENER_THRESHOLD);if(b){CSS.hide(this.chatInfo);this.handleResize();this.parent._setUpdateFacepiles(false);return;}else{CSS.show(this.chatInfo);this.handleResize();}this.parent._setUpdateFacepiles(a);},_handleSongUpdate:function(d,a){var c=a.song?a.song:{};if(a.session&&(a.session.session_id==this.id)&&c.title&&c.artist&&c.artist_url&&c.published&&c.published>=a.session.creation_time){this.jslogger.log('song_play',{type:d,data:a});var b={to:a.session.session_id,from:a.session.leader,type:'logmessage',time:(c.published*1000),musicMsg:{title:c.title,url:c.url,artist:c.artist,artist_url:c.artist_url,music_type:'song'}};this.newLogMessage(b);}},_handleListenerUpdate:function(e,a){if(a.session&&(a.session.session_id==this.id)&&a.actor){this.jslogger.debug('listener_update',{type:e,data:a});var d=(a.actor.time*1000);var c={to:a.session.session_id,from:a.actor.id,type:'logmessage',time:d,musicMsg:{actor:a.actor,music_type:'listener_update'}};if(!(this._renderedListenerUpdates[d]&&this._renderedListenerUpdates[d]==a.actor.id))if(a.session.chat_name){this.updateName(HTML(a.session.chat_name));var b=DOM.find(this.getTabDOM(),'span.titlebarText');if(b)DOM.setContent(b,HTML(a.session.chat_name));if(a.actor.action===MusicLiveListen.LISTENER_ADD&&a.actor.id!=a.session.user_id)this.playSound();}this.newLogMessage(c);}},_handleNewSessionUpdate:function(d,b){if(b.session&&(b.session.session_id==this.id)&&b.actor&&b.actor.time){var c={to:b.session.session_id,from:b.actor.id,type:'logmessage',time:(b.actor.time*1000),musicMsg:{actor:b.actor,music_type:'begin_session'}};var a=((Date.now()/1000)<=b.session.creation_time+10);if(d===MusicConstants.LIVE_LISTEN_OP.NOW_LEADING&&!this._hasBeginSessionItem&&a)this.playSound();this.newLogMessage(c);}},_handlePlayErrorUpdate:function(c,a){if(a.session&&(a.session.session_id==this.id)&&a.title&&a.body&&a.song){this.jslogger.log('play_error',{type:c,data:a});var b={to:a.session.session_id,from:a.session.leader,type:'logmessage',time:(a.song.published*1000),musicMsg:{title:a.title,body:a.body,song:a.song,music_type:'play_error'}};this.newLogMessage(b);}},_setHistory:function(b){this._renderedSongs={};this._renderedPlayErrors={};this._renderedListenerUpdates={};this._hasBeginSessionItem=false;for(var a=0;a<b.length;a++)if(b[a].msg&&b[a].msg.music_type){b[a].type='logmessage';var c=b[a].msg;b[a].musicMsg=c;delete b[a].msg;}return this.parent._setHistory(b);},_renderLogMessage:function(a){if(presence.inPopoutWindow)return;var b=a.musicMsg;if(b&&b.music_type=='song'){this._renderSongItem(b.title,b.url,b.artist,b.artist_url,a.time);}else if(b&&b.music_type=='listener_update'){this._renderListenerUpdateItem(b.actor,a.time);}else if(b&&b.music_type=='begin_session'){this._renderBeginSessionItem(b.actor,a.time);}else if(b&&b.music_type=='play_error')this._renderPlayErrorItem(b.title,b.body,b.song.url,a.time);},_renderSongItem:function(g,i,a,c,f){if(this._renderedSongs[f]&&this._renderedSongs[f]==i)return;var d=MusicLiveListen.getInstance().getCurrentSession();var e=(d&&d.provider_name)?d.provider_name:'Spotify';this._renderedSongs[f]=i;var h=this._renderLink(i,g);h.target='_blank';var b=this._renderLink(c,a);this._renderLiveListenLogItem(DOM._tx("{title} by {artist} on {provider}",{title:h,artist:b,provider:e}),f,'songIcon');},_renderListenerUpdateItem:function(a,f){if(this._renderedListenerUpdates[f]&&this._renderedListenerUpdates[f]==a.id)return;var d=(a.action==MusicLiveListen.LISTENER_ADD);var c=null;var b=this._renderLink(a.url,a.name);var e=this._renderLink(a.leader_profile_url,a.leader_name);if(d){if(Env.user==a.id){c=DOM._tx("You are now listening to music with {name}.",{name:e});}else c=DOM._tx("{name} started listening.",{name:b});}else if(a.leader_id==a.id&&Env.user!=a.leader_id){c=DOM._tx("{name} left the conversation. You will no longer hear the songs they play.",{name:e});}else if(Env.user==a.id&&a.id!=a.leader_id){c=DOM._tx("You are no longer listening to music with {name}.",{name:e});}else if(Env.user!=a.id)c=DOM._tx("{name} stopped listening.",{name:b});if(c){this._renderedListenerUpdates[f]=a.id;this._renderLiveListenLogItem(c,f,(d?'addActionIcon':'leaveActionIcon'));}},_renderBeginSessionItem:function(a,c){if(this._hasBeginSessionItem)return;var b=null;if(a.id==Env.user){b=DOM._tx("You are now listening to music with {name}.",{name:this._renderLink(a.leader_profile_url,a.leader_name)});}else if(a.leader_id==Env.user)b=DOM._tx("{name} is listening to music with you.",{name:this._renderLink(a.url,a.name)});if(b){this._hasBeginSessionItem=true;this._renderLiveListenLogItem(b,c,'addActionIcon');}},_renderPlayErrorItem:function(e,a,c,d){if(this._renderedPlayErrors[d]&&this._renderedPlayErrors[d]==c)return;this._renderedPlayErrors[d]=c;var b=$N('span',{},[$N('strong',{},e),$N('br'),a]);this._renderLiveListenLogItem(b,d,'playErrorIcon');},_renderLiveListenLogItem:function(a,g,c){var f=this.chatDisplay.templates['chat-msg-event'].render();var h=XHPTemplate.getNode(f,'timestamp');var e=this.chatDisplay.renderServerTime(g);DOM.setContent(h,e);this._checkDateBreak(g);var b=XHPTemplate.getNode(f,'icon');CSS.addClass(b,c);var d=XHPTemplate.getNode(f,'message');DOM.appendContent(d,a);DOM.appendContent(this.chatConvContent,f);this.currentMsgGroup=null;},_sendFacepileRequest:function(){this._lastUpdateRequestTimeMS=(new Date()).getTime();new AsyncRequest().setData({id:this.id}).setURI('/ajax/livelisten/chat/update_facepiles.php').setHandler(this._renderFacepile.bind(this)).send();},getProfileURI:function(){return;},_handleEndSession:function(e,a){this.jslogger.debug('end_session',{type:e,data:a});var b=a&&a.session&&a.session.session_id;var c=b&&this._session&&this._session.session_id==a.session.session_id;if(!b||c){this._session=null;this._sessionEnded=true;CSS.hide(this.chatInfo);this._disableTab();this.chatDisplay.doStopBlinking();CSS.hide(this.getInputElem());this.handleResize();this._setUpdateFacepiles(false);var d=this.chatDisplay.templates['chat-msg-error'].render();CSS.addClass(d,'pas');DOM.setContent(XHPTemplate.getNode(d,'message'),DOM._tx("There is no longer anyone listening with you."));this.openSheet(d,true);}}};
function ChatDisplayInterim(e,c,a,d,b,g){this.histories={};this.user=Env.user;var i=Env.www_base;this.messageURL=i+'ajax/messaging/composer.php';this.settingsURL='/ajax/chat/settings.php';this.tabsURL='/ajax/chat/tabs.php';this.visibilityURL='/ajax/chat/visibility.php';this.reportURL='/ajax/chat/report.php';this.templates=g;this.doesPageOccludeTabs=null;this.jslog=JSLogger.create('display');Arbiter.subscribe('chat/set_does_page_occlude_tabs',function(j,k){this.setDoesPageOccludeTabs(k);}.bind(this));this.controllers=copy_properties({friend:'ChatTab',group:'ChatGroupTab',thread:'ChatThreadTab',livelisten:'ChatLiveListenTab'},b);this._shortTabTypes={friend:'f',group:'g',livelisten:'l',thread:'t'};this._tabTypes={};for(var f in this._shortTabTypes){var h=this._shortTabTypes[f];this._tabTypes[h]=f;}require.ensure(['AvailableList','ChannelManager','ChatConfig','ChatVisibility','PresencePrivacy','PresenceState','PresenceUtil','SystemEvents','ShortProfiles'],function(j,k,l,m,n,o,p,r,q){this.availableList=j;this.channelManager=k;this.chatConfig=l;this.chatVisibility=m;this.presencePrivacy=n;this.presenceState=o;this.presenceUtil=p;this.SystemEvents=r;this.shortProfiles=q;this.renderServerTime=l.get('24h_times')?this._renderServerTime24hr:this._renderServerTime12hr;this.jabberSquelchInterval=300000;this._squelchUntil=null;this._squelchedIds={};this._reportedLatencies=0;this._init();this.load.bind(this).defer();}.bind(this));}ChatDisplayInterim.prototype={maxNumTabs:20,_init:function(){this.loaded=false;this.tabs={};this.tabList=[];this.numTabs=0;this.lastFocused=null;this.newMsgNames=[];this.newMsgNamesIndex=0;this.blinkingTimer=null;this.uiChangeTime=0;this.presenceState.registerStateStorer(this._store.bind(this));this.presenceState.registerStateLoader(this._load.bind(this));var a=['chat.close','chat.focus','chat.unfocus','group_msg','livelisten_msg','thread_msg','msg','offline_msg','typ','video','chat_event','buddylist_overlay','start_multichat','show_multichat_callout','update_multichat_participants','livelisten_update'].map(PresenceMessage.getArbiterMessageType);Arbiter.subscribe(a,this._handlePresenceMessage.bind(this));Arbiter.subscribe(PresenceMessage.STARTED,this.start.bind(this));Arbiter.subscribe(PresenceMessage.RESTARTED,this.restart.bind(this));Arbiter.subscribe(PresenceMessage.WINDOW_RESIZED,this.handleResize.bind(this));Arbiter.subscribe(channel.ON_INVALID_HISTORY,this.handleInvalidHistory.bind(this));Arbiter.subscribe(channel.ON_CONNECT,function(c,b){(b<=1?this.start():this.restart());}.bind(this));Arbiter.subscribe(channel.ON_SHUTDOWN,this.shutdown.bind(this));Event.listen(window,'focus',this.onWindowFocus.bind(this));Event.listen(window,'blur',this.onWindowBlur.bind(this));Arbiter.subscribe('chat/visibility-changed',this._handleVisibilityChange.shield(this));this.SystemEvents.subscribe(this.SystemEvents.TIME_TRAVEL,function(c,b){if(this.focused&&b>0){this._getLogger().log('time_check_refresh');this.tabs[this.focused].getHistory();}}.bind(this));},_getLogger:function(){return Chat.getLogger('chat_display');},_handleVisibilityChange:function(){var a=Chat.isOnline();if(!a)this.closeAllTabs();},onWindowFocus:function(){this.isWindowFocused=true;this.doStopBlinking();},onWindowBlur:function(){this.isWindowFocused=false;},start:function(){for(var a in this.tabs)this.tabs[a].start();},shutdown:function(){this._stopBlinking();},restart:function(){for(var a in this.tabs)this.tabs[a].restart();},_setFocused:function(a){this._setFocusedCookieState(a);this.focused=a;},_setFocusedCookieState:function(a){this.focusedCookieState=a;},_loadTabs:function(e,d){if(this.doesPageOccludeTabs&&!this.focused){this._setFocusedCookieState(d);d=null;}var f={};e.each(function(h){f[h.i]=h;});for(var b in this.tabs)if(!f[b]&&!this.tabs[b].isFragileMode()&&b!=d)this._closeTab(b);for(var a=0,c=e.length;a<c;a++){var g=e[a];this._deserializeTab(g);}Arbiter.subscribe('chat-tab-slider/loaded',function(i,h){if(d!=this.focused){this._unfocus();if(d&&!this.isSquelchedTab(d))this._focusTab(d);}h.addTab();}.bind(this));this.loadedInitialTabs=true;},_deserializeTab:function(h){var b=h.i;if(this.tabs[b])return;if(this.isSquelchedTab(b)){this._getLogger().log('load_tabs_squelched',{tab_id:b});return;}var d,a,i;var f=this.shortProfiles.getNow(b);if(f){d=f.name;a=f.firstName;i=f.type;}else{d=h.n;a=h.fn;if(!h.y){this._getLogger().log('load_tab_no_type',{tab_id:b});h.y='friend';}i=h.y;}var e=h.m||0;var c=h.t||0;var g=this.createTab(i,b,d,a,e,c,'_deserializeTab');if(i=='thread')if(f)g.setHasThread(f.hasThread);},load:function(){if(this._initialized||!this.presenceState||!this.availableList)return;this._load(this.presenceState.getInitial());this.presenceState.doSync();this._initialized=true;Arbiter.inform('chat-display/loaded',this,Arbiter.BEHAVIOR_PERSISTENT);},loadTabFragile:function(b,d,a,e){if(Chat.isOnline()){if(!this.tabs[b]){var c={i:b,n:d,fn:a,y:e};this._deserializeTab(c);this.tabs[b].setFragileMode();this._getLogger().log('load_fragile',c);}}else this._getLogger().log('no_load_fragile_offline');},loadTab:function(b,d,a,e){if(Chat.isOnline()){if(!this.tabs[b]){var c={i:b,n:d,fn:a,y:e};this._deserializeTab(c);this._getLogger().log('load_tab',c);}}else this._getLogger().log('no_load_tab_offline');},_load:function(e){if(e){if(this.blinkingTimer&&e.sb)this._stopBlinking();this._squelchUntil=e.sq;var f=verifyNumber(e.uct)*1000;if(!this.loaded||f>this.uiChangeTime){this.uiChangeTime=f;var c=Date.now();this._getLogger().log('load_tabs',{tabs:e.t,focused:e.f,age:c-f});if(e.t){var d=(c-e.ut>60*60*1000);for(var a=0,b=e.t.length;a<b;a++){if(d)e.t[a].m=0;var g=e.t[a].y||'f';e.t[a].y=this._tabTypes[g];}this._loadTabs(e.t,e.f||null);}}}this.loaded=true;},_store:function(c){c.sb=(this.blinkingTimer==null)?1:0;var d=this.getSquelchUntil();if(d!==null)c.sq=d;c.t=[];c.f=null;c.uct=Math.floor(this.uiChangeTime*.001);for(var a=0,b=this.tabList.length;a<b;a++){var f=this.tabList[a];if(!f.isFragileMode()){var e={i:f.id};if(f.numMissed)e.m=f.numMissed;var g=this._shortTabTypes[f.getPostType()];if(g&&g!='f')e.y=g;c.t.push(e);}}if(this.focusedCookieState&&this.tabs[this.focusedCookieState]&&!this.tabs[this.focusedCookieState].isFragileMode())c.f=this.focusedCookieState;return c;},handleResize:function(){if(!this.focused)return;var a=this.tabs[this.focused];a.handleResize();},handleInvalidHistory:function(){var a=this.focused&&this.tabs[this.focused];if(a)a.getHistory(true);},_sendTabStateChange:function(a){a.window_id=this.presenceUtil.getSessionID();new AsyncRequest().setURI(this.tabsURL).setData(a).setHandler(this._onCheckTabStateChangeResponse.bind(this,a)).setErrorHandler(bagofholding).setAllowCrossPageTransition(true).send();},_sendDeferredTabStateChange:function(a){clearTimeout(this._deferredTabStateChange);this._deferredTabStateChange=this._sendTabStateChange.bind(this,a).defer();},_onCheckTabStateChangeResponse:function(b,d){var a=(b&&b.focus_chat)||null;var e=a&&this.availableList.get(a);var c=d.getPayload();if(c&&c.overlay){this.availableList.addLegacyOverlay(c.overlay);if(e&&!this.availableList.get(a))this.jslog.error('ol_on_to_off',{id:a});}},reloadTabs:function(){for(var a in this.tabs)this.tabs[a].loadData();},_closeTab:function(a){if(!this.tabs[a])return;var b=this.tabList.indexOf(this.tabs[a]);if(this.focused==a)this._setFocused(null);this.tabs[a].close();this.tabList.splice(b,1);delete this.tabs[a];this.numTabs--;Arbiter.inform('chat/conversation-closed',{id:a});window.chatTabSlider&&chatTabSlider.close();},uiChanged:function(){this.uiChangeTime=Date.now();this.doStopBlinking(true);},closeTab:function(a){this._closeTab(a);this._sendTabStateChange({close_chat:a});this.uiChanged();},closeAllTabs:function(){for(var a in this.tabs)this._closeTab(a);this.uiChanged();},_unfocus:function(b){var a=this.focused;if(!a||(b&&a!=b))return false;this._setFocused(null);this.tabs[a].unfocus();Arbiter.inform('chat/conversation-unfocused',{id:a,conversation:this.tabs[a]});return true;},unfocus:function(a,b){if(this._unfocus(a)&&b!==false){this._sendDeferredTabStateChange({unfocus_chat:1});this.uiChanged();}this.lastFocused=null;},unfocusNoSync:function(){this._unfocus();},refocus:function(){if(!this.lastFocused||!this.tabs[this.lastFocused])return null;this._focusTab(this.lastFocused);},_focusTab:function(c,b,d,a,f){if(!this.tabs[c]){var e=this.shortProfiles.getNow(c);if(e&&e.name){d=e.name;a=e.firstName;f=e.type;}if(!f){this._getLogger().log('tab_focus_no_type',{tab_id:c});f='friend';}this.createTab(f,c,d,a,undefined,undefined,'_focusTab');window.chatTabSlider&&chatTabSlider.addTab(c);}window.chatTabSlider&&chatTabSlider.gotoTab(c);if(this.focused!=c){if(this.focused)this.tabs[this.focused].unfocus();this._setFocused(c);this.lastFocused=c;}this.tabs[c].focus(false,this.loaded,b);Arbiter.inform('chat/conversation-focused',{id:c,conversation:this.tabs[c]});return this.tabs[c];},focusTab:function(e,d,f,c,h){var g=this._focusTab(e,d,f,c,h);var a={focus_chat:e,tab_type:g.getPostType()};if(g.getPostType()=='friend'){a.to_online=e&&(this.availableList.get(e)==AvailableListConstants.ACTIVE);var b=AvailableList.getDebugInfo(e);a.presence_source=b.overlaySource;a.presence_time=b.overlayTime;}this._sendDeferredTabStateChange(a);this.uiChanged();},hasFocusedTab:function(){return this.lastFocused===null;},toggleTab:function(c,b,d,a){if(this.focused==c){this.unfocus();}else this.focusTab(c,b,d,a);},getNextTabId:function(a,e,f){if(!(a in this.tabs))return -1;var c=this.tabList.indexOf(this.tabs[a]);if((c===0&&e)||(c===this.tabList.length-1&&!e))return 0;var d=a;if(c>=0){if(e){c--;}else c++;var b=this.tabList.length;d=this.tabList[(c+b)%b].id;}return d;},_handleBlinking:function(a,c){var b=(a==this.user);if(b){this.doStopBlinking(true);}else if(this.isWindowFocused){setTimeout(this.doStopBlinking.bind(this,true),500,false);}else{this.newMsgNames.push(c);if(!this.blinkingTimer)this.blinkingTimer=this._doBlink.bind(this).defer(3000,false);}},_doBlink:function(){clearTimeout(this.blinkingTimer);if(this._isBlinking){DocumentTitle.set(DocumentTitle.get());this._isBlinking=false;}else{if(this.newMsgNames&&this.newMsgNames.length>0){if(this.newMsgNamesIndex>=this.newMsgNames.length)this.newMsgNamesIndex=0;var a=this.newMsgNames[this.newMsgNamesIndex++];if(a.groupMsg){DocumentTitle.set(_tx("{senderName} messaged {groupName}",{senderName:a.fromName,groupName:a.toName}),true);}else DocumentTitle.set(_tx("{name} messaged you",{name:a.fromName}),true);}else DocumentTitle.set("New message!",true);this._isBlinking=true;}this.blinkingTimer=this._doBlink.bind(this).defer(1500,false);},doStopBlinking:function(a){if(this.blinkingTimer||a){this._stopBlinking();this.presenceState.doSync();}},_stopBlinking:function(){if(this.blinkingTimer){if(this._isBlinking)this._doBlink();clearTimeout(this.blinkingTimer);this.blinkingTimer=null;this.newMsgNames=[];this.newMsgNamesIndex=0;}},_isChatMessage:function(a){return a.type=='msg'||a.type=='group_msg'||a.type=='livelisten_msg'||a.type=='thread_msg';},_ignoreSelfMessage:function(a){return !this._isChatMessage(a);},_allowMessage:function(c,a){var b=a.obj;switch(b.type){case 'msg':case 'video':case 'typ':case 'chat_event':return b.from==this.user||b.to==this.user;}return true;},_getTabIDFromChannelMessage:function(d,a){var c=a.obj;var b=null;if(c.id){b=c.id;}else b=(c.from==this.user)?c.to:c.from;return b;},_blackbirdTabPolicyAllows:function(e,a){var c=a.obj;if(c.from&&c.from==this.user)return true;switch(c.type){case 'chat.close':case 'chat.focus':case 'chat.unfocus':case 'start_multichat':case 'update_multichat_participants':case 'buddylist_overlay':case 'livelisten_update':return true;case 'thread_msg':case 'group_msg':case 'msg':case 'offline_msg':case 'livelisten_msg':case 'chat_event':if(!this.presencePrivacy.allows(c.from)){var b=this._getTabIDFromChannelMessage(e,a);var d=!!this.tabs[b];if(d)this._getLogger().log('blackbird_allowed_msg_tab_existed',{type:e,obj:c});return d;}return true;case 'typ':case 'video':return this.presencePrivacy.allows(c.from);case 'show_multichat_callout':return this.chatVisibility.isOnline();}return false;},_handlePresenceMessage:function(r,b){var j=b.obj;if(this.chatConfig.get('blackbird')){if(!this._blackbirdTabPolicyAllows(r,b)){this._getLogger().log('blackbird_rejected_message',{type:r,obj:j});return;}}else if(!this.chatVisibility.isOnline()){this._getLogger().log('offline_message',{type:r,obj:j});return;}if(!this._allowMessage(r,b)){this._getLogger().error('mismatched_messge',{type:r,obj:j});return;}var s=j.window_id;if(!s&&j.msg&&j.msg.window_id)s=j.msg.window_id;if(this.presenceUtil.getSessionID()&&s==this.presenceUtil.getSessionID()&&this._ignoreSelfMessage(j))return;var g=this._getTabIDFromChannelMessage(r,b);if(j.from==this.user){var f=!!j.csid;this._getLogger().log('message_echo_from_non_web',{type:r});this.setSquelched(f);if(f)this._closeTab(g);}var p=this.tabs[g];var m=this.shortProfiles.getNow(g);var q=(m&&m.type)||j.tab_type;var n=this.isSquelched();var o=this.isSquelchedTab(g);if(n||o)this._getLogger().log('message_to_squelched',{type:j.type,id:g,is_squelched:n,is_squelched_tab:o});switch(j.type){case 'chat.close':this._closeTab(g);break;case 'chat.focus':if(!n&&!o)if(!this.doesPageOccludeTabs){this._focusTab(g,undefined,undefined,undefined,q);}else this._setFocusedCookieState(g);break;case 'chat.unfocus':this._unfocus();break;case 'thread_msg':case 'group_msg':case 'livelisten_msg':case 'msg':case 'offline_msg':var d=(j.from==this.user);var i=false;var h,c,e;if(q=='group'||q=='livelisten'){h=j.to_name;c=h;e=GenderConst.UNKNOWN_PLURAL;}else if(d){h=j.to_name;c=j.to_first_name?j.to_first_name:this.getFirstName(h);e=j.to_gender;}else{h=j.from_name;c=j.from_first_name?j.from_first_name:this.getFirstName(h);e=j.from_gender;}var a=this.chatConfig.get('blackbird')||(j.type!='offline_msg');if(!n&&!o&&!d&&!p&&a){p=this.createTab(q,g,h,c,undefined,undefined,'_handlePresenceMessage');i=true;window.chatTabSlider&&chatTabSlider.addTab(g);}j.time=j.msg.time;if(p)p.newMsg(j);if(i)if(!this.focused&&!this.doesPageOccludeTabs){this.focusTab(g);}else{if(!this.focused&&this.doesPageOccludeTabs)this._setFocusedCookieState(g);p.getHistory();}if(p){if(!d&&j.show_orca_callout)p.showOrcaCallout(j.from);if(j.type=='thread_msg'){p.setHasThread(true);this.updateMultichatToolbar(g,j.nub_name,j.titlebar,j.tooltip,j.statuses);this.setTabRecipients(g,j.recipients);}this._handleBlinking(j.from,{toName:j.to_first_name?j.to_first_name:this.getFirstName(j.to_name),fromName:j.from_first_name?j.from_first_name:this.getFirstName(j.from_name),groupMsg:j.type=='group_msg'});}break;case 'typ':if(!n||this.focused==g)p&&p.newTyping(j);break;case 'video':this._newVideoMessage(j);break;case 'chat_event':this._newChatEventMessage(j);break;case 'buddylist_overlay':for(var k in j.overlay){var l={};l[k]=j.overlay[k];this.availableList.addLegacyOverlay(l);}break;case 'start_multichat':this.createMultichatTab(g,j.recipients,j.nub_name,j.titlebar,j.tooltip,false,j.statuses);break;case 'show_multichat_callout':this.showMultichatCallout(g);break;case 'update_multichat_participants':this.updateMultichatToolbar(g,j.nub_name,j.titlebar,j.tooltip,j.statuses);this.setTabRecipients(g,j.recipients);if(typeof j.actionType!='undefined')p&&p.newActionLogMsg(j);break;case 'livelisten_update':Bootloader.loadComponents('MusicLiveListen',function(){window.MusicLiveListen&&MusicLiveListen.getInstance().handleUpdate(j);});break;default:break;}},_newVideoMessage:function(a){Arbiter.subscribe('video-chat/initialized',function(c,b){var d=a.from;var e=a.message_type;var f=a.parameters;b.handleMessage(d,e,f);if(d!=this.user&&e==b.START_SESSION)this.availableList.set(d,AvailableListConstants.ACTIVE,'video');}.bind(this));},_newChatEventMessage:function(a){if(a.log_type==LogMessageType.VIDEO_CALL){this._handleVideoEvent(a.from,a.event_name,a.parameters||{});}else{var b=this.tabs[a.to];b&&b.newLogMessage(a);}},_handleVideoEvent:function(b,a,c){var e=(b==this.user)?c.to:b;var d=this.tabs[e];switch(a){case 'installing':case 'installed':case 'missed-call':require.ensure(['ShortProfiles'],function(f){f.get(e,function(g){if(!d)d=this.createTab('friend',e,g.name,g.firstName,undefined,undefined,'_handleVideoEvent');if(!this.focused)this._focusTab(e);d.newVideoMsg(a,c);}.bind(this));}.bind(this));break;case 'connected-call':d&&d.newVideoMsg(a,c);break;}},_getBucketDescription:function(d){var a=[500,1000,2000,3000,5000];var b=["half_s","1s","2s","3s","5s"];for(var c=0;c<a.length;c++)if(d<a[c])return b[c];return "over_5s";},getFirstName:function(c){var d=c.split(" ");var b=d[0];var a=b.length;if(typeof d[1]!='undefined'&&(a==1||(a==2&&b.indexOf('.')!=-1)||(a==3&&b.toLowerCase()=='the')))b+=' '+d[1];return b;},getHistory:function(b,a){a=a||false;if(!this.histories[b]&&a)this.histories[b]=[];return this.histories[b];},addToHistory:function(f,h){var c=this.getHistory(f,true);var i=true;var g=null;for(var e=c.length-1;e>=0;e--){var b=c[e];if(this._isChatMessage(b)){if(!g)g=c[e];if(b.msg&&b.msg.msgID&&h.msg&&b.msg.msgID==h.msg.msgID&&b.msg.text==h.msg.text)return false;}}if(g&&h.time<=g.time){var a=false;for(e=0;e<c.length;e++)if(this._isChatMessage(c[e])&&h.time==c[e].time){a=true;break;}if(a)return;for(e=c.length-1;e>=0;e--){var d=c[e];if(this._isChatMessage(d)&&(d.to!=h.to||(!d.time||d.time<h.time)))break;}if(e==c.length-1){c.push(h);}else{c.splice(e+1,0,h);var j=this.tabs[f];if(j)j._setHistory(c);i=false;}}else this.histories[f].push(h);return i;},_renderServerTime12hr:function(d){var e=new Date();e.setTime(d+ServerTime.getSkew());var b=e.getHours();var a='am';if(b>=12){a='pm';b-=12;}if(b==0)b=12;var c=e.getMinutes();if(c<10)c='0'+c;var f=b+':'+c+a;return f;},_renderServerTime24hr:function(c){var d=new Date();d.setTime(c+ServerTime.getSkew());var a=d.getHours();if(a<10)a='0'+a;var b=d.getMinutes();if(b<10)b='0'+b;var e=a+':'+b;return e;},setDoesPageOccludeTabs:function(c){var a=this.doesPageOccludeTabs;this.doesPageOccludeTabs=c;if(this.focused&&a===false&&c===true){var b=this.focused;this._unfocus();this._setFocusedCookieState(b);}else if(!this.focused&&a===true&&c===false){this.loaded=false;this._load(this.presenceState.get());}},setSquelched:function(c){var a=(new Date()).valueOf();if(c){var b=a+this.jabberSquelchInterval;this._getLogger().log('squelch',{now:a,until:b});this._squelchUntil=b;this.presenceState.doSync();this.clearHistory();}else if(this._squelchUntil){this._getLogger().log('unsquelch',{now:a,until:this._squelchUntil});this._squelchUntil=null;this.presenceState.doSync();}},isSquelched:function(){return this.getSquelchUntil()!==null;},setSquelchedTab:function(a,b){if(b){this._getLogger().log('squelch_tab',{tab_id:a});this._squelchedIds[a]=true;this.tabs[a]&&this.tabs[a].squelch();this.clearHistory(a);}else{this._getLogger().log('unsquelch_tab',{tab_id:a});delete this._squelchedIds[a];}},clearHistory:function(a){if(a){this.histories[a]&&delete this.histories[a];}else this.histories={};},isSquelchedTab:function(a){return a in this._squelchedIds;},getSquelchUntil:function(){if(this._squelchUntil===null)return null;var a=(new Date()).valueOf();var b=a+(this.jabberSquelchInterval+5000);if(b<this._squelchUntil){this._getLogger().warn('unsquelch_on_get_bad_until',{bound:b});this.setSquelched(false);return null;}else if(a<this._squelchUntil){return this._squelchUntil;}else{this.setSquelched(false);return null;}},_enforceTabLimit:function(){var a=0;while(this.numTabs>this.maxNumTabs&&a<this.numTabs-1)if(this.tabList[a].focused||this.tabList[a].numMissed){++a;}else this.closeTab(this.tabList[a].id);},createMultichatTab:function(e,c,b,f,g,a,d){if(typeof this.tabs[e]=='undefined')this.createTab('thread',e,b,b,0,0,'createMultichatTab');this.tabs[e].setHasThread(a);this.tabs[e].addRecipients(c);this.focusTab(e,true,b,b,'thread');this.updateMultichatToolbar(e,b,f,g,d);},showMultichatCallout:function(b){if(this.tabs[b]){var a=DOM.scry(this.tabs[b].tabHandle,'a.addToThread');if(a.length==1)new AsyncRequest().setData({thread_id:b}).setRelativeTo(a[0]).setURI('/ajax/chat/multichat/callout.php').setAllowCrossPageTransition(true).send();}},setTabRecipients:function(b,a){if(this.tabs[b])this.tabs[b].setRecipients(a);},updateMultichatToolbar:function(f,c,g,h,d){var e=this.tabs[f];if(e){var b=DOM.find(e.getTabDOM(),'div.titlebarLabel');DOM.setContent(b,g);Tooltip.set(b.firstChild,h,'above','center');var a=DOM.scry(e.getTabDOM(),'a.fbNubButton')[0];a&&Tooltip.set(a,h,'above','center');e.updateName(c,c);if(d){e.refreshStatusUpdateTime();e.setParticipantStatuses(d);}}},_createTabLogInvalidFriendID:function(a,b){if(isNaN(parseInt(a,10)))this._getLogger().error('create_tab_invalid_id',{id:a,source:b});},createTab:function(i,c,e,b,f,d,g){if(!i){this._getLogger().log('create_tab_no_type');i='friend';}if(i=='friend')this._createTabLogInvalidFriendID(c,g);var a=window[this.controllers[i]];var h=new a(this,c,e,b,f,d);this.tabs[c]=h;this.tabList.push(h);this.numTabs++;Arbiter.inform('chat/conversation-opened',{id:c,conversation:h});this._enforceTabLimit();return h;},inNLatestActiveTabs:function(c,b){var d=keys(this.tabs);d.sort(function(e,f){return this.tabs[e].staleTime-this.tabs[f].staleTime;}.bind(this));for(var a=d.length-b;a<d.length;a++)if(d[a]==c)return true;return false;},isUserIdle:function(){var a=chatOptions.getSetting('idle_cutoff');return (this.availableList.isUserIdle()&&(!a||!UserActivity.isActive(a)));}};function ChatDisplay(d,a,c,b,e){this.parent.construct(this,d,false,a,c,b,e);}Class.extend(ChatDisplay,'ChatDisplayInterim');
(function(){window.LiveBar=function(d,b,c,a){this._root=d.getRoot();this._handleNewActions(b);this._liveBarTypes=c;this._initDialog(a);Event.listen(this._root,'mousemove',this._mouseMove.bind(this));Event.listen(this._root,'mouseleave',this._mouseLeave.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('livebar_update'),this._handlePushUpdate.bind(this));d.subscribe('render',this._handleChatListUpdate.shield(this));};copy_properties(LiveBar,{MINIMUM_HOVER_TIME:1000});copy_properties(LiveBar.prototype,{_root:null,_liveBarTypes:null,_contextualDialog:null,_hoverFlyout:null,_actions:{},_actionTimers:{},_renderedIcons:{},_fetchedActions:{},_fetchTimer:null,_mouseLeftRoot:false,_chatListRendered:false,_dialogShownFor:null,_initDialog:function(a){this._contextualDialog=a;this._hoverFlyout=new HoverFlyout(this._contextualDialog);this._hoverFlyout.subscribe('show',this._dialogShow.bind(this));},_getFullList:function(){var c={};var d=DOM.scry(this._root,'li.item');for(var a=0;a<d.length;a++){var b=DataStore.get(d[a],'id');if(b)c[b]=d[a];}return c;},_getLiveBarTypes:function(){return this._liveBarTypes;},_actionStillValid:function(a){if((a.expires*1000)-new Date().getTime()>0)return true;return false;},_handleChatListUpdate:function(){if(!this._chatListRendered){this._chatListRendered=true;this._updateIcons();}},_handlePushUpdate:function(b,a){this._handleNewActions(a.obj.actions);},_dialogShow:function(e,d){var c=this._getFullList();var b=DataStore.get(d,'id');var a=this._dialogShownFor&&this._fetchedActions[this._dialogShownFor];if(a){CSS.addClass($(a.node_id),'hidden_elem');DOM.appendContent(document.body,$(a.node_id));}this._dialogShownFor=b;if(this._fetchedActions[b]&&this._fetchedActions[b].action_id==this._actions[b].action_id){this._setDialogContent($(this._fetchedActions[b].node_id));}else this._setDialogContent($N('div',{className:'LiveBarLoading'},"Loading..."));},_mouseMove:function(){if(!this._fetchTimer){this._fetchTimer=setTimeout(this._fetch.bind(this),LiveBar.MINIMUM_HOVER_TIME);this._mouseLeftRoot=false;}},_mouseLeave:function(){this._mouseLeftRoot=true;clearTimeout(this._fetchTimer);this._fetchTimer=null;},_setDialogContent:function(a){DOM.setContent(this._contextualDialog.getContent(),a);CSS.removeClass(a,'hidden_elem');this._contextualDialog.updatePosition();},_fetch:function(){if(this._mouseLeftRoot)return;this._fetchTimer=null;var b=[];for(var a in this._actions)if(!this._fetchedActions[a]||this._fetchedActions[a].action_id!=this._actions[a].action_id)b.push(this._actions[a]);if(b.length>0)new AsyncRequest().setURI('/ajax/chat/livebar.php').setData({actions:b}).setHandler(this._fetchHandler.bind(this)).setErrorHandler(bagofholding).setAllowCrossPageTransition(true).send();},_fetchHandler:function(d){var a=d.payload.actions;if(!(a&&a.length))return;var b;for(var c=0;c<a.length;c++){b=a[c].actor_id;if(!this._actions[b]||a[c].action_id!=this._actions[b].action_id)continue;this._setupDialogContent(a[c]);this._fetchedActions[b]=a[c];}},_setupDialogContent:function(a){var b=HTML(a.html).getRootNode();CSS.addClass(b,'hidden_elem');DOM.appendContent(document.body,b);new Function(a.js)();if(this._dialogShownFor==a.actor_id)this._setDialogContent(b);},_handleNewActions:function(b){var e=false;for(var d=0;d<b.length;d++){if(b[d].delete_action){this._removeAction(b[d]);continue;}var c=b[d].actor_id;var a=b[d].action_id;if(this._actions[c]){if(this._actions[c].action_id==a)continue;this._removeAction(this._actions[c]);}e=true;this._actions[c]=b[d];this._setupExpiryTimer(b[d]);}if(e)this._updateIcons();},_setupExpiryTimer:function(a){var b=(a.expires*1000)-new Date().getTime();this._actionTimers[a.actor_id]=setTimeout(this._removeAction.bind(this,a),Math.max(0,b),false);},_updateIcons:function(){if(!this._chatListRendered)return;var c=this._getFullList();var d=this._getLiveBarTypes();for(var b in c)if(this._actions[b]&&this._actionStillValid(this._actions[b])&&(!this._renderedIcons[b]||this._renderedIcons[b]!=this._actions[b].action_id)){for(var a=0;a<d.length;a++)CSS.removeClass(c[b],d[a]);CSS.addClass(c[b],this._actions[b].livebar_type);this._renderedIcons[b]=this._actions[b].action_id;this._hoverFlyout.initNode(c[b]);}},_removeActionDark:function(a){if(!this._actions[a.actor_id])return;if(this._actions[a.actor_id].action_id!=a.action_id)return;delete this._actions[a.actor_id];return true;},_removeAction:function(a){if(!this._removeActionDark(a))return;var b=a.action_id;var c=a.actor_id;if(this._renderedIcons[c]==b){var f=this._getLiveBarTypes();var e=this._getFullList();if(e[c]){for(var d=0;d<f.length;d++)CSS.removeClass(e[c],f[d]);this._hoverFlyout.deactivateNode(e[c]);if(this._hoverFlyout.getActiveNode()===e[c])this._hoverFlyout.hideFlyout(true);}delete this._renderedIcons[c];}if(this._actionTimers[c]){clearTimeout(this._actionTimers[c]);delete this._actionTimers[c];}if(this._fetchedActions[c]&&this._fetchedActions[c].action_id==b){if(ge(this._fetchedActions[c.node_id]))DOM.remove($(this._fetchedActions[c].node_id));delete this._fetchedActions[c];}}});})();
(function(){window.LiveBarDark=function(d,b,c,a){this.parent.construct(this,d,b,c,a);};Class.extend(LiveBarDark,'LiveBar');copy_properties(LiveBarDark.prototype,{_initDialog:bagofholding,_setupDialogContent:bagofholding,_dialogShow:bagofholding,_setupExpiryTimer:bagofholding,_updateIcons:bagofholding,_removeAction:function(a){this._removeActionDark(a);},_handleChatListUpdate:bagofholding});})();
define('ChatOnlineFriends',[],function(){var a=function(){};a.prototype={chatFriends:{},chatStatuses:['chatOnline','chatIdle','chatMobile','chatOffline'],_subscribe:function(event,b){this._tokens.push(Arbiter.subscribe(event,b));},_channelSubscribe:function(event,b){this._channelSubscriptions.push(this._channelConnection.subscribe(event,b));},onunload:function(){this._tokens.forEach(function(c){Arbiter.unsubscribe(c);});if(this._channelSubscriptions){var b=this._channelConnection;this._channelSubscriptions.forEach(function(c){b.unsubscribe(c);});}},_setStatus:function(b,c){if(CSS.hasClass(b,c))return;this.chatStatuses.forEach(function(d){CSS.conditionClass(b,d,d==c);});},initTypeahead:function(c,b){c.subscribe('reset',function(){CSS.show(b);});c.subscribe('query',function(d,e){if(e.value){CSS.hide(b);}else CSS.show(b);});},init:function(e,f,b,d,c){require.ensure(['AvailableList','ChatConfig','ChannelConnection'],function(g,i,h){this.maxElements=e;this._faceTmpl=c;this._tokens=[];this._availableList=g;this._chatConfig=i;this._channelConnection=h;onleaveRegister(this.onunload.bind(this));this.initTypeahead(f,DOM.find(b,'div.fbFriendsOnlineFacepile'));this._facepile=d.firstChild;this._faceFutures&&this._hideAllFaces();this._faceFutures=[];this._jslog=JSLogger.create('online_friends');OrderedFriendsList.subscribe('initialized',function(){this._orderedFriends=OrderedFriendsList.getList();this._hashedFriends=Object.from(this._orderedFriends);Arbiter.subscribe('chat-visibility/initialized',function(j){this._jslog.log('visibility_init',j);this.update();}.bind(this));this._subscribe(AvailableListConstants.ON_AVAILABILITY_CHANGED,this.update.shield(this));this.update.bind(this).defer();if(this._chatConfig.get('channel_disconnect_warning')){this._channelSubscriptions=[];this._channelSubscribe(this._channelConnection.CONNECTED,this.update.shield(this));this._channelSubscribe(this._channelConnection.RECONNECTING,this._handleChannelReconnecting.bind(this));this._channelSubscribe(this._channelConnection.SHUTDOWN,this._handleChannelShutdown.bind(this));this._channelSubscribe([this._channelConnection.MUTE_WARNING,this._channelConnection.UNMUTE_WARNING],this.update.shield(this));}}.bind(this));Event.listen(d,'click',this.clickHandler.bind(this));Event.listen(DOM.find(b,'.fbChatGoOnlineLink'),'click',function(event){if(this._chatConfig.get('channel_disconnect_warning')&&this._channelConnection.disconnected()){Chat.openBuddyList();}else Chat.goOnline(Chat.openBuddyList);event.kill();}.bind(this));if(this._chatConfig.get('channel_disconnect_warning'))Event.listen(DOM.find(b,'.fbChatReconnectLink'),'click',function(event){if(this._channelConnection.disconnected())this._channelConnection.reconnect();event.kill();}.bind(this));this._availableList.update();}.bind(this));},_handleChannelReconnecting:function(b,d){var f=(d<1000);var c=ge('chatFriendsOnline');var e=DOM.find(c,'.fbChatReconnectLink');var g=DOM.find(c,'.fbChatReconnecting');CSS.conditionShow(e,!f);CSS.conditionShow(g,f);},_handleChannelShutdown:function(){var b=ge('chatFriendsOnline');var c=DOM.find(b,'.fbChatReconnectLink');var d=DOM.find(b,'.fbChatReconnecting');CSS.hide(c);CSS.hide(d);},update:function(){var e=this._chatConfig.get('channel_disconnect_warning')&&this._channelConnection.disconnected();var h=Chat.isOnline();var g=ge('chatFriendsOnline');CSS.conditionClass(g,'disconnected',e);var f=DOM.find(g,'.fbFriendsOnlineFacepile');CSS.conditionShow(f,h);if(h)this._updateFacepile(e);var i=DOM.find(g,'.typeaheadContainer');CSS.conditionShow(i,h);if(this._chatConfig.get('chat_upgrade_link')){var d=DOM.find(g,'.chatUpgradeLink');CSS.conditionShow(d,h);}var b=DOM.find(g,'.chatGoOnlineLink');CSS.conditionShow(b,!h);if(this._chatConfig.get('channel_disconnect_warning')){var c=DOM.find(g,'.chatReconnectLink');CSS.conditionShow(c,h&&e);}},_updateFacepile:function(h){this._availableList.getAvailableIDs().forEach(function(i){if(!this._hashedFriends[i]){this._orderedFriends.push(i);this._hashedFriends[i]=true;}}.bind(this));var c=0;for(var f=0;f<this._orderedFriends.length;f++){var e=this._orderedFriends[f];var b=this._availableList.get(e);var d=this._faceFutures[f];var g=(h||b!==AvailableListConstants.OFFLINE)&&(c<this.maxElements);if(g){if(!d){d=this._makeFace(f);this._faceFutures[f]=d;}c++;}this._updateFace(d,g,this._mapChatStatus(b));}},_mapChatStatus:function(b){switch(b){case AvailableListConstants.OFFLINE:return 'chatOffline';case AvailableListConstants.IDLE:return 'chatIdle';case AvailableListConstants.ACTIVE:return 'chatOnline';case AvailableListConstants.MOBILE:return 'chatMobile';}},_updateFace:function(c,d,b){c&&c(function(e){this._setStatus(e,b);CSS.conditionShow(e,d);}.bind(this));},_makeFace:function(d){var e=null;var b=null;var c=this._orderedFriends[d];require.ensure(['ShortProfiles'],function(f){f.get(c,function(l){b=this._faceTmpl.render();DataStore.set(b,'friendID',c);var k=XHPTemplate.getNode(b,'img');var m=k.cloneNode(false);m.setAttribute('src',l.thumbSrc);DOM.replace(k,m);var g=XHPTemplate.getNode(b,'anchor');TooltipLink.setTooltipText(g,l.name);e&&e(b);var h=false;for(var j=d+1;j<this._orderedFriends.length&&!h;j++){var i=this._faceFutures[j];var n=i&&i();if(n){this._facepile.insertBefore(b,n);h=true;}}if(!h)this._facepile.appendChild(b);}.bind(this));}.bind(this));return function faceFuture(f){if(f)if(b){f(b);}else e=f;return b;};},clickHandler:function(event){var d=event.getTarget();var b=Parent.byClass(d,'uiFacepileItem');if(b){var c=DataStore.get(b,'friendID');if(c&&Chat.isOnline()){require.ensure(['ShortProfiles'],function(e){e.get(c,function(f){Chat.openTab(c,f.name,'friend','online_friends');});});return false;}}},_hideAllFaces:function(){this._faceFutures.forEach(function(b){b&&b(function(c){DOM.remove(c);});});}};return a;});
function ChatSidebarDropdown(){}ChatSidebarDropdown.prototype={init:function(a){this._root=a;this._logger=JSLogger.create('blackbird');require.ensure(['ChatVisibility'],function(b){this._chatVisibility=b;Selector.listen(a,'select',this._onSelect.bind(this));Selector.listen(a,'toggle',this._onToggle.bind(this));}.bind(this));Arbiter.subscribe('chat/option-changed',this._onOptionChanged.bind(this));require.ensure(['ChatConfig'],function(b){if(!b.get('blackbird'))Arbiter.subscribe(['chat-options/initialized','chat/visibility-changed'],this._onVisibilityChanged.shield(this));}.bind(this));},changeSetting:function(b,c){if(this._pendingChange)return false;this._pendingChange=true;var a={};a[b]=c;chatOptions.setSetting(b,c);new AsyncRequest('/ajax/chat/settings.php').setHandler(this._onChangeSettingResponse.bind(this,b,c)).setErrorHandler(this._onChangeSettingError.bind(this,b,c)).setFinallyHandler(this._onChangeFinally.bind(this)).setData(a).setAllowCrossPageTransition(true).send();},_conditionEnabled:function(c,a){var b=Selector.getOption(this._root,c);b&&Selector.setOptionEnabled(b,a);},_onChangeSettingResponse:function(a,c,b){require.ensure(['PresenceState'],function(d){d.doSync();});},_onChangeSettingError:function(a,c,b){chatOptions.setSetting(a,!c);},_onChangeFinally:function(){this._pendingChange=false;},_onOptionChanged:function(a,b){var c=b.name;var e=b.value;if(c==='sound'){var d=Selector.getOption(this._root,c);if(e!==Selector.isOptionSelected(d))Selector.setSelected(this._root,c,e);}},_onSelect:function(b){if(this._pendingChange)return false;var d=false;var e=false;var a=Selector.getOptionValue(b.option);switch(a){case 'sidebar':return this.toggleSidebar();case 'online':if(!this._chatVisibility.isOnline()){this._chatVisibility.goOnline();}else e=true;d=true;break;case 'offline':if(this._chatVisibility.isOnline()){this._chatVisibility.goOffline();}else e=true;d=true;break;case 'advanced_settings':Arbiter.inform('chat/advanced-settings-dialog-opened');d=true;break;}var c=e?'sidebar_dropdown_visibility_error':'sidebar_dropdown_visibility_error';this._logger.error(c,{action:a});if(d){Selector.toggle(this._root);return false;}},_onToggle:function(a){if(this._pendingChange)return false;var b=Selector.getOptionValue(a.option);var c=Selector.isOptionSelected(a.option);switch(b){case 'visibility':if(!this._chatVisibility){this._jslogger.error('on_toggle_visibility_undefined');return;}this._chatVisibility.toggleVisibility();this._logger.log('sidebar_dropdown_toggle_visibility',{available:c});break;case 'sound':this.changeSetting(b,c);break;}Selector.toggle(this._root);},_onVisibilityChanged:function(){var a=Chat.isOnline();var b=Selector.getOption(this._root,'visibility');if(a!==Selector.isOptionSelected(b))Selector.setSelected(this._root,'visibility',a);},toggleSidebar:function(){Chat.toggleSidebar();Selector.toggle(this._root);return false;}};
function ChatTabSlider(){this.handleWidth=164;this.focusedHandleAdditionalWidth=100;this.animationTime=210;this._init();}ChatTabSlider.prototype={_init:function(){this.org_s=0;this.numToShow=0;this.numShift=1;this.shiftByNumTabs=false;this.timer=null;this.skipAnimation=false;this.chatWidth=null;var a=$('fbDockChatTabSlider');this.chat=ge('fbDockChatTabsWrapper');this.chatTabBar=ge('fbDockChatTabs');this.nextTab=DOM.find(a,'div.next');Event.listen(this.nextTab,'click',this.next.bind(this));this.prevTab=DOM.find(a,'div.previous');Event.listen(this.prevTab,'click',this.prev.bind(this));this.nextCounter=DOM.find(this.nextTab,'span.numTabs');this.prevCounter=DOM.find(this.prevTab,'span.numTabs');this.numMissedNextCounter=DOM.find(this.nextTab,'span.numMessages');this.numMissedPrevCounter=DOM.find(this.prevTab,'span.numMessages');Toggler.createInstance(this.chatTabBar);this.numNext=0;this.numPrev=0;this.prevTabs={};this.nextTabs={};PresenceState.registerStateLoader(this._load.bind(this));PresenceState.registerStateStorer(this._store.bind(this));Event.listen(window,'resize',this._resize.bind(this));},load:function(){this._load(PresenceState.get());this._resize();Arbiter.inform('chat-tab-slider/loaded',this,Arbiter.BEHAVIOR_PERSISTENT);},_load:function(a){var b=0;if(a)b=(a.s?a.s:b);this._setPos(b);},_store:function(a){a.s=this._s;return a;},_calculate:function(){this._setMaxWidth();this.numToShow=parseInt((this.maxWidth-this.focusedHandleAdditionalWidth)/this.handleWidth,10);this.numToShow=this.numToShow>0?this.numToShow:1;if(this.shiftByNumTabs)this.numShift=this.numToShow;if(this._s!=null)this._setPos(this._s);},_setMaxWidth:function(){var b=document.body.clientWidth;var a=Parent.byClass(this.chat,'fbDock').firstChild;for(;a;a=a.nextSibling)b-=a.clientWidth;window.ChatSidebar&&(b-=ChatSidebar.getVisibleWidth());b+=this.chat.clientWidth;b-=80;b-=30;this.maxWidth=b;},_setPos:function(a){if(a<0)a=0;this._s=a;this._e=Math.min(this._s+this.numToShow,chatDisplay.numTabs);this._s=Math.max(this._e-this.numToShow,0);},_doSync:function(){var a=(this.org_s!=this._s);this.org_s=0;if(a)PresenceState.doSync();},_build:function(){var a=(this.numToShow>=chatDisplay.numTabs)?true:false;this.setVisibleTabs(a);if(a){this.resetCounters();}else this.updateCounters();this.updateMissedCount();},_resize:function(){this.org_s=this._s;this._calculate();this._build();this._doSync();if(chatDisplay.lastFocused!=null)this.gotoTab(chatDisplay.lastFocused);},addTab:function(a){this._build();},gotoTab:function(a){if(!(a in chatDisplay.tabs))return;var b=chatDisplay.tabList.indexOf(chatDisplay.tabs[a]);if(!this._inRange(b)){var c=(b-this.numToShow)+1;this._setPos(c);this._build();}},close:function(){this._setPos(((this.numPrev>0||this.numNext>0)&&this._s>0)?this._s-1:0);this._calculate();this._build();},setVisibleTabs:function(a){var d=chatDisplay.tabList;if(d)for(var b=0,c=d.length;b<c;++b)if(this._inRange(b,d[b].id)||a){d[b].show();}else d[b].hide();},_inRange:function(c,b){var d,a=false;if(c>=this._s){d=true;delete this.prevTabs[b];}else this.prevTabs[b]=b;if(c<this._e){a=true;delete this.nextTabs[b];}else this.nextTabs[b]=b;return (d&&a);},updateMissedCount:function(){var c=0;var b=0;for(var a in this.prevTabs)c+=chatDisplay.tabs[a]?chatDisplay.tabs[a].numMissed:0;this.numMissedPrevCounter.innerHTML=c;CSS.conditionClass(this.numMissedPrevCounter,'hidden_elem',!c);for(var a in this.nextTabs)b+=chatDisplay.tabs[a]?chatDisplay.tabs[a].numMissed:0;this.numMissedNextCounter.innerHTML=b;CSS.conditionClass(this.numMissedNextCounter,'hidden_elem',!b);},updateCounters:function(){this.numNext=chatDisplay.numTabs-this._e;this.numPrev=this._s;if(this.numNext<=0){this.numNext=0;CSS.addClass(this.nextTab,'disabled');}else CSS.removeClass(this.nextTab,'disabled');if(this.numPrev<=0){this.numPrev=0;CSS.addClass(this.prevTab,'disabled');}else CSS.removeClass(this.prevTab,'disabled');if(this.numPrev>0||this.numNext>0){CSS.show(this.nextTab);CSS.show(this.prevTab);}else{CSS.hide(this.nextTab);CSS.hide(this.prevTab);}this.nextCounter.innerHTML=this.numNext;this.prevCounter.innerHTML=this.numPrev;},resetCounters:function(){this._setPos(0);this.updateCounters();},shift:function(a){this.org_s=this._s;chatDisplay.unfocusNoSync();this._shift.bind(this,a).defer();},_shift:function(a){this._setPos(this._s<0?0:this._s+a);this._slide(a);if(this.timer||this.skipAnimation){this._slideReset();this.skipAnimation=true;var b=setTimeout(function(){this.skipAnimation=false;}.bind(this),500);}else this.timer=setTimeout(function(){this._slideReset();}.bind(this),this.animationTime);},_slide:function(a){this._slideSetup(false);this.setVisibleTabs(true);this.slideInc=(a*(this.handleWidth));this.leftPos=-(a)*(this.numNext*(this.slideInc));this.chatTabBar.style.left=this.leftPos+'px';animation(this.chatTabBar).by('left',this.slideInc).duration(this.animationTime-10).go();},_slideSetup:function(a){this.chat.style.position=a?'':'relative';this.chat.style.overflow=a?'visible':'hidden';if(!this.chatWidth)this.chatWidth=this.chatTabBar.clientWidth;if(a)this.chatWidth=null;this.chat.style.width=a?'':this.chatWidth+'px';this.chatTabBar.style.width=a?'':chatDisplay.numTabs*this.handleWidth+'px';this.chatTabBar.style.position=a?'':'absolute';},_slideReset:function(){clearTimeout(this.timer);this.timer=null;this._slideSetup(true);this._build();var a=chatDisplay.lastFocused;if(a){var b=chatDisplay.tabList.indexOf(chatDisplay.tabs[a]);if(this._inRange(b)){chatDisplay.refocus();}else chatDisplay.lastFocused=null;}this._doSync();},next:function(){this.numNext&&this.shift(this.numShift);return false;},prev:function(){this.numPrev&&this.shift(-this.numShift);return false;}};
add_properties('TypeaheadBehaviors',{chatTypeahead:function(c){var a=c.getElement();var b=c.getView().getElement();c.subscribe('focus',function(){c.getData().refreshData();});c.subscribe('blur',function(d){c.getCore().reset();});c.subscribe('respond',function(d,e){if(e.value&&e.value===c.getCore().getValue()){if(!e.results.length){var f=$N('div',{className:'noResults'},"Friend not found.");DOM.setContent(b,f);}CSS.addClass(a,'hasValue');}});c.subscribe('reset',function(){CSS.removeClass(a,'hasValue');});c.subscribe('select',function(d,e){Arbiter.inform('chat-typeahead/select',{id:e.selected.uid});Chat.openTab(e.selected.uid,e.selected.text,e.selected.type,'typeahead');require.ensure(['ChatConfig'],function(f){if(!f.get('blackbird'))Chat.goOnline();});});c.subscribe('highlight',function(d,f){if(f.index>=0){var i=c.getView().getItems()[f.index];if(i){var h=new Rect(i);var e=i.offsetParent;var g=h.boundWithin(new Rect(e)).getPositionVector();h.getPositionVector().sub(g).scrollElementBy(e);}}});}});
function ChatTypeaheadCore(a){this.parent.construct(this,a);}Class.extend(ChatTypeaheadCore,'TypeaheadCore');ChatTypeaheadCore.prototype={handleTab:bagofholding,keydown:function(event){var a=Event.getKeyCode(event);if(a===KEYS.ESC){this.reset.shield(this).defer();return event.kill();}return this.parent.keydown(event);}};
function ChatTypeaheadDataSource(a){this.parent.construct(this,a);this.persistOnRefresh=a.persistOnRefresh!==false;this.showOfflineUsers=!!a.showOfflineUsers;this._jslog=JSLogger.create('chat_typeahead');this._jslog.log('created');}Class.extend(ChatTypeaheadDataSource,'DataSource');ChatTypeaheadDataSource.prototype={init:function(){this._jslog.log('init');OrderedFriendsList.subscribe('initialized',function(){this._jslog.log('ordered_friends_list_init');this.parent.init();var a=Arbiter.subscribe(AvailableListConstants.ON_AVAILABILITY_CHANGED,this._update.shield(this));this._update();if(!this.persistOnRefresh)onleaveRegister(function(){Arbiter.unsubscribe(a);});}.bind(this));},bootstrap:function(){this._jslog.log('bootstrap');this.parent.bootstrap();if(this.showOfflineUsers){this._jslog.log('show_offline_users');require.ensure(['ShortProfiles'],function(a){this._jslog.log('ensured_short_profiles');if(a.hasAll()){this._update();}else{this._jslog.log('fetch_all_short_profiles');a.fetchAll();this.inform('activity',{activity:true});var b=a.subscribe('updated',function(){this.inform('activity',{activity:false});this._update();}.bind(this));if(!this.persistOnRefresh)onleaveRegister(function(){a.unsubscribe(b);});}}.bind(this));}},_update:function(){require.ensure(['AvailableList'],function(a){var e=this.value;this.dirty();var d=window.ShortProfiles?ShortProfiles.getCachedProfileIDs():[];var c=d.filter(function(f){var g=ShortProfiles.getNow(f);return g.type==='friend';});c.sort(OrderedFriendsList.compare);var b=[];c.forEach(function(g){if(g==Env.user)return;var f=a.get(g);if(!this.showOfflineUsers&&f!==a.ACTIVE)return;var h=ShortProfiles.getNow(g);b.push({uid:g,text:h.name,tokens:h.additionalName,localized_text:h.name,additional_text:h.additionalName,photo:h.thumbSrc,availability:f,type:h.type});}.bind(this));if(b.length)this.addEntries(b);this.value=e;if(e)this.respond(e,this.buildUids(e,[],this._exclusions),true);}.bind(this));},refreshData:function(){require.ensure(['AvailableList'],function(a){a.update();}.bind(this));}};
require.ensure(['ChatConfig','PresencePrivacy'],function(a,b){add_properties('TypeaheadRenderers',{chat:function(c,d){var f='offline';switch(c.availability){case AvailableListConstants.ACTIVE:f='active';break;case AvailableListConstants.IDLE:f='idle';break;case AvailableListConstants.MOBILE:f='mobile';break;}if(a.get('blackbird')&&!b.allows(c.uid))f='invis';var e=[];if(c.photo)e.push($N('img',{alt:'',src:c.photo}));if(c.text)e.push($N('span',{className:'text'},[c.text]));e.push($N('i',{className:f}));return $N('li',{className:'clearfix '+f},e);}});});
var VideoChat={init:function(){VideoEvents.subscribe(VideoEvents.START_CALL_UI,function(){return VideoChat.onStartCallUI();});VideoEvents.subscribe(VideoEvents.START_CALL,function(a,b){VideoChat._invokeCore('onStartCall',b.idTarget);});VideoChatView.init();Arbiter.inform('video-chat/initialized',this,Arbiter.BEHAVIOR_STATE);},handleMessage:function(b,a,c){VideoChat._invokeCore('handleMessage',b,a,c);},onStartCallUI:bagofholding,_invokeCore:function(b){var a=Array.prototype.slice.call(arguments,1);Bootloader.loadComponents('VideoChatCore',function(){VideoChat.initCore();VideoChat[b].apply(VideoChat,a);});}};
function PresenceEnabled(){}PresenceEnabled.prototype.init=function(b,c){var a=function(){require.ensure(['AvailableList'],function(d){var e=d.get(c);CSS.conditionClass(b,'chatOffline',e!=AvailableListConstants.ACTIVE&&e!=AvailableListConstants.IDLE);CSS.conditionClass(b,'chatIdle',e==AvailableListConstants.IDLE);CSS.conditionClass(b,'chatOnline',e==AvailableListConstants.ACTIVE);});};Arbiter.subscribe(AvailableListConstants.ON_AVAILABILITY_CHANGED,a);a();};
function DynamicFacepileItemController(){}DynamicFacepileItemController.prototype.init=function(b,c,a){DOM.scry(b,"a").each(function(d){Event.listen(d,"click",function(event){if(window.Chat&&window.AvailableList)if(AvailableList.get(c)==AvailableListConstants.ACTIVE){Chat.openTab(c,a,"friend");return event.kill();}});});};