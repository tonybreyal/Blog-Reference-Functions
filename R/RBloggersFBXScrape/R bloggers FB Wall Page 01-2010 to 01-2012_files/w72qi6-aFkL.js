/*1325632033,169776068*/

if (window.CavalryLogger) { CavalryLogger.start_js(["aZc\/7"]); }

__e("AvailableListConstants",[],function(c,e,d,b){var a={ON_AVAILABILITY_CHANGED:'buddylist/availability-changed',ON_INITIALIZED:'available-list/initialized',ON_UPDATE_ERROR:'buddylist/update-error',ON_UPDATED:'buddylist/updated',OFFLINE:0,IDLE:1,ACTIVE:2,MOBILE:3,LEGACY_OVERLAY_OFFLINE:-1,LEGACY_OVERLAY_ONLINE:0,LEGACY_OVERLAY_IDLE:1,legacyStatusMap:{'0':2,'1':1,'-1':0,'2':3},reverseLegacyStatusMap:{0:-1,1:1,2:0,3:2}};window.AvailableListConstants=d.exports=a;},3);
__e("ChatConfig",["ChatConfigInitialData","copyProperties"],function(f,h,g,e){var b=h('ChatConfigInitialData');var d=h('copyProperties');var c={};var a=g.exports={get:function(j,i){return j in c?c[j]:i;},set:function(i){if(arguments.length>1){var j={};j[i]=arguments[1];i=j;}d(c,i);},getDebugInfo:function(){return c;}};a.set(b);},3);
__e("PresenceUtil",["cookie","Env","math-extensions","tx"],function(f,h,g,e){var a=h('cookie');var b=h('Env');var c=h('math-extensions');f.tx=h('tx');var d=c.rand32()+1;f.PresenceUtil=g.exports={checkMaintenanceError:function(i){if(i.getError()==1356007)return true;return false;},getErrorDescription:function(i){var k=i.getError();var j=i.getErrorDescription();if(!j)j="An error occurred.";if(k==1357001)j="Your session has timed out. Please log in.";return j;},getSessionID:function(){return d;},hasUserCookie:function(){return b.user===a.get('c_user');}};},3);
__e("dcode",[],function(d,f,e,c){var a,g={},b={_:'%',A:'%2',B:'000',C:'%7d',D:'%7b%22',E:'%2c%22',F:'%22%3a',G:'%2c%22ut%22%3a1',H:'%2c%22bls%22%3a',I:'%2c%22n%22%3a%22%',J:'%22%3a%7b%22i%22%3a0%7d',K:'%2c%22pt%22%3a0%2c%22vis%22%3a',L:'%2c%22ch%22%3a%7b%22h%22%3a%22',M:'%7b%22v%22%3a2%2c%22time%22%3a1',N:'.channel%22%2c%22sub%22%3a%5b',O:'%2c%22sb%22%3a1%2c%22t%22%3a%5b',P:'%2c%22ud%22%3a100%2c%22lc%22%3a0',Q:'%5d%2c%22f%22%3anull%2c%22uct%22%3a',R:'.channel%22%2c%22sub%22%3a%5b1%5d',S:'%22%2c%22m%22%3a0%7d%2c%7b%22i%22%3a',T:'%2c%22blc%22%3a1%2c%22snd%22%3a1%2c%22ct%22%3a',U:'%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',V:'%2c%22blc%22%3a0%2c%22snd%22%3a0%2c%22ct%22%3a',W:'%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a',X:'%2c%22ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1',Y:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',Z:'%2c%22sb%22%3a1%2c%22t%22%3a%5b%5d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a'};(function(){var i=[];for(var h in b){g[b[h]]=h;i.push(b[h]);}i.reverse();a=new RegExp(i.join("|"),'g');})();d.Dcode=e.exports={encode:function(h){return encodeURIComponent(h).replace(/([_A-Z])|%../g,function(j,i){return i?'%'+i.charCodeAt(0).toString(16):j;}).toLowerCase().replace(a,function(i){return g[i];});},decode:function(h){return decodeURIComponent(h.replace(/[_A-Z]/g,function(i){return b[i];}));}};},3);
__e("presence-cookie-manager",["cookie","dcode","JSLogger","json","PresenceInitialData","PresenceUtil","uri"],function(q,s,r,p){q.CookieManager=function(){};var a=s('cookie');var b=s('dcode');var c=s('JSLogger');s('json');var d=s('PresenceInitialData');var e=s('PresenceUtil');var f=s('uri');var o=d.cookieVersion;var h=d.dictEncode;var g='presence';var n={};var k=null;var l=null;var j=c.create('presence_cookie');function i(){try{var data=a.get(g);if(k===data){return l;}else{k=data;l=null;}if(data&&data.charAt(0)=='E')data=b.decode(data.substring(1));if(data){l=JSON.parse(data);return l;}}catch(t){j.warn('getcookie_error');}return null;}function m(){return parseInt(new Date().getTime()/1000,10);}q.presenceCookieManager=r.exports={register:function(u,t){n[u]=t;},store:function(){var t=i();if(t&&t.v&&o<t.v)return;var u={v:o,time:m()};for(var x in n)u[x]=n[x]();var w=JSON.stringify(u);if(h)w='E'+b.encode(w);if(e.hasUserCookie()){var v=f.getRequestURI(false).isSecure()&&!!a.get('csm');a.set(g,w,null,null,v);}},clear:function(){a.clear(g);},getSubCookie:function(u){var t=i();if(!t)return null;return t[u];}};},3);
__e("PresenceState",["JSLogger","math-extensions","presence-cookie-manager"],function(r,u,s,q){var b=u('JSLogger');var c=u('math-extensions');var t=u('presence-cookie-manager');var a=2000;var m=[];var l=[];var p=null;var d=null;var k=null;var n=0;var g=null;var o=0;var h=b.create('presence_state');function e(){clearTimeout(p);p=null;n=Date.now();t.store();i(k);}function f(){var x={ut:n};for(var v=0,w=m.length;v<w;v++)x=m[v](x);k=x;return k;}function i(w){o++;try{n=c.verifyNumber(w.ut);if(!d)d=setInterval(j,a);k=w;if(g===null)g=w;for(var i=0;i<l.length;i++)l[i](w);}catch(v){o--;throw v;}o--;}function j(){var v=t.getSubCookie('state');if(!v)return;if(v.ut>n){i(v);return;}}t.register('state',f);(function(){var w=t.getSubCookie('state');if(!w){h.debug('null_state');i(f());return;}try{i(w);}catch(v){h.error('load_exception',{e:v.toString()});i(f());}})();r.PresenceState=s.exports={doSync:function(v){if(o)return;if(v){e();}else if(!p)p=e.defer();},registerStateStorer:function(v){m.push(v);},registerStateLoader:function(v){l.push(v);},get:function(){return k;},getInitial:function(){return g;}};},3);
__e("presence-arbiter-message",[],function(b,d,c,a){b.PresenceMessage=c.exports={STARTED:'presence/started',SHUTDOWN:'presence/shutdown',RESTARTED:'presence/restarted',WINDOW_RESIZED:'presence/window-resized',TAB_CLOSED:'presence/tab-closed',TAB_OPENED:'presence/tab-opened',PRESENCE_UPDATER_READY:'presence/updater-ready',getAppMessageType:function(e,f){return 'presence/app_message:'+e+':'+f;},getArbiterMessageType:function(e){return 'presence/message:'+e;}};},3);
__e("PresencePrivacy",["arbiter","AsyncRequest","ChannelConstants","copyProperties","Env","JSLogger","MercuryRequireEnsure","presence-arbiter-message","PresenceUtil"],function(zf,zn,zh,ze){var a=zn('arbiter');var b=zn('AsyncRequest');var c=zn('ChannelConstants');var zc=zn('copyProperties');var d=zn('Env');var e=zn('JSLogger');var f=zn('MercuryRequireEnsure');var g=zn('presence-arbiter-message');var i=zn('PresenceUtil');if(zf.PresencePrivacy){zh.exports=zf.PresencePrivacy;}else{var m='/ajax/chat/privacy/settings.php';var n='/ajax/chat/privacy/online_policy.php';var o='/ajax/chat/privacy/visibility.php';var j='friend_visibility';var l='visibility';var k='online_policy';var zg={};var zo;var zj={};var zk;var zd;var zi;var zm=[];var zl=false;function p(){return e.create('blackbird');}var h=zc(new a(),{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1});function x(zq){var zp;for(zp in zq){var zr=zq[zp];if(zp==d.user){p().error('set_viewer_visibility');throw new Error("Invalid to set current user's visibility");}switch(zr){case h.WHITELISTED:case h.BLACKLISTED:case h.UNLISTED:break;default:p().error('set_invalid_friend_visibility',{id:zp,value:zr});throw new Error("Invalid state: "+zr);}}for(zp in zq)zg[zp]=zq[zp];h.inform('privacy-changed');}function y(zp,zr){var zq={};zq[zp]=zr;x(zq);}function za(zp){switch(zp){case h.ONLINE:case h.OFFLINE:break;default:p().error('set_invalid_visibility',{value:zp});throw new Error("Invalid visibility: "+zp);}zo=zp;h.inform('privacy-changed');h.inform('privacy-user-presence-changed');a.inform('chat/visibility-changed',{sender:this});}function z(zp){switch(zp){case h.ONLINE_TO_WHITELIST:case h.ONLINE_TO_BLACKLIST:break;default:throw new Error("Invalid default online policy: "+zp);}zd=zp;h.inform('privacy-user-presence-changed');h.inform('privacy-changed');}function zb(zq,zp){zl=true;zq.send();}function w(zq,zp){zm.push({request:zq,data:zp});if(!zl){next=zm.shift();zb(next.request,next.data);}}function u(zp,zq){var zr=zp.type;if(zr===j){var zt=zq.payload.user_availabilities;h.inform('privacy-availability-changed',{user_availabilities:zt});for(var zs in zp.settings)zj[zs]=zp.settings[zs];}else{if(zr===l){zk=zp.visibility;}else if(zr===k)zi=zp.online_policy;h.inform('privacy-user-presence-response');}p().log('set_update_response',{data:zp,response:zq});}function r(zp,zq){if(zo!==zk)za(zk);if(zd!==zi)z(zi);zc(zg,zj);h.inform('privacy-changed');zm=[];p().log('set_error_response',{data:zp,response:zq});}function s(zp){zl=false;if(zm.length>0){next=zm.shift();zb(next.request,next.data);}}function v(zr,zq){if(i!=null){var zp=zr.getData();zp.window_id=i.getSessionID();zr.setData(zp);}zr.setHandler(u.bind(this,zq)).setErrorHandler(r.bind(this,zq)).setTransportErrorHandler(r.bind(this,zq)).setFinallyHandler(s.bind(this)).setAllowCrossPageTransition(true);return zr;}function q(zr,zp,zq){return v(new b(zr).setData(zp),zq);}function t(zt,zp){var zs=zp.obj;if(zs.viewer_id!=d.user){p().error('invalid_viewer_for_channel_message',{type:zt,data:zp});throw new Error("Viewer got from the channel is not the real viewer");}if(zs.window_id===i.getSessionID())return;var zq=zs.data;if(zs.event=='access_control_entry'){zq.target_ids.forEach(function(zu){y(zu,zq.setting);zj[zu]=zq.setting;});}else{if(zs.event=='visibility_update'){var zr=!!zq.visibility?h.ONLINE:h.OFFLINE;za(zr);zk=zr;}else if(zs.event=='online_policy_update'){z(zq.online_policy);zi=zq.online_policy;}h.inform('privacy-user-presence-response');}p().log('channel_message_received',{data:zp.obj});}zc(h,{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1,init:function(zr,zp,zq){zo=zk=zr;zd=zi=zp;zg=zc({},zq);zj=zc({},zq);zl=false;this.inform('initialized',this,a.BEHAVIOR_PERSISTENT);this.inform('privacy-changed');this.inform('privacy-user-presence-changed');p().log('initialized',{visibility:zr,policy:zp});a.inform('chat-visibility/initialized',this,a.BEHAVIOR_PERSISTENT);a.subscribe(g.getArbiterMessageType('privacy_changed'),t.bind(this));a.subscribe(c.ON_CONFIG,function(zt,zs){var zv=zs.getConfig('visibility',null);if(zv!==null&&typeof(zv)!=='undefined'){var zu=zv?h.ONLINE:h.OFFLINE;za(zu);p().log('config_visibility',{vis:zu});}}.bind(this));a.subscribe('channel/visibility-config',function(zs,zt){var zu=zt?h.ONLINE:h.OFFLINE;if(zu!=zo){za(zu);p().log('config_visibility_old_channel',{vis:zu});}}.bind(this));},setVisibility:function(zs){zk=zo;za(zs);var zp={visibility:zs};var zq={type:l,visibility:zs};var zr=q(o,zp,zq);w(zr,zq);p().log('set_visibility',{data:zp});return zs;},getVisibility:function(){return zo;},setOnlinePolicy:function(zs){zi=zd;z(zs);var zp={online_policy:zs};var zq={type:k,online_policy:zs};var zr=q(n,zp,zq);w(zr,zq);p().log('set_online_policy',{data:zp});return zs;},getOnlinePolicy:function(){return zd;},getFriendVisibility:function(zp){return zg[zp]||h.UNLISTED;},allows:function(zp){if(this.getVisibility()===h.OFFLINE)return false;var zq=this.getOnlinePolicy();return zq===h.ONLINE_TO_WHITELIST?zg[zp]==h.WHITELISTED:zg[zp]!=h.BLACKLISTED;},setFriendsVisibility:function(zt,zx){if(zt.length>0){var zw={};for(var zr=0;zr<zt.length;zr++){var zs=zt[zr];zj[zs]=zg[zs];zw[zs]=zx;}x(zw);var zv=zx;if(zv==h.UNLISTED)zv=zj[zt[0]];var zp={users:zt,setting:zx,setting_type:zv};var zq={type:j,settings:zw};var zu=q(m,zp,zq);w(zu,zq);p().log('set_friend_visibility',{data:zp});}return zx;},setFriendVisibilityMap:function(zr,zs){for(var zq in zr)zj[zq]=zg[zq];x(zr);var zp={type:j,settings:zr};w(v(zs,zp),zp);p().log('set_friend_visibility_from_map',{data:zr});},allow:function(zp){if(this.allows(zp)){p().error('allow_already_allowed');throw new Error("allow() should only be called for users that "+"are not already allowed");}if(this.getVisibility()===h.OFFLINE){p().error('allow_called_while_offline');throw new Error("allow() should only be called when the user is already online");}var zq=this.getOnlinePolicy()===h.ONLINE_TO_WHITELIST?h.WHITELISTED:h.UNLISTED;return this.setFriendsVisibility([zp],zq);},disallow:function(zp){if(!this.allows(zp)){p().error('disallow_already_disallowed');throw new Error("disallow() should only be called for users that "+"are not already disallowed");}if(this.getVisibility()===h.OFFLINE){p().error('disallow_called_while_offline');throw new Error("disallow() should only be called when the user is already online");}var zq=this.getOnlinePolicy()===h.ONLINE_TO_BLACKLIST?h.BLACKLISTED:h.UNLISTED;return this.setFriendsVisibility([zp],zq);},getBlacklist:function(){var zq=[];for(var zp in zg)if(zg[zp]===h.BLACKLISTED)zq.push(zp);return zq;},getWhitelist:function(){var zq=[];for(var zp in zg)if(zg[zp]===h.WHITELISTED)zq.push(zp);return zq;},getMapForTest:function(){return zg;},setMapForTest:function(zp){zg=zp;}});f.ensure(['PresencePrivacyInitialData'],function(zp){h.init.bind(h,zp.visibility,zp.onlinePolicy,zp.privacyData).defer();});zf.PresencePrivacy=zh.exports=h;}},3);
function ChatOptions(b,a){this._jslog=JSLogger.create('chat_options');this._jslog.log('server',{vis:b});this.visibility=!!b;this._lastVisibilityChangeTime=0;this.settings=a;}ChatOptions.prototype={load:function(){require.ensure(['ChatConfig','PresenceUtil','PresenceState','ChannelConstants','ChannelManager'],function(c,e,d,a,b){this._chatConfig=c;this._presenceState=d;d.registerStateStorer(this._storeState.bind(this));d.registerStateLoader(this._loadState.bind(this));if(!c.get('blackbird')){Arbiter.subscribe(a.ON_CONFIG,function(g,f){var h=b.getConfig('visibility');this._jslog.log('vis_chan_config',{new_vis:h});this.setVisibility(h);}.bind(this));Arbiter.subscribe('channel/visibility-config',function(f,g){this._jslog.log('vis_chan_config',{new_vis:g});this.setVisibility(g);}.bind(this));}Arbiter.subscribe(PresenceMessage.getArbiterMessageType('visibility'),function(f,g){var h=g.obj;if(h.window_id===e.getSessionID())return;this._jslog.log('vis_chan_message',{new_vis:h.visibility,window_id:h.window_id});this.setVisibility(h.visibility);}.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('setting'),function(f,g){var h=g.obj;if(h.window_id===e.getSessionID())return;this.setSetting(h.setting,!!h.value);}.bind(this));Arbiter.inform('chat-options/initialized',this,Arbiter.BEHAVIOR_PERSISTENT);if(!c.get('blackbird')){this._jslog.log('define_vis_init',this.visibility);Arbiter.inform('chat-visibility/initialized',this,Arbiter.BEHAVIOR_PERSISTENT);}}.bind(this));},_storeState:function(a){a.vis=this.visibility?1:0;a.vct=this._lastVisibilityChangeTime;a.bls=this.getSetting('sticky_buddylist');a.blc=this.getSetting('compact_buddylist');a.snd=this.getSetting('sound');return a;},_loadState:function(b){if(!this._chatConfig.get('blackbird')){var a=verifyNumber(b.vct);var c=Math.max(Env.rep_lag,this._chatConfig.get('presence_cookie_setting_cache_window'));if(new Date()-a<c&&this._lastVisibilityChangeTime<a){if(b.vis!=this.visibility){this._jslog.log('vis_load',{new_vis:b.vis});this.setVisibility(!!b.vis);}this._lastVisibilityChangeTime=a;}}this.setSetting('sticky_buddylist',b.bls);this.setSetting('compact_buddylist',b.blc);this.setSetting('sound',b.snd);},setVisibility:function(a){if(a===this.visibility)return;this.visibility=a;this._lastVisibilityChangeTime=Date.now();Arbiter.inform('chat/visibility-changed',{sender:this});this._presenceState.doSync();},_onVisibilityResponse:function(a){this._jslog.log('vis_send_success',{new_vis:a});if(a)this.setVisibility(a);},_onVisibilityError:function(a){this._jslog.log('vis_send_error',{old_vis:a});this.setVisibility(a);},toggleVisibility:function(){this.sendVisibility(!this.visibility);},sendVisibility:function(a){require.ensure(['PresenceUtil'],function(b){this._jslog.log('vis_send',{old_vis:this.visibility,new_vis:a});if(this.visibility==a)return;var c={visibility:a,notify_ids:Chat.getActiveFriendChats(),window_id:b.getSessionID()};if(!a)this.setVisibility(a);new AsyncRequest('/ajax/chat/visibility.php').setHandler(this._onVisibilityResponse.shield(this,a)).setErrorHandler(this._onVisibilityError.shield(this,!a)).setData(c).setAllowCrossPageTransition(true).send();Arbiter.inform(a?'chat/connect':'chat/disconnect');}.bind(this));},getSetting:function(a){return this.settings[a];},setSetting:function(a,b){if(this.getSetting(a)==b)return;this.settings[a]=b;Arbiter.inform('chat/option-changed',{name:a,value:b});}};
__e("ChatVisibility",["arbiter","ChatConfig","JSLogger","PresencePrivacy"],function(g,i,h,f){var a=i('arbiter');var b=i('ChatConfig');var d=i('JSLogger');var e=i('PresencePrivacy');var c={isOnline:function(){if(b.get('blackbird'))return e.getVisibility()===e.ONLINE;return window.chatOptions&&window.chatOptions.visibility;},goOnline:function(j){if(b.get('blackbird')){e.subscribe('initialized',function(){if(e.getVisibility()===e.OFFLINE){d.create('blackbird').log('chat_go_online');e.setVisibility(e.ONLINE);}j&&j();});return;}a.subscribe('chat-options/initialized',function(event,k){if(k.visibility){j&&j();}else{if(j)var l=a.subscribe('chat/visibility-changed',function(){a.unsubscribe(l);j();});k.sendVisibility(true);}});},canGoOffline:function(){var j=a.inform('live_listen_chat/go_offline');if(j===false){d.create('music_live_listen').log('can_go_offline',false);return false;}return true;},goOffline:function(j){if(!this.canGoOffline())return;if(b.get('blackbird')){e.subscribe('initialized',function(){if(e.getVisibility()===e.ONLINE){d.create('blackbird').log('chat_go_offline');e.setVisibility(e.OFFLINE);}j&&j();});return;}a.subscribe('chat-options/initialized',function(event,k){if(k.visibility){if(j)var l=a.subscribe('chat/visibility-changed',function(){a.unsubscribe(l);j();});k.sendVisibility(false);}else j&&j();});},toggleVisibility:function(){if(c.isOnline()){c.goOffline();}else c.goOnline();}};g.ChatVisibility=h.exports=c;},3);
__e("ShortProfiles",["arbiter","ArrayUtils","JSLogger","ObjectUtils","AsyncRequest","Env","util","copyProperties","MercuryRequireEnsure"],function(za,zc,zb,z){var a=zc('arbiter');var b=zc('ArrayUtils');var e=zc('JSLogger');var g=zc('ObjectUtils');var c=zc('AsyncRequest');var d=zc('Env');var k=zc('util');var y=zc('copyProperties');var f=zc('MercuryRequireEnsure');var w={};var l=new a();var m=[];var q=false;var s=false;var t=e.create('short_profiles');function n(){if(!m.length||q)return;q=true;o.defer();}function x(zd){var ze=[];b.createFrom(zd).forEach(function(zf){var zl={};for(var zi=0,zk=zf.ids.length;zi<zk;zi++){var zj=zf.ids[zi];if(w[zj]){zl[zj]=w[zj];}else{zl=null;break;}}if(zl){var zm={};for(var zg in zl)zm[zg]=y({},zl[zg]);try{zf.fun(zm);}catch(zh){t.error('callback_error',{message:zh.message,stack:zh.stack});}}else ze.push(zf);});return ze;}function r(){q=false;n();}var i='/ajax/chat/user_info.php';var j='/ajax/chat/user_info_all.php';function o(ze){l.inform('fetch');var zd=x(m);m=[];if(!zd.length){r();return;}var zg={};zd.forEach(function(zh){zh.ids.forEach(function(zi){if(!w[zi])zg[zi]=true;});});var zf=g.getKeys(zg);new c(i).setData({ids:zf}).setHandler(function(zh){v(zh,zd);}).setErrorHandler(u).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}function v(zf,zd){for(var ze in zf.payload){var zh=zf.payload[ze];if(!zh.type)zh.type='friend';w[ze]=zh;}if(zd)x(zd);m=x(m);r();l.inform('updated');var zg=zf.getRequest().uri.getPath();if(zg==i){t.log('fetch_response');}else if(zg==j)t.log('fetch_response_all');}function u(){t.error('fetch_error');r();}function p(){if(!s){t.log('fetch_all');s=true;new c(j).setData({viewer:d.user}).setHandler(v).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}}var h=y(l,{get:function(ze,zd){this.getMulti([ze],function(zf){zd(zf[ze],ze);});},getMulti:function(zf,ze){var zd={ids:zf,fun:ze};var zg=x([zd]);if(zg.length){m.push(zd);n();}},getNow:function(zd){var ze=w[zd];if(ze)return y({},ze);return null;},getCachedProfileIDs:function(){return keys(w);},hasAll:function(){return s;},fetchAll:function(){p();},set:function(zd,ze){var zf=w[zd];if(zf&&(zf.name!=ze.name||zf.firstName!=ze.firstName||zf.thumbSrc!=ze.thumbSrc))t.warn('changed',{oldInfo:zf,newInfo:ze});w[zd]=y({},ze);},setMulti:function(zd){for(var ze in zd)this.set(ze,zd[ze]);}});f.ensure(['InitialChatUserInfos'],function(zd){h.setMulti(zd);});za.ShortProfiles=zb.exports=h;},3);
__e("Chat",["arbiter","async-signal","JSLogger","ObjectUtils","PresencePrivacy"],function(k,m,l,j){var a=m('arbiter');var b=m('async-signal');var d=m('JSLogger');var e=m('ObjectUtils');var f=m('PresencePrivacy');function h(o,p){if(p&&p=='ordered_list'||p=='more_online_friends'||p=='online_friends'||p=='typeahead'){var n={target:o,source:p};new b('/ajax/chat/ct.php',n).send();}}var g={chatDisplay:'chat-display/loaded',buddyListDisplay:'buddylist-display/initialized',buddyListNub:'buddylist-nub/initialized',sidebar:'sidebar/initialized'};function i(o,n){a.subscribe(g[o],function(event,p){n(p);});}var c={openTab:function(n,o,q,p){if(window.External&&window.External.Chat&&window.External.Chat.openWindow)window.External.Chat.openWindow(n);h(n,p);i('chatDisplay',function(r){r.focusTab(n,true,o,o,q);});},openMultichatTab:function(q,o,n,r,s,p){i('chatDisplay',function(t){t.createMultichatTab(q,o,n,r,s,true,p);});},loadTabFragile:function(o,p,n,q){m.ensure(['ChatConfig'],function(r){if(r.get('mercury_integration')){m.ensure(['ChatController'],function(s){s.raiseFragileGroupTab(o);});}else i('chatDisplay',function(s){s.loadTabFragile(o,p,n,q);});});},openBuddyList:function(){i('buddyListNub',function(n){n.show();i('sidebar',function(o){o.enable();});});},closeBuddyList:function(){i('buddyListNub',function(n){n.hide();});},toggleSidebar:function(){i('sidebar',function(n){n.toggle();});},goOnline:function(n){m.ensure(['ChatVisibility'],function(o){o.goOnline(n);});},isOnline:function(){var n=null;m.ensure(['ChatVisibility'],function(o){n=o;});return n&&n.isOnline();},squelchTab:function(n,o){m.ensure(['ChatConfig'],function(p){if(p.get('mercury_integration')){m.ensure(['ChatTabPolicy','MercuryThreads'],function(q,r){var s=r.getCanonicalThreadToUser(n);q.squelch(s.thread_id);});}else i('chatDisplay',function(q){q.setSquelchedTab(n,true);q.closeTab(n);});});},unsquelchTab:function(n){i('chatDisplay',function(o){o.setSquelchedTab(n,false);});},getActiveChats:function(){if(!window.chatDisplay)return [];return e.getKeys(window.chatDisplay.tabs);},hasFocusedChat:function(){return window.chatDisplay&&window.chatDisplay.hasFocusedTab();},getActiveFriendChats:function(){var n=this.getActiveChats();return n.filter(function(o){return window.chatDisplay&&window.chatDisplay.tabs[o]&&window.chatDisplay.tabs[o].getPostType()=='friend';});},getLogger:function(n){return d.create(n);}};k.Chat=l.exports=c;},3);
__e("ServerTime",["PresenceInitialData"],function(e,g,f,d){var a=g('PresenceInitialData');var b;function c(h){b=Date.now()-h;}c(a.serverTime);e.ServerTime=f.exports={get:function(){return Date.now()-b;},getSkew:function(){return b;},update:function(h){c(h);}};},3);
__e("AvailableList",["arbiter","AvailableListConstants","ChannelConnection","ChannelConstants","ChannelManager","Chat","ChatConfig","copyProperties","Env","isEmpty","JSLogger","ObjectUtils","Poller","PresencePrivacy","PresenceUtil","ServerTime","ShortProfiles","UserActivity","AvailableListInitialData"],function(zh,zzb,zs,zf){var a=zzb('arbiter');var c=zzb('AvailableListConstants');var e=zzb('ChannelConnection');var f=zzb('ChannelConstants');var g=zzb('ChannelManager');var h=zzb('Chat');var i=zzb('ChatConfig');var ze=zzb('copyProperties');var j=zzb('Env');var zl=zzb('isEmpty');var l=zzb('JSLogger');var q=zzb('ObjectUtils');var r=zzb('Poller');var s=zzb('PresencePrivacy');var t=zzb('PresenceUtil');var v=zzb('ServerTime');var w=zzb('ShortProfiles');var x=zzb('UserActivity');var m=5;var p=60000;var u='/ajax/chat/buddy_list.php';var o=5000;var n=1800000;var d=.005;var zzc=0;var zt=0;var zza=false;var zy=null;var zp=null;var zq=null;var zd=null;var zo=0;var zn=0;var zz={};var zm=false;var zx={};var zw={};var zr={};var y=l.create('available_list');var b=ze({},c);function zg(zzi){var zzj=zzi||x.isActive(zq);return h.isOnline()?(zzj?zy:zp):null;}function z(zzk,zzi){var zzj=null;switch(zzk){case c.OFFLINE:zzj='offline';break;case c.IDLE:zzj='idle';break;case c.ACTIVE:zzj='active';break;case c.MOBILE:zzj='mobile';break;}y.rate(zzj,zzi);}function zzd(){zd=null;a.inform(c.ON_AVAILABILITY_CHANGED);}function zb(zzi,zzm,zzj,zzl){if(zzi==j.user)return;switch(zzm){case c.OFFLINE:case c.IDLE:case c.ACTIVE:case c.MOBILE:break;default:return;}var zzk=b.get(zzi)!=zzm;if(zzj){zx[zzi]=v.get();zw[zzi]=zzl;}zz[zzi]=zzm;if(zzk){zzc++;if(!zd)zd=zzd.defer();z(zzm,zzj);}}function zzf(zzi){zn=new Date();zr=Object.from(zzi);}function zzh(){if(b.haveFullList)a.inform(c.ON_UPDATED,b);}function zu(zzi){if(t.checkMaintenanceError(zzi))return;zt++;zza=false;if(zt>=m)a.inform(c.ON_UPDATE_ERROR);}function zv(zzl){var zzk=zzl.getPayload();var zzi=zzk.buddy_list;if(!zzi){zu(zzl);return;}v.update(zzk.time);b.updateTime=v.get();zt=0;zza=false;if(zzi.forcedRender)b.haveFullList=true;if(zzi.mobile_friends!=null)zzf(zzi.mobile_friends);var zzn=zzi.userInfos;if(zzn)w.setMulti(zzn);var zzj=zzi.nowAvailableList;var zzo=[];for(var zzm in zz)if(b.get(zzm)!==b.OFFLINE)zzo.push(zzm);zzo.forEach(function(zzp){z(b.OFFLINE,false);zz[zzp]=b.OFFLINE;});zm=zzi.userIsIdle;zzj&&b.addLegacyAvailableList(zzj);zx={};zw={};if(zzi.newAvailableList){b.presenceData=zzi.newAvailableList;b.haveFullList=true;}zzg();zzd();zzh();}function zze(zzk){if(g.isShutdown()||!h.isOnline()){b._poller.stop();return;}zo=new Date();var zzj=false;if(new Date()-zn>n)zzj=true;zza=true;var zzi=w.getCachedProfileIDs();zzk.setHandler(zv).setErrorHandler(zu).setOption('suppressErrorAlerts',true).setOption('retries',1).setData({user:j.user,available_user_info_ids:zzi,fetch_mobile:zzj}).setURI(u).setAllowCrossPageTransition(true);}function zc(zzi,zzk){for(var zzj in zzi){var zzm;var zzl;if(zzk){zzm=c.legacyStatusMap[zzi[zzj].ol];zzl=zzi[zzj].s;}else if(!zzi[zzj]){zzm=c.OFFLINE;}else if(zzi[zzj].i){zzm=c.IDLE;}else if(zzi[zzj].m){zzm=c.MOBILE;}else zzm=c.ACTIVE;zb(zzj,zzm,zzk,zzl);}}function zzg(zzi){var zzj=zg(zzi);y.debug('update_poller',zzj);b._poller&&b._poller.setTimePeriod(zzj);}function za(){b.haveFullList=false;zo=0;zn=0;zz={};zw={};zx={};zr={};zzc++;zzd();}function zk(){zzg();if(h.isOnline()){b.update();}else za();}function zi(){zzg();if(b._channelConnection.disconnected()){za();}else if(!b.haveFullList)b.update();}function zj(zzj,zzi){zzi.chat_config=i.getDebugInfo();zzi.available_list_debug_info={};b.getAvailableIDs().forEach(function(zzk){zzi.available_list_debug_info[zzk]=b.getDebugInfo(zzk);});zzi.available_list_poll_interval=b._poller&&b._poller.getTimePeriod();}ze(b,{haveFullList:false,init:function(zzq,zzk,zzp,zzo,zzl,zzi,zzj,zzn,zzm){this._chatConfig=i;this._channelConnection=e;b.updateTime=zzq;b.haveFullList=zzk;if(zzk&&zzn)zzf(zzn);b.addLegacyAvailableList(zzi);zy=zzo;zp=zzl;zq=zzm||300000;b._poller=new r(zg(),zze,true);a.subscribe('chat-visibility/initialized',function(zzr){y.log('visibility_init',zzr);zzg(true);});a.subscribe(l.DUMP_EVENT,zj);a.subscribe(f.ON_CONNECT,b.update);x.subscribe(function(zzs,zzr){if(zzr.idleness>zy){y.debug('update_activity');b.update();}});if(i.get('blackbird')){s.subscribe('privacy-changed',zzd);s.subscribe('privacy-availability-changed',function(zzs,zzr){for(var zzt in zzr.user_availabilities)this.set(zzt,zzr.user_availabilities[zzt]);}.bind(this));s.subscribe('privacy-user-presence-response',b.update);}else a.subscribe('chat/visibility-changed',zk);if(i.get('channel_disconnect_warning'))this._channelConnection.subscribe([this._channelConnection.CONNECTED,this._channelConnection.RECONNECTING,this._channelConnection.SHUTDOWN,this._channelConnection.MUTE_WARNING,this._channelConnection.UNMUTE_WARNING],zi);if(b.haveFullList)zo=new Date();a.inform.bind(a,c.ON_INITIALIZED,b,a.BEHAVIOR_PERSISTENT).defer();this.init=bagofholding;},get:function(zzi){if(zzi==j.user)return c.ACTIVE;var zzj=c.OFFLINE;if(zzi in zz)zzj=zz[zzi];if(this._chatConfig&&this._chatConfig.get('blackbird')&&!s.allows(zzi))zzj=c.OFFLINE;if(zzj==c.OFFLINE)if(zr[zzi])zzj=c.MOBILE;return zzj;},isUserIdle:function(){return zm;},isReady:function(){return b.haveFullList;},set:function(zzi,zzk,zzj){zb(zzi,zzk,true,null,zzj);},update:function(){if(new Date()-zo<o){!zza&&zzh.defer();return;}b._poller&&b._poller.requestNow();},getRev:function(){return zzc;},isIdle:function(zzi){return b.get(zzi)==c.IDLE;},getOnlineIDs:function(){var zzi,zzj=[];for(zzi in zz)if(b.get(zzi)===c.ACTIVE)zzj.push(zzi);return zzj;},getAvailableIDs:function(){var zzj=b.getOnlineIDs();var zzi;for(zzi in zr){if(zzi in zz)continue;zzj.push(zzi);}return zzj;},getOnlineCount:function(zzi){if(zzi&&!b.haveFullList)return 0;return b.getOnlineIDs().length;},addLegacyOverlay:function(zzi){zc(zzi,true);},addLegacyAvailableList:function(zzi){zc(zzi,false);},getDebugInfo:function(zzi){var zzj;if(window.ShortProfiles){var zzk=w.getNow(zzi);if(zzk)zzj=zzk.name;}return {id:zzi,presence:zz[zzi],overlaySource:zw[zzi],overlayTime:zx[zzi],overlaySource:zw[zzi],mobile:zr[zzi],name:zzj};}});var k=zzb('AvailableListInitialData');b.init(k.updateTime,true,k.updateOverlay,k.pollInterval,k.lazyPollInterval,k.availableList,k.availableCount,k.mobileFriends,k.lazyThreshold);zh.AvailableList=zs.exports=b;});
var ChatQuietLinks={silence:function(b){if(ua.firefox()>=4||ua.chrome())var a=Event.listen(document,'mousemove',function(){this._removeLinkHrefs(b);a.remove();}.bind(this));},_removeLinkHrefs:function(d){var c=DOM.scry(d,'a');for(var b=0;b<c.length;b++){var a=c[b].getAttribute('href');if(!a||a.charAt(0)=='#')c[b].removeAttribute('href');}}};
__e("GroupChatController",["arbiter","Chat","ChatConfig","dom","css-core","PageTransitions"],function(i,k,j,h){var a=k('arbiter');var c=k('Chat');var d=k('ChatConfig');var e=k('dom');var b=k('css-core');var g=k('PageTransitions');function f(m,n,o){_goOnlineText=e.find(m,'.fbGroupChatGoOnline');_chatWithGroupText=e.find(m,'.fbGroupChatOpenTab');function l(){if(c.isOnline()){b.hide(_goOnlineText);b.show(_chatWithGroupText);}else{b.hide(_chatWithGroupText);b.show(_goOnlineText);}}_visibilitySubscription=a.subscribe('chat/visibility-changed',l);g.registerHandler(a.unsubscribe.bind(a,_visibilitySubscription));Event.listen(m,'click',function(){if(d.get('mercury_integration')){k.ensure(['ChatController'],function(p){p.raiseGroupTab(n);});}else c.goOnline(function(){c.openTab(n,o,'group');});});}j.exports=f;});
var ChatSidebar=window.ChatSidebar||(function(){var c=null;var a=null;var b=null;var e;var l=false;var m=false;var o=false;var n=false;var s;var r;var u;var y;var z;var q;var f=null;var w=null;var za=null;var p=JSLogger.create('blackbird');var d=32;function h(zb){switch(zb){case b.HINT_AUTH:return "Your session has timed out. Please log in.";case b.HINT_CONN:return _tx("Facebook {Chat} is currently unavailable.",{Chat:"Chat"});case b.HINT_MAINT:return _tx("Facebook {Chat} is currently down for maintenance.",{Chat:"Chat"});default:return _tx("Facebook {Chat} is currently unavailable.",{Chat:"Chat"});}}function g(zc){var zd;if(zc>c.get('warning_countdown_threshold_msec')){var zb=$N('a',{href:'#',className:'fbChatReconnectLink'},"Try again");zd=DOM._tx("Unable to connect to chat. {try-again-link}",{'try-again-link':zb});}else if(zc>1000){zd=_tx("Unable to connect to chat. Reconnecting in {seconds}...",{seconds:Math.floor(zc/1000)});}else zd="Unable to connect to chat. Reconnecting...";return zd;}function i(zd,zb){if(w){clearTimeout(w);w=null;}if(zd===a.SHUTDOWN){f=h(zb);}else if(zd===a.CONNECTED){f=null;}else if(zd===a.RECONNECTING){var zc=zb;f=g(zc);if(zc>1000){if(zc>c.get('warning_countdown_threshold_msec')){if(za){za.remove();za=null;}za=Event.listen(r,'click',function(event){if(CSS.hasClass(event.getTarget(),'fbChatReconnectLink')){a.reconnect();return false;}});}w=setTimeout(bind(null,i,zd,zc-1000),1000,false);}}j();}function j(){var zf=ChatVisibility.isOnline();var zb=false;if(!zf){var zc='fbChatGoOnlineLink';var ze=c.get('blackbird')?"Go online":"available";var zd=$N('a',{href:'#',className:zc},ze);var zg=c.get('blackbird')?DOM._tx("{=Go online} to see who's online to chat.",{'=Go online':zd}):DOM._tx("You are unavailable to chat. Let friends see you as {=available}?",{'=available':zd});DOM.setContent(r,zg);Event.listen(r,'click',function(event){if(CSS.hasClass(event.getTarget(),zc)){if(Chat.isOnline()){p.error('sidebar_go_online_while_online');p.rate('sidebar_go_online_error',c.get('blackbird'));}p.rate('sidebar_go_online',c.get('blackbird'));Chat.goOnline();return false;}});CSS.addClass(u,'offline');}else{CSS.removeClass(u,'offline');DOM.empty(r);if(a.disconnected()){CSS.addClass(u,'error');DOM.setContent(r,f);}else CSS.removeClass(u,'error');}t();}function k(){if(!ChatSidebar.isVisible()&&n)return;o=false;CSS.hide(u);CSS.removeClass(document.documentElement,'sidebarMode');s.hide();y.getCore().reset();p.rate('sidebar_hide',n);Arbiter.inform('sidebar/hide',ChatSidebar);}function t(){OrderedFriendsList.subscribe('initialized',function(){var zc=ChatSidebar.shouldShowSidebar();CSS.conditionClass(document.documentElement,'sidebarCapable',zc);if(ChatSidebar.isEnabled()&&zc){CSS.setStyle(u,'height',z.y+'px');v();var zb=z.y;$A(u.childNodes).forEach(function(zd){if(zd!==e)zb-=Vector2.getElementDimensions(zd).y;});CSS.setStyle(e,'height',zb+'px');this._maxItems=Math.floor((zb-8)/d);s.setNumTopFriends(this._maxItems);y.getData().setMaxResults(this._maxItems);Arbiter.inform('sidebar/resized',ChatSidebar);}else k();n=true;});}function v(){if(ChatSidebar.isVisible())return;o=true;CSS.show(u);CSS.addClass(document.documentElement,'sidebarMode');s.show();p.rate('sidebar_show',n);Arbiter.inform('sidebar/show',ChatSidebar);}function x(){chatOptions.setSetting('sidebar_mode',ChatSidebar.isEnabled());new AsyncRequest('/ajax/chat/settings.php').setHandler(bagofholding).setErrorHandler(bagofholding).setData({sidebar_mode:ChatSidebar.isEnabled()}).setAllowCrossPageTransition(true).send();}return {init:function(zc,zb,zd){ChatSidebar.init=bagofholding;require.ensure(['ChatConfig','ChannelConnection','ChannelConstants','ChatVisibility','PresencePrivacy'],function(zg,ze,zf,zh,zi){c=zg;a=ze;b=zf;ChatVisibility=zh;PresencePrivacy=zi;u=zc;s=zb;y=zd;e=DOM.find(zc,'div.fbChatSidebarBody');r=DOM.find(zc,'div.fbChatSidebarMessage div.message');zb.setScrollContainer(DOM.find(e,'div.uiScrollableAreaWrap'));zb.subscribe(['render','show','hide'],debounce(function(){var zj=zb.getRoot();var zk=ScrollableArea.getInstance(zj);zk&&zk.adjustGripper();}));ChatQuietLinks.silence(zc);Event.listen(window,'resize',t);Arbiter.subscribe('chat/option-changed',function(zk,zj){if(zj.name=="sidebar_mode"){l=!!chatOptions.getSetting('sidebar_mode');t();}});zd.subscribe(['respond','reset'],function(zj,zk){if(o)if(zk&&zk.value&&zk.value===zd.getCore().getValue()&&zd.getView().isVisible()){s.hide();}else s.show();});zd.getData().subscribe('beforeQuery',t);a.subscribe([a.CONNECTED,a.SHUTDOWN],i);if(c.get('channel_disconnect_warning')){a.subscribe(a.RECONNECTING,i);a.subscribe([a.MUTE_WARNING,a.UNMUTE_WARNING],j);}Arbiter.subscribe('buddylist-nub/initialized',function(zj,zk){Event.listen(zk.getButton(),'click',function(event){ChatSidebar.enable();return !ChatSidebar.shouldShowSidebar();});});Arbiter.subscribe('chat-options/initialized',function(zj,zk){l=!!zk.getSetting('sidebar_mode');Arbiter.subscribe('chat-visibility/initialized',function(zl){p.rate('sidebar_vis_init',c.get('blackbird'));j();Arbiter.subscribe('chat/visibility-changed',j);if(c.get('blackbird'))PresencePrivacy.subscribe('privacy-user-presence-changed',j);Arbiter.inform('sidebar/initialized',ChatSidebar,Arbiter.BEHAVIOR_PERSISTENT);});});});},disable:function(){if(!ChatSidebar.isEnabled())return;l=false;x();k();},enable:function(){if(ChatSidebar.isEnabled())return;l=true;x();t();!function(){if(ChatSidebar.isVisible())y.getCore().getElement().focus();}.defer();},hide:function(){m=true;k();},unhide:function(){m=false;t();},getBody:function(){return e;},getRoot:function(){return u;},getVisibleWidth:function(){return u&&u.offsetWidth||0;},isEnabled:function(){return l;},isViewportCapable:function(){z=Vector2.getViewportDimensions();return z.x>c.get('sidebar.minimum_width');},shouldShowSidebar:function(){return ChatSidebar.isViewportCapable()&&!m&&OrderedFriendsList.getList().length>c.get('sidebar.min_friends')&&!FbDesktopPlugin.shouldSuppressSidebar();},isVisible:function(){return o;},resize:t,toggle:function(){ChatSidebar.isEnabled()?ChatSidebar.disable():ChatSidebar.enable();}};})();
function VideoEvents(){}Function.mixin(VideoEvents,'Arbiter',{ACTIVATING:'videochat/activating',LOGGING_IN:'videochat/logging_in',GETTING_TOKEN:'videochat/getting_token',CONNECTING:'videochat/connecting',SLOW_CONDITIONS:'videochat/slow_conditions',CALL_INCOMING:'videochat/call_incoming',CALL_CONNECTED:'videochat/call_connected',GOT_CALLEE:'videochat/got_callee',CALL_HANDLED:'videochat/call_handled',CALLEE_ANSWERING:'videochat/callee_answering',FATAL_ERROR:'videochat/fatal_error',CALL_IN_PROGRESS:'videochat/call_in_progress',NOT_AVAILABLE:'videochat/not_available',SERVER_ERROR:'videochat/server_error',ACTIVATE_FAILED:'videochat/activate_failed',ACTIVATE_TIMED_OUT:'videochat/activate_failed_time',WRONG_VERSION_ERROR:'videochat/wrong_version',FATAL_PLUGIN_ERROR:'videochat/plugin_fatality',SILENT_PLUGIN_ERROR:'videochat/plugin_silent_fatality',START_CALL_UI:'videochat/start_call_ui',START_CALL:'videochat/start_call',ANSWER_CALL:'videochat/answer_call',IGNORE_CALL:'videochat/ignore_call',CANCEL_CALL:'videochat/cancel_call',INSTALL_STARTED:'videochat/install_started',INSTALL_COMPLETED:'videochat/install_completed',log:function(a){window.console&&console.log&&console.log(a);},warn:function(a){window.console&&console.warn&&console.warn(a);},error:function(a){window.console&&console.error&&console.error(a);}});
var VideoChatPlugin=function(){};Function.mixin(VideoChatPlugin,'Arbiter',{INSTALL_TYPES:{JAVA:0,MANUAL:1},isSupported:function(){var b=ua.windows()&&((ua.ie()>=7&&!ua.ie64())||ua.firefox()>=3.6||ua.chrome()>=5);var a=(ua.osx()>10.4)&&(ua.firefox()>=3.6||ua.chrome()>=5||ua.safari()>=500);return (b||a);},notifyFromApplet:function(b,a){Arbiter.inform(String(b),{args:String(a)});},isInstalled:function(){var a=false;if(VideoChatPlugin.isSupported())if(VideoChatPlugin.usesActiveX()){var c=null;try{c=new ActiveXObject('SkypeLimited.SkypeWebPlugin');a=!!c;}catch(b){}c=null;}else a=VideoChatPlugin._getInstalledVersion();return a;},usesActiveX:function(){return ua.ie()&&ua.windows()&&!ua.opera();},setLogger:function(a){VideoChatPlugin.log=a||bagofholding;},embed:function(a){Bootloader.loadComponents('VideoChatPluginCore',function(){VideoChatPlugin.embed(a);});},remove:bagofholding,_getInstalledVersion:function(){if(!navigator)return null;navigator.plugins.refresh(false);mimeHandler=navigator.mimeTypes['application/skypesdk-plugin'];return mimeHandler&&mimeHandler.enabledPlugin;}});
var VideoChatView={RINGTONE_PATH:'/sound/bling.mp3',WINDOW_NAME_COOKIE_KEY:'vcpwn',TARGET_ID_COOKIE_KEY:'vctid',inIncomingCall:false,inOutgoingCall:false,inManualInstall:false,tokens:[],init:function(){VideoChatView.subscribe(VideoEvents.CALL_INCOMING,VideoChatView._onIncomingCall);VideoChatView.subscribe(VideoEvents.START_CALL_UI,function(a,b){if(!VideoChatView.inOutgoingCall){VideoChatView.inOutgoingCall=true;if(VideoChatPlugin.isInstalled()){VideoChatView.onOutgoingCall(b.idTarget);}else VideoChatView._invokeCore('promptInstall',b.idTarget);}});if(VideoChatPlugin.isSupported())CSS.addClass(document.documentElement,'videoCallEnabled');onbeforeunloadRegister(function(){if((VideoChatView.inIncomingCall||VideoChatView.inOutgoingCall)&&!VideoChatView.inManualInstall)return "Leaving this page will end your call.";});onleaveRegister(function(){if(VideoChatView.inIncomingCall||VideoChatView.inOutgoingCall){VideoEvents.inform(VideoEvents.CANCEL_CALL,{cause:'leave:page'});VideoChatView.inIncomingCall=false;VideoChatView.inOutgoingCall=false;}});VideoChatView._checkPriorState();},subscribe:function(b,a){VideoChatView.tokens.push(VideoEvents.subscribe(b,a));},onProfileButtonClick:function(a){VideoChatView._invokeCore('onProfileButtonClick',a);},unload:function(){while(VideoChatView.tokens.length)VideoEvents.unsubscribe(VideoChatView.tokens.pop());},mightReloadPostInstall:function(){return ua.windows();},_showDialog:function(b,a){new Dialog().setAllowCrossPageTransition(true).setTop(a?85:125).setAsync(new AsyncRequest(b)).show();},_onIncomingCall:function(a,b){VideoChatView.inIncomingCall=true;VideoChatView._showDialog(URI('/ajax/chat/video/incoming_call.php').setQueryData({idTarget:b.idTarget,callId:b.callId}),true);},onOutgoingCall:function(a){VideoChatView.inOutgoingCall=true;VideoChatView._showDialog('/ajax/chat/video/outgoing_call.php?idTarget='+a);},_checkPriorState:function(){if(VideoChatView.mightReloadPostInstall()){var a=getCookie(VideoChatView.WINDOW_NAME_COOKIE_KEY);if(a){clearCookie(VideoChatView.WINDOW_NAME_COOKIE_KEY);var b=getCookie(VideoChatView.TARGET_ID_COOKIE_KEY);if(b){clearCookie(VideoChatView.TARGET_ID_COOKIE_KEY);if(getCookie(VideoChatView.TARGET_ID_COOKIE_KEY))return;if(VideoChatPlugin.isInstalled())VideoChatView.onOutgoingCall(b);}}}},_invokeCore:function(b){var a=Array.prototype.slice.call(arguments,1);Bootloader.loadComponents('VideoChatViewCore',function(){VideoChatView.initCore();VideoChatView[b].apply(VideoChatView,a);});}};
function PresenceIndicator(){}PresenceIndicator.prototype={init:function(b,a,d){this._id=b;this._firstname=a;this._tooltip=d;this._image=DOM.scry(this._tooltip,'i')[0];this._previousAvail=null;this._jslog=JSLogger.create('presence_indicator');Arbiter.subscribe('chat-visibility/initialized',function(e){this._jslog.log('vis_init',e);this._updateVisibility();}.bind(this));this._subscriptions=[Arbiter.subscribe([AvailableListConstants.ON_AVAILABILITY_CHANGED],this._updateAvailability.bind(this)),Arbiter.subscribe(['chat/visibility-changed'],this._updateVisibility.bind(this))];this._updateAvailability.bind(this).defer();var c=Event.listen(this._tooltip,'click',function(){require.ensure(['AvailableList'],function(e){if(this._previousAvail!=AvailableListConstants.OFFLINE)Chat.openTab(this._id);}.bind(this));}.bind(this));onleaveRegister(function(){c.remove();while(this._subscriptions.length)Arbiter.unsubscribe(this._subscriptions.pop());}.bind(this));},_updateAvailability:function(){require.ensure(['AvailableList','ChatConfig'],function(a,b){if(!a.isReady())return;var e;var d;var c=a.get(this._id);if(c===this._previousAvail)return;this._previousAvail=c;switch(c){case AvailableListConstants.OFFLINE:e=b.get('blackbird')?_tx("{name} is offline",{name:this._firstname}):_tx("{name} is unavailable",{name:this._firstname});d='offline';break;case AvailableListConstants.IDLE:e=_tx("{name} is idle",{name:this._firstname});d='idle';break;case AvailableListConstants.ACTIVE:e=b.get('blackbird')?_tx("{name} is online",{name:this._firstname}):_tx("{name} is available",{name:this._firstname});d='online';break;case AvailableListConstants.MOBILE:e=_tx("{name} is available on mobile",{name:this._firstname});d='mobile';break;default:throw new Error('Invalid availability');}TooltipLink.setTooltipText(this._tooltip,e);CSS.setClass(this._image,d);}.bind(this));},_updateVisibility:function(){if(Chat.isOnline()){CSS.show(this._tooltip);}else CSS.hide(this._tooltip);}};
function LiveMessageReceiver(a){this.eventName=a;this.subs=null;this.handler=bagofholding;this.shutdownHandler=null;this.restartHandler=null;this.registered=false;this.appId=1;}LiveMessageReceiver.prototype.setAppId=function(a){this.appId=a;return this;};LiveMessageReceiver.prototype.setHandler=function(a){this.handler=a;this._dirty();return this;};LiveMessageReceiver.prototype.setRestartHandler=function(a){this.restartHandler=a.shield();this._dirty();return this;};LiveMessageReceiver.prototype.setShutdownHandler=function(a){this.shutdownHandler=a.shield();this._dirty();return this;};LiveMessageReceiver.prototype._dirty=function(){if(this.registered){this.unregister();this.register();}};LiveMessageReceiver.prototype.register=function(){var b=function(d,c){return this.handler(c);}.bind(this);var a=PresenceMessage.getAppMessageType(this.appId,this.eventName);this.subs={};this.subs.main=Arbiter.subscribe(a,b);if(this.shutdownHandler)this.subs.shut=Arbiter.subscribe(channel.ON_SHUTDOWN,this.shutdownHandler);if(this.restartHandler)this.subs.restart=Arbiter.subscribe(PresenceMessage.RESTARTED,this.restartHandler);this.registered=true;return this;};LiveMessageReceiver.prototype.unregister=function(){if(!this.subs)return this;for(var a in this.subs)if(this.subs[a])Arbiter.unsubscribe(this.subs[a]);this.subs=null;this.registered=false;return this;};LiveMessageReceiver.route=function(b){var a=function(c){var d=PresenceMessage.getAppMessageType(b.app_id,b.event_name);Arbiter.inform(d,c,Arbiter.BEHAVIOR_PERSISTENT);};if(b.hasCapture){new AsyncRequest().setHandler(function(c){a(c.getPayload());}).setAllowCrossPageTransition(true).handleResponse(b.response);}else a(b.response);};var init_live_message_receive=window.init_live_message_receive||function(){init_live_message_receive=bagofholding;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('app_msg'),function(a,b){if(b.obj.event_name=='beep_event'){Bootloader.loadComponents('beeper',function(){Beeper.ensureInitialized();LiveMessageReceiver.route(b.obj);});}else LiveMessageReceiver.route(b.obj);});};