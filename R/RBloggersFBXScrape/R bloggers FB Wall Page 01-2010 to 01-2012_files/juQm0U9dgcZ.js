/*1325568587,169775556*/

if (window.CavalryLogger) { CavalryLogger.start_js(["\/aY9u"]); }

var GenderConst={UNKNOWN:0,FEMALE_SINGULAR:1,MALE_SINGULAR:2,FEMALE_SINGULAR_GUESS:3,MALE_SINGULAR_GUESS:4,MIXED_SINGULAR:5,MIXED_PLURAL:5,NEUTER_SINGULAR:6,UNKNOWN_SINGULAR:7,FEMALE_PLURAL:8,MALE_PLURAL:9,NEUTER_PLURAL:10,UNKNOWN_PLURAL:11};
__e("notifications-counter",["arbiter","DocumentTitle","JSLogger"],function(f,h,g,e){var a=h('arbiter');var b=h('DocumentTitle');var c=h('JSLogger');var d={messages:0,notifications:0,requests:0};f.NotificationCounter=g.exports={init:function(){a.subscribe('update_title',this._handleUpdate.bind(this));a.subscribe('jewel/count-updated',this._handleCountUpdate.bind(this));},getCount:function(){var j=0;for(var k in d){var i=Number(d[k]);if(typeof d[k]=='string'&&isNaN(i))return d[k];if(isNaN(i)||i<0){c.create('jewels').error('bad_count',{jewel:k,count:d[k]});continue;}j+=i;}return j;},updateTitle:function(){var j=this.getCount();var i=b.get();i=j?'('+j+') '+i:i;b.set(i,true);},_handleCountUpdate:function(j,i){d[i.jewel]=i.count;this.updateTitle();},_handleUpdate:function(j,i){this.updateTitle();}};},3);
var ConnectDialog={newInstance:function(i,o,f,e,g,a,k,l,j,n,h){var b=new Dialog();var m=new AsyncRequest().setURI('/ajax/profile/connect.php').setData({dialog:1,profile_id:i,source:o,pymk_score:k,pymk_source:l,pymk_page:j,show_confirmation_optout:n,precheck_confirmation_optout:h}).setFinallyHandler(function(){var p=b.getButtonElement('connect');if(p)p.focus();});for(var d in a)m.setContextData(d,a[d]);b.setAsync(m);var c={ondone_func:f,ondone_data:e,ondone_reload:g,pymk_score:k,pymk_source:l,pymk_page:j};ConnectDialog.prepare(b,c);return b;},prepare:function(a,b){copy_properties(a,b||{});a.setCloseHandler(ConnectDialog.deleteInstance);ConnectDialog.setInstance(a);},deleteInstance:function(){delete ConnectDialog.instance;},setInstance:function(a){ConnectDialog.instance=a;},getInstance:function(){return ConnectDialog.instance;}};
window.__UIControllerRegistry=window.__UIControllerRegistry||{};
/**
 * @provides md5
 * @option preserve-header
 *
 * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
 * Digest Algorithm, as defined in RFC 1321.
 * Version 2.2 Copyright (C) Paul Johnston 1999 - 2009
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for more info.
 */(function(){window.md5=function(o){return k(l(n(o)));};var g=0;function l(o){return a(b(j(o),o.length*8));}function k(r){try{g;}catch(o){g=0;}var p=g?"0123456789ABCDEF":"0123456789abcdef";var s="";var t;for(var q=0;q<r.length;q++){t=r.charCodeAt(q);s+=p.charAt((t>>>4)&15)+p.charAt(t&15);}return s;}function n(p){var q="";var o=-1;var r,s;while(++o<p.length){r=p.charCodeAt(o);s=o+1<p.length?p.charCodeAt(o+1):0;if(55296<=r&&r<=56319&&56320<=s&&s<=57343){r=65536+((r&1023)<<10)+(s&1023);o++;}if(r<=127){q+=String.fromCharCode(r);}else if(r<=2047){q+=String.fromCharCode(192|((r>>>6)&31),128|(r&63));}else if(r<=65535){q+=String.fromCharCode(224|((r>>>12)&15),128|((r>>>6)&63),128|(r&63));}else if(r<=2097151)q+=String.fromCharCode(240|((r>>>18)&7),128|((r>>>12)&63),128|((r>>>6)&63),128|(r&63));}return q;}function j(p){var q=Array(p.length>>2);for(var o=0;o<q.length;o++)q[o]=0;for(var o=0;o<p.length*8;o+=8)q[o>>5]|=(p.charCodeAt(o/8)&255)<<(o%32);return q;}function a(p){var q="";for(var o=0;o<p.length*32;o+=8)q+=String.fromCharCode((p[o>>5]>>>(o%32))&255);return q;}function b(y,t){y[t>>5]|=128<<((t)%32);y[(((t+64)>>>9)<<4)+14]=t;var o=1732584193;var p=-271733879;var q=-1732584194;var r=271733878;for(var s=0;s<y.length;s+=16){var u=o;var v=p;var w=q;var x=r;o=e(o,p,q,r,y[s+0],7,-680876936);r=e(r,o,p,q,y[s+1],12,-389564586);q=e(q,r,o,p,y[s+2],17,606105819);p=e(p,q,r,o,y[s+3],22,-1044525330);o=e(o,p,q,r,y[s+4],7,-176418897);r=e(r,o,p,q,y[s+5],12,1200080426);q=e(q,r,o,p,y[s+6],17,-1473231341);p=e(p,q,r,o,y[s+7],22,-45705983);o=e(o,p,q,r,y[s+8],7,1770035416);r=e(r,o,p,q,y[s+9],12,-1958414417);q=e(q,r,o,p,y[s+10],17,-42063);p=e(p,q,r,o,y[s+11],22,-1990404162);o=e(o,p,q,r,y[s+12],7,1804603682);r=e(r,o,p,q,y[s+13],12,-40341101);q=e(q,r,o,p,y[s+14],17,-1502002290);p=e(p,q,r,o,y[s+15],22,1236535329);o=f(o,p,q,r,y[s+1],5,-165796510);r=f(r,o,p,q,y[s+6],9,-1069501632);q=f(q,r,o,p,y[s+11],14,643717713);p=f(p,q,r,o,y[s+0],20,-373897302);o=f(o,p,q,r,y[s+5],5,-701558691);r=f(r,o,p,q,y[s+10],9,38016083);q=f(q,r,o,p,y[s+15],14,-660478335);p=f(p,q,r,o,y[s+4],20,-405537848);o=f(o,p,q,r,y[s+9],5,568446438);r=f(r,o,p,q,y[s+14],9,-1019803690);q=f(q,r,o,p,y[s+3],14,-187363961);p=f(p,q,r,o,y[s+8],20,1163531501);o=f(o,p,q,r,y[s+13],5,-1444681467);r=f(r,o,p,q,y[s+2],9,-51403784);q=f(q,r,o,p,y[s+7],14,1735328473);p=f(p,q,r,o,y[s+12],20,-1926607734);o=h(o,p,q,r,y[s+5],4,-378558);r=h(r,o,p,q,y[s+8],11,-2022574463);q=h(q,r,o,p,y[s+11],16,1839030562);p=h(p,q,r,o,y[s+14],23,-35309556);o=h(o,p,q,r,y[s+1],4,-1530992060);r=h(r,o,p,q,y[s+4],11,1272893353);q=h(q,r,o,p,y[s+7],16,-155497632);p=h(p,q,r,o,y[s+10],23,-1094730640);o=h(o,p,q,r,y[s+13],4,681279174);r=h(r,o,p,q,y[s+0],11,-358537222);q=h(q,r,o,p,y[s+3],16,-722521979);p=h(p,q,r,o,y[s+6],23,76029189);o=h(o,p,q,r,y[s+9],4,-640364487);r=h(r,o,p,q,y[s+12],11,-421815835);q=h(q,r,o,p,y[s+15],16,530742520);p=h(p,q,r,o,y[s+2],23,-995338651);o=i(o,p,q,r,y[s+0],6,-198630844);r=i(r,o,p,q,y[s+7],10,1126891415);q=i(q,r,o,p,y[s+14],15,-1416354905);p=i(p,q,r,o,y[s+5],21,-57434055);o=i(o,p,q,r,y[s+12],6,1700485571);r=i(r,o,p,q,y[s+3],10,-1894986606);q=i(q,r,o,p,y[s+10],15,-1051523);p=i(p,q,r,o,y[s+1],21,-2054922799);o=i(o,p,q,r,y[s+8],6,1873313359);r=i(r,o,p,q,y[s+15],10,-30611744);q=i(q,r,o,p,y[s+6],15,-1560198380);p=i(p,q,r,o,y[s+13],21,1309151649);o=i(o,p,q,r,y[s+4],6,-145523070);r=i(r,o,p,q,y[s+11],10,-1120210379);q=i(q,r,o,p,y[s+2],15,718787259);p=i(p,q,r,o,y[s+9],21,-343485551);o=m(o,u);p=m(p,v);q=m(q,w);r=m(r,x);}return Array(o,p,q,r);}function d(q,o,p,t,r,s){return m(c(m(m(o,q),m(t,s)),r),p);}function e(o,p,q,r,u,s,t){return d((p&q)|((~p)&r),o,p,u,s,t);}function f(o,p,q,r,u,s,t){return d((p&r)|(q&(~r)),o,p,u,s,t);}function h(o,p,q,r,u,s,t){return d(p^q^r,o,p,u,s,t);}function i(o,p,q,r,u,s,t){return d(q^(p|(~r)),o,p,u,s,t);}function m(q,r){var o=(q&65535)+(r&65535);var p=(q>>16)+(r>>16)+(o>>16);return (p<<16)|(o&65535);}function c(p,o){return (p<<o)|(p>>>(32-o));}})();
PageletCache=window.PageletCache||{libraryHash:'48c1e150e2f733fcc1fac1b62d944806',init:function(b){PageletCache._password=b;try{PageletCache._cache=window.localStorage;}catch(a){}PageletCache.loadCryptoLib();Arbiter.subscribe('pre_page_transition',PageletCache.cleanup);},loadCryptoLib:function(){var a=PageletCache._cache.getItem('crypto-lib');if(!a){Bootloader.loadComponents('async',function(){new AsyncRequest(PageletCache._crypto_url).setHandler(function(b){PageletCache.evalJS(b.payload);onafterloadRegister(function(){PageletCache._cache.setItem('crypto-lib',b.payload);});}).send();});}else{if(Math.random()<.1&&PageletCache.libraryHash!=md5(a)){PageletCache._cache.removeItem('crypto-lib');PageletCache.loadCryptoLib();return;}PageletCache.evalJS(a);}},evalJS:function(a){eval_global(a);Arbiter.inform('pagelet_cache_loaded',true,Arbiter.BEHAVIOR_STATE);},_processBeforeWrite:function(d){Bootloader.setResourceMap(d.resource_map);var a=(d.css||[]).concat(d.js||[]);for(var b in (d.bootloadable||{}))a.concat(d.bootloadable[b]);d.resource_map=d.resource_map||{};for(var c=0;c<a.length;c++){var e=a[c];if(!d.resource_map[e])d.resource_map[e]=Bootloader.resolveResources([e])[0];}if(d.cache_type=='overwrite'){delete d.onload;delete d.onafterload;delete d.jscc;delete d.jscc_map;delete d.jscalls;}},write:function(a){if(!PageletCache._cache||a.cache_type=='base')return;Arbiter.registerCallback(function(){var d={};var b={};copy_properties(b,a);try{PageletCache._processBeforeWrite(b);d[a.key]=b;var encrypted=sjcl.encrypt(PageletCache._password,JSON.stringify(d));PageletCache._cache.setItem(a.id,encrypted);PageletCache._pagelets[a.id]=b;}catch(c){window.Util&&false;}},['pagelet_cache_loaded']);},read:function(d,e){if(!PageletCache._cache)return null;if(d.substr(0,6)=='cached')d=d.substr(7);var a=PageletCache._cache.getItem(d);if(a){var c;try{var plain=sjcl.decrypt(PageletCache._password,a);c=JSON.parse(plain);}catch(b){window.Util&&false;}if(c&&c[e]){PageletCache._pagelets[d]=c[e];PageletCache._cache_hits[d]=true;return c[e];}}},bustcache:function(){Bootloader.loadComponents(['uri','cookie'],function(){setCookie('bustcache',1,1000);URI.getNextURI().go();});},isCacheHit:function(a){return !!PageletCache._cache_hits[a];},cleanup:function(){PageletCache._cache_hits={};},clearCache:function(){if(PageletCache._cache){var a=[];for(var b=0;b<PageletCache._cache.length;b++){var c=PageletCache._cache.key(b);if(c.substr(0,7)=='pagelet')a.push(c);}for(b=0;b<a.length;b++)PageletCache._cache.removeItem(a[b]);}},_cache:null,_crypto_url:'/ajax/pagelet_cache/crypto.php',_pagelets:{},_cache_hits:{}};copy_properties(BigPipe.prototype,{loadFromCache:function(a){var b={};copy_properties(b,PageletCache.read(a.id,a.key));if(is_empty(b))PageletCache.bustcache();b.id=a.id;b.cache_hit=true;b.display_dependency=a.display_dependency;b.phase=a.phase;b.is_last=a.is_last;return b;}});
function PageletCacheController(b,a,c){if(!PageletCache)return;if(!b)return;this._cacheKey=b;this._cacheType=a;this._subscriptions=[];this._controller=null;this._registerSnapshot(c);PageletCacheController._instances[b]=this;}copy_properties(PageletCacheController,{registerController:function(a,b){if(!a||!b)return null;var c=PageletCacheController._instances[a];if(c){c.setController(b);if(c._cacheType=='update'&&PageletCache.isCacheHit(a))onafterloadRegister(c.updateAfterload.bind(c,b));}return c;},_instances:{}});copy_properties(PageletCacheController.prototype,{registerCleanup:function(a){Arbiter.subscribe(a,this._cleanup.bind(this));},setController:function(a){this._controller=a;return this;},loadData:function(){return PageletCache.fetchData(this._cacheKey);},populateControllerDataOnSnapshot:bagofholding,handlePageletDOMOnSnapshot:bagofholding,updateAfterload:bagofholding,_registerSnapshot:function(a){for(var b=0;b<a.length;b++)this._subscriptions.push(Arbiter.subscribe(a[b],this._update.bind(this)));},_update:function(){if(!$(this._cacheKey)){this._cleanup();return;}var a=this._controller?this.populateControllerDataOnSnapshot.bind(this,this._controller):bagofholding;PageletCache.takeSnapshot(this._cacheKey,a,this.handlePageletDOMOnSnapshot.bind(this));},_cleanup:function(){this._subscriptions.each(Arbiter.unsubscribe);this._subscriptions.length=0;delete PageletCacheController._instances[this._cacheKey];}});copy_properties(PageletCache,{takeSnapshot:function(f,a,b){var d=PageletCache._pagelets[f];if(d){var c=$(f);if(c){var e=c.cloneNode(true);if(b)b(e);d.content[f]=e.innerHTML;if(a){if(!d.data)d.data={};a(d.data);}PageletCache.write(d);}}},fetchData:function(c,a){var b=PageletCache._pagelets[c];if(b&&b.data)if(a){return b.data[a];}else return b.data;}});
function HomeNavigationCache(b,a,c){this.parent.construct(this,b,a,c);}Class.extend(HomeNavigationCache,'PageletCacheController');copy_properties(HomeNavigationCache.prototype,{handlePageletDOMOnSnapshot:function(d){var a=DOM.scry(d,'li.sideNavItem');if(a.length===0)return;for(var b=0;b<a.length;b++){var c=a[b];if(c.id=='navItem_app_4748854339'){CSS.addClass(c,'selectedItem');}else if(CSS.hasClass(c,'selectedItem')){CSS.removeClass(c,'selectedItem');CSS.removeClass(c,'open');}CSS.removeClass(c,'loading');}}});
function FutureHomeSideNav(){this.parent.construct(this);}Class.extend(FutureHomeSideNav,'FutureSideNav');FutureHomeSideNav.prototype={init:function(){this.parent.init.apply(this,arguments);this.ajaxPipe=true;this.seeAllEndpoint="/ajax/home/generic.php";this.typeSections={favorites:'pinnedNav',profiles:'pinnedNav',apps:'appsNav',groups:'groupsNav',pages:'pagesNav',lists:'listsNav',connect_apps:'connectNav'};this.switchingFromTitanFixedFrame=false;this._arbiterSubscriptions.push(Arbiter.subscribe('titan_fixed_frame_changed',this.handleFixedFrameChanged.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FAVORITE_UPDATE,this.updateFavorite.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FIRST_RESPONSE,this.navigationFirstResponse.bind(this)));this._ensureHover('homeSideNav');this._initPageletCache();},_initPageletCache:function(a){if(window.PageletCacheController){this._cache=PageletCacheController.registerController('pagelet_navigation',this);if(this._cache){this._cache.registerCleanup('HomeNav/cleanup');onleaveRegister(function(){Arbiter.inform('HomeNav/cleanup');});}}},initMoreLink:function(a){this._eventHandlers.push(Event.listen(a,'click',this._showMoreSections.bind(this,a)));},_showMoreSections:function(b){var a=DOM.scry(this.root,'div.belowThreshold');CSS.hide(b);a.forEach(function(c){CSS.removeClass(c,'belowThreshold');});},handleFixedFrameChanged:function(d,a,c){if(a){var b=function(e,f){UIPagelet.loadFromEndpoint(e,f,{fixed_frame:a,selected_key:c});};b('PinnedNavigationPagelet','pagelet_pinned_nav');b('BookmarkNavigationPagelet','pagelet_bookmark_nav');if(ge('chatFriendsOnline'))CSS.hide(ge('chatFriendsOnline'));}else this.switchingFromTitanFixedFrame=true;},handlePageTransition:function(a){if(this.switchingFromTitanFixedFrame){this.switchingFromTitanFixedFrame=false;return false;}else return this.parent.handlePageTransition(a);},_initSection:function(a){var d=this.parent._initSection(a);for(var e in this.typeSections){var c=this.typeSections[e];if(d.id==c){var b=DOM.scry(d.node,'div.navHeader')[0];if(b){var f='\/bookmarks\/('+e+')(\/)?';d.seeall=this._initItem({node:b,id:d.id,endpoint:this.seeAllEndpoint,key:['bookmarks'],path:[{regex:f}]});}}}return d;},_constructItem:function(a,b){return new FutureHomeSideNavItem(a,b);},_constructSection:function(a){return new FutureHomeSideNavSection(a);},getSection:function(a){return this.typeSections[a]&&this.sections[this.typeSections[a]];},_getItemForKey:function(a){var b=this.parent._getItemForKey("nf");if(b&&b.matchKey(a)){return b;}else return this.parent._getItemForKey(a);},_isCurrentPath:function(a){return ((a.getDomain()===this.uri.getDomain())&&(a.getPath()==='/'||a.getPath()==='/home.php'));},_handleMenuClick:function(c,a,b,event){if(CSS.hasClass(b,'favorite')){Arbiter.inform(NavigationMessage.NAVIGATION_FAVORITE_UPDATE,{key:a.numericKey,favorite:!c.equals(this.getSection("favorites"))});}else this.parent._handleMenuClick(c,a,b,event);},removeItemByKey:function(a){Arbiter.inform(NavigationMessage.NAVIGATION_ITEM_REMOVED,a);this.parent.removeItemByKey(a);},toggleItemByKey:function(b,d){var c=this.getNodeForKey(b);if(!d){Arbiter.inform(NavigationMessage.NAVIGATION_ITEM_HIDDEN,b);c&&CSS.hide(c);}else c&&CSS.show(c);var a=this._getItemForKey(b);this.getSection(a.type).refresh();},removeItem:function(a){var b=this.getSection(a.type);this.parent.removeItem(a);b.refresh();},updateFavorite:function(g,b){var f=this._findItem(function(h){return h.matchKey(b.key)&&h.canFavorite();});var d=this.getSection("favorites");var a=bagofholding;var c=b.favorite?d.addEndpoint:d.removeEndpoint;if(!f){if(b.favorite){a=function(){UIPagelet.loadFromEndpoint('PinnedNavigationPagelet','pagelet_pinned_nav');};}else a=function(){UIPagelet.loadFromEndpoint('BookmarkNavigationPagelet','pagelet_bookmark_nav');};}else{var e=this.getSection(f.type);if(b.favorite){CSS.show(f.node);this.moveItem(d,f);f.showFavorite();}else if(!e.equals(d)){this.moveItem(e,f);f.hideFavorite();}else this.removeItem(f);e.refresh();d.refresh();b.key=f.numericKey;Arbiter.inform('NavigationMessage.FAVORITES_UPDATED');}new AsyncRequest().setURI(c).setData({id:b.key}).setHandler(a).send();},_doPageTransition:function(a,c){this._unloadStreams();var b=this.parent._doPageTransition(a,c);if(b&&(a.type=='groups'||a.type=='lists')){a.setCount(0);a.hideUnreadFace();}return b;},_unloadStreams:function(){var a=UIIntentionalStream&&UIIntentionalStream.instances;var b=['nile','global','friends','blade'];a&&b.forEach(function(c){a[c]&&a[c].unload();});},navigationFirstResponse:function(){this.setSelected(this.loading);}};function FutureHomeSideNavSection(a){this.parent.construct(this,a);this.editEndpoint='/ajax/bookmark/edit/';this.addEndpoint='/ajax/bookmark/add/';this.removeEndpoint='/ajax/bookmark/delete/';}Class.extend(FutureHomeSideNavSection,'FutureSideNavSection');FutureHomeSideNavSection.prototype={refresh:function(){var b=DOM.scry(this.node,'li.sideNavItem');var a=DOM.scry(this.node,'div.actionLinks');var c=b.some(CSS.shown);CSS.conditionShow(DOM.find(this.node,'div.navHeader'),c);a.length&&CSS.conditionShow(a[0],c);}};function FutureHomeSideNavItem(a,b){this.parent.construct(this,a,b);}Class.extend(FutureHomeSideNavItem,'FutureSideNavItem');FutureHomeSideNavItem.prototype={canFavorite:function(){return !!this._getFavoriteLabel();},showFavorite:function(){DOM.setContent(this._getFavoriteLabel(),"Remove from Favorites");},hideFavorite:function(){DOM.setContent(this._getFavoriteLabel(),"Add to Favorites");},hideUnreadFace:function(){var a=DOM.scry(this.node,'img.unreadProfileImg')[0];a&&CSS.hide(a);},_getFavoriteLabel:function(){return DOM.scry(this.node,'li.favorite span.itemLabel')[0];}};
function RenderManager(a){copy_properties(this,{_isDirty:false,_obj:a});}copy_properties(RenderManager.prototype,{dirty:function(){if(!this._isDirty){this._isDirty=true;bind(this,this.doPaint).defer();}},doPaint:function(){this._isDirty=false;this._obj.paint();}});
function CounterDisplay(a,g,h,e,d,b){copy_properties(this,{_name:a,_valueNode:$(g),_wrapperNode:$(h)||null,_statusClass:d,_rm:new RenderManager(this),_arbiterSubscription:null,_count:0});var c=this._valueNode.firstChild;if(c){var f=parseInt(c.nodeValue,10);if(!isNaN(f))this._count=f;}this._statusNode=e?$(e):null;this._subscribeAll();CounterDisplay.instances.push(this);if(!b)onleaveRegister(this._destroy.bind(this),true);}copy_properties(CounterDisplay,{EVENT_TYPE_ADJUST:'CounterDisplay/adjust',EVENT_TYPE_UPDATE:'CounterDisplay/update',instances:[],adjustCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_ADJUST+'/'+a,b);},setCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_UPDATE+'/'+a,b);}});Class.mixin(CounterDisplay,{_destroy:function(){delete this._valueNode;delete this._wrapperNode;if(this._arbiterSubscription){Arbiter.unsubscribe(this._arbiterSubscription);delete this._arbiterSubscription;}CounterDisplay.instances.remove(this);},adjustCount:function(a){this._count=Math.max(0,this._count+a);this._rm.dirty();return this;},setCount:function(a){this._count=Math.max(0,a);this._rm.dirty();return this;},paint:function(){DOM.setContent(this._valueNode,this._count);this._toggleNodes();},_toggleNodes:function(){if(this._wrapperNode)CSS.conditionClass(this._wrapperNode,'hidden_elem',this._count<=0);if(this._statusClass&&this._statusNode)CSS.conditionClass(this._statusNode,this._statusClass,this._count>0);},_subscribeAll:function(){var a=[CounterDisplay.EVENT_TYPE_ADJUST+'/'+this._name,CounterDisplay.EVENT_TYPE_UPDATE+'/'+this._name];this._arbiterSubscription=Arbiter.subscribe(a,this._onInform.bind(this),Arbiter.SUBSCRIBE_NEW);},_onInform:function(a,b){b=parseInt(b);if(isNaN(b))return;if(a.indexOf(CounterDisplay.EVENT_TYPE_ADJUST)!=-1){this.adjustCount(b);}else if(a.indexOf(CounterDisplay.EVENT_TYPE_UPDATE)!=-1){this.setCount(b);}else return;return;}});
function MenubarMessageController(b,a){}copy_properties(MenubarMessageController,{ensureInitialized:function(c,b,a){if(MenubarMessageController.initialized||!ge(b))return false;var d=new MenubarMessageController(c,b);MenubarMessageController.instance=d;d.ensureInitialized(c,b,a);MenubarMessageController.initialized=true;}});copy_properties(MenubarMessageController.prototype,{ensureInitialized:function(d,c,a,b){this.menu=ge(c);this.fetchOnHover=b;var e=[CounterDisplay.EVENT_TYPE_ADJUST+'/messages_unread',CounterDisplay.EVENT_TYPE_UPDATE+'/messages_unread'];Arbiter.subscribe(e,this.onCounterUpdate.bind(this),Arbiter.SUBSCRIBE_NEW);Arbiter.subscribe(PresenceMessage.getArbiterMessageType('messages_seen'),function(){Arbiter.inform('jewel/count-updated',{jewel:'messages',count:0},Arbiter.BEHAVIOR_STATE);});this._dirty=a;if(b)this.mouseOverListener=Event.listen($(d),'mouseover',this.doRefetch.bind(this));},doRefetch:function(){if(this._dirty){this._dirty=false;this._fetch();}},_fetch:function(){},onFetchComplete:function(a){if(this.menu)DOM.setContent(this.menu,HTML(a.payload));},onCounterUpdate:function(){this._dirty=true;},markSeen:function(a){new AsyncSignal('/ajax/gigaboxx/endpoint/UpdateLastSeenTime.php',{folder:a}).send();}});
GroupMall={init:function(a){this._mallNode=$('group_mall_'+a);this._composerPublishToken=Arbiter.subscribe('composer/publish',function(event,b){if(b.streamStory&&!ge(b.streamStory.id))this._addPostToUI(b.streamStory);}.bind(this));onleaveRegister(this._onleave.bind(this));this._navigationBeginToken=Arbiter.subscribe(NavigationMessage.NAVIGATION_BEGIN,this._onleave.bind(this));},_onleave:function(){Arbiter.unsubscribe(this._navigationBeginToken);Arbiter.unsubscribe(this._composerPublishToken);},_addPostToUI:function(c){var a=Vector2.getElementDimensions(this._mallNode).y;DOM.prependContent(this._mallNode,c);var b=this._mallNode.firstChild;LiveTimer.startLoop(0);new animation(b).from('opacity',0).to('opacity',1).duration(300).go();}};
__e("StickyController",["event-extensions","css","vector","FunctionUtils"],function(f,h,g,e){h('event-extensions');var a=h('css');var d=h('vector');var b=h('FunctionUtils');function c(i,j,k,l){this._element=i;this._marginTop=j;this._onchange=k;this._proxy=l||i.parentNode;}c.prototype={handleScroll:function(){var i=d.getElementPosition(this._proxy,'viewport').y<=this._marginTop;if(this.isFixed()!==i){a.setStyle(this._element,'top',i?this._marginTop+'px':'');a.conditionClass(this._element,'fixed_elem',i);this._onchange&&this._onchange(i);}},start:function(){if(this._event)return;this._event=Event.listen(window,'scroll',b.throttle(this.handleScroll.bind(this),100));this.handleScroll.bind(this).defer();},stop:function(){this._event&&this._event.remove();this._event=null;},isFixed:function(){return a.hasClass(this._element,'fixed_elem');}};f.StickyController=g.exports=c;},3);
function FriendBrowserCheckboxController(){}copy_properties(FriendBrowserCheckboxController,{instances:{},getInstance:function(a){return this.instances[a];}});FriendBrowserCheckboxController.prototype={init:function(b,a){FriendBrowserCheckboxController.instances[b]=this;this._id=b;this._form=a;this._contentGrid=DOM.find(a,'.friendBrowserCheckboxContentGrid');this._loadingIndicator=DOM.find(a,'.friendBrowsingCheckboxContentLoadingIndicator');this._checkboxResults=DOM.find(a,'.friendBrowserCheckboxResults');this._contentPager=DOM.find(a,'.friendBrowserCheckboxContentPager');this.numGetNewRequests=0;this.queuedRequests={};},addTypeahead:function(b,a){b.subscribe('select',this.onHubSelect.bind(this,b,a));},onHubSelect:function(f,e,event,c){if(!((event=='select')&&c.selected))return;var d=this.buildNewCheckbox(e,c.selected.text,c.selected.uid);var a=DOM.find(this._form,'.checkboxes_'+e);DOM.appendContent(a.firstChild,d);var b=DOM.scry(f.getElement(),'input[type="button"]');if(b&&b[0])b[0].click();this.getNew(true);},buildNewCheckbox:function(i,e,j){var a=i+'_ids_'+j;var g=i+'_ids[]';var b=$N('input',{id:a,type:'checkbox',value:j,name:g,checked:true});Event.listen(b,'click',bind(this,'getNew',false));var c=$N('td',null,b);CSS.addClass(c,'vTop');CSS.addClass(c,'hLeft');var d=$N('label',null,e);var f=$N('td',null,d);CSS.addClass(f,'vMid');CSS.addClass(f,'hLeft');var h=$N('tr');h.appendChild(c);h.appendChild(f);return h;},navAddTypeahead:function(b,a){b.subscribe('select',this.navOnHubSelect.bind(this,b,a));b.subscribe('blur',this.navHideTypeahead.bind(this,a));},navOnHubSelect:function(f,e,event,b){if(!((event=='select')&&b.selected))return;if(!ge(e+'_ids_'+b.selected.uid)){var d=$(e+'_ids_0');var c=d.cloneNode(true);c.id=e+'_ids_'+b.selected.uid;DOM.find(c,'a').onclick=bind(this,function(){this.setTypeAndFilterId(e,b.selected.uid).getNew(true);});DOM.setContent(DOM.find(c,'.linkWrap'),b.selected.text);DOM.insertBefore(c,d);CSS.show(c);}var a=DOM.scry(f.getElement(),'input[type="button"]');if(a&&a[0])a[0].click();this.navHideTypeahead(e);this.setTypeAndFilterId(e,b.selected.uid).getNew(true);},navHideTypeahead:function(a){CSS.hide($(a+'_ids_typeahead'));CSS.show($(a+'_ids_0'));},navShowTypeahead:function(a){CSS.hide($(a+'_ids_0'));typeahead=$(a+'_ids_typeahead');CSS.show(typeahead);DOM.find(typeahead,'.inputtext').focus();},showMore:function(){var b=DOM.scry(this._contentPager,'.friendBrowserMorePager')[0];if(!b)return false;if(CSS.hasClass(b,'async_saving'))return false;var d=this.numGetNewRequests;var a=Form.serialize(this._form);a.show_more=true;var c=new AsyncRequest().setURI('/ajax/growth/friend_browser/checkbox.php').setData(a).setHandler(bind(this,function(e){this.showMoreHandler(e,d);})).setStatusElement(b).send();},showMoreHandler:function(c,b){if(b==this.numGetNewRequests){var a=c.payload;DOM.appendContent(this._contentGrid,a.results);this.updatePagerAndExtraData(a.pager,a.extra_data);}},getNew:function(c){this.numGetNewRequests++;var b=this.numGetNewRequests;CSS.addClass(this._checkboxResults,'friendBrowserCheckboxContentOnload');if(ge('friendBrowserCI'))CSS.addClass($('friendBrowserCI'),'friendBrowserCheckboxContentOnload');CSS.show(this._loadingIndicator);var a=Form.serialize(this._form);a.used_typeahead=c;new AsyncRequest().setURI('/ajax/growth/friend_browser/checkbox.php').setData(a).setHandler(bind(this,function(d){this.getNewHandler(d,b);})).send();},getNewHandler:function(c,b){if(b==this.numGetNewRequests){var a=c.payload;DOM.setContent(this._contentGrid,a.results);CSS.removeClass(this._checkboxResults,'friendBrowserCheckboxContentOnload');if(ge('friendBrowserCI'))CSS.hide($('friendBrowserCI'));CSS.hide(this._loadingIndicator);this.updatePagerAndExtraData(a.pager,a.extra_data);}},updatePagerAndExtraData:function(b,a){DOM.setContent(this._contentPager,b);this.setupOnVisible();DOM.replace(this._form.elements.extra_data,a);},setupOnVisible:function(){var a=DOM.scry(this._contentPager,'.friendBrowserMorePager')[0];if(a&&this._id!='jewel'){this._onVisible&&this._onVisible.remove();this._onVisible=new OnVisible(a,bind(this,'showMore'),false,1000);}},makeFriendRequest:function(e,f,b,a,d){var c=Form.serialize(this._form);c.friend_id=f;if(b)c.countdown_complete=b;if(a)c.cancel=a;if(d)c.dialog_success=d;var g=new AsyncRequest();g.setURI('/ajax/growth/friend_browser/friend.php').setData(c).setRelativeTo(e).send();},queueRequest:function(a,b){this.queuedRequests[b]=true;setTimeout(bind(this,function(){this.sendQueuedRequest(a,b);}),5000);},sendQueuedRequest:function(b,c){if(this.queuedRequests[c]){this.queuedRequests[c]=false;var a=$(b);var d=DOM.find(a,'^.friendBrowserUnit');CSS.removeClass(d,'friendBrowserRequesting');CSS.addClass(d,'friendBrowserRequested');this.makeFriendRequest(a,c,true);}},cancelQueuedRequest:function(a,b){this.queuedRequests[b]=false;this.makeFriendRequest(a,b,false,true);},showConfirmationDialog:function(a,b,c,f,d){var e=this;ConnectDialog.newInstance(b,c,function(){e.makeFriendRequest(a,b,false,false,true);return false;},null,false,null,0,'','',f,d).show();return false;},initRightHandColumn:function(){new StickyController($('friendBrowserRightColumn'),50).start();},initFriendCollector:function(){var a=this.reloadFriendCollector.bind(this);Arbiter.subscribe(FriendRequestMessage.SENT,a);},reloadFriendCollector:function(b,a){UIPagelet.loadFromEndpoint('RecentlyRequestedPagelet','recently_requested_pagelet',{last_requested_uid:a.uid},{usePipe:true});},setTypeAndFilterId:function(b,a){DOM.find(this._form,'#selected_type').value=b;DOM.find(this._form,'#selected_filter_id').value=a;CSS.removeClass(DOM.find($('sideNav'),'.selectedItem'),'selectedItem');if(b&&a){CSS.addClass($(b+'_ids_'+a),'selectedItem');}else CSS.addClass(DOM.find($('sideNav'),'#find_friends'),'selectedItem');$('headerArea').scrollIntoView(false);return this;}};
var UIIntentionalStreamMessage={INITIALIZE_COMPLETE:'UIIntentionalStream/initializeComplete',SET_AUTO_INSERT:'UIIntentionalStream/setAutoInsert',UPDATE_STREAM:'UIIntentionalStreamRefresh/updateStream',REFRESH_STREAM:'UIIntentionalStreamRefresh/refreshStream',UPDATE_AUTOREFRESH_CONFIG:'UIIntentionalStream/updateAutoRefreshConfig',UPDATE_HTML_CONTENT:'UIIntentionalStream/updateHtmlContent',UPDATE_LAST_REFRESH_TIME:'UIIntentionalStream/updateLastRefreshTime',INSERT_STORIES:'UIIntentionalStream/updateLastRefreshTime'};
__e("user-activity",["UserActivity"],function(a,b){a.UserActivity=a.UserActivity||b('UserActivity');},3);
function TickerController(){}!function(){var c=1;var b=2;var a=3;var d=4;copy_properties(TickerController,{_instances:{},_activeInstance:null,_placeholders:{},_logPositionChange:false,getInstance:function(e){var f=Parent.byClass($(e),'fbFeedTicker');return f?TickerController._instances[f.id]:null;},isLoaded:function(e){var f=TickerController._placeholders[e.id];return !f||f.status==a;},show:function(i,e){e=e||bagofholding;for(var g in TickerController._instances){var k=ge(g);if(!k||k.parentNode.id==i.id)continue;TickerController.hide(k.parentNode);}TickerController._doPositionChange(i);CSS.show(i);var j=TickerController._placeholders[i.id];if(j&&j.status==c){TickerController._fetchTickerForPlaceholder(i,e);}else{var f=DOM.scry(i,'.fbFeedTicker')[0];var h=f&&TickerController.getInstance(f);TickerController._activeInstance=h;h&&h._poll();TickerController._placeholders[i.id]={status:d,callback:e};e();}},_doPositionChange:function(e){if(!TickerController._logPositionChange||CSS.shown(e))return;new AsyncSignal('/common/ods_endpoint.php',{k:'ticker.render.switch.'+e.id}).send();},hide:function(f){var e=DOM.scry(f,'.fbFeedTicker')[0];var g=e&&TickerController.getInstance(e);g&&g.hideActiveStory();CSS.hide(f);},hideStoriesByClass:function(e){for(var f in TickerController._instances)DOM.scry($(f),e).forEach(CSS.hide);},hideStory:function(e){var f=e&&TickerController.getInstance(e);f&&f.hideStory(e);},undoHideStory:function(e){var f=e&&TickerController.getInstance(e);f&&f.undoHideStory(e);},_fetchTickerForPlaceholder:function(g,e){var f={handler:function(){TickerController._placeholders[g.id].status=a;e();}};UIPagelet.loadFromEndpoint('TickerPagelet',g.id,TickerController._placeholders[g.id].pageletData,f);TickerController._placeholders[g.id].status=b;},registerStoryDialog:function(f,e){Arbiter.subscribe('ticker/init',function(){var g=ge(f);var h=g&&TickerController.getInstance(g);h&&h.registerStoryDialog(g,e);},Arbiter.SUBSCRIBE_ALL);},registerPlaceholder:function(g,f){var e=TickerController._placeholders[g];TickerController._placeholders[g]={status:c,pageletData:f};if(e&&e.status==d){TickerController.show($(g));e.callback();}}});}();TickerController.prototype={ADS_IDLE_MS:300000,FLYOUT_MAX_HEIGHT:450,FLYOUT_OFFSET_THRESHOLD:20,FLYOUT_COMMENT_OFFSET:15,FLYOUT_VIEWPORT_PADDING:75,FLYOUT_TARGET_HEIGHT_OFFSET:25,init:function(d,e,a){TickerController._instances[d.id]=this;TickerController._activeInstance=this;this._root=d;this._content=DOM.find(d,'.ticker_stream');this._stories=DOM.find(this._root,'.tickerActivityStories');this._scrollableArea=e;this._container=DOM.find(d,'div.uiScrollableAreaWrap');this._storyIDs=[];this._objectIDs=[];this._fetchedStories={};this._removedStoryIDs=[];var b=Date.now();this._initTime=b;this._lastUpdate=b;this._lastPull=b;this._lastInsert=b;this._lastCustomStory=0;this._pollOnly=false;this._needNonCustomStoryNum=0;this._doCustomUpdate=true;this._autoloadStoryIndex=1;this._scrollTopThreshold=100;this._scrollTopPrompt=DOM.find(this._root,'.scrollTopPrompt');this._scrollTopPromptVisible=false;this._maxStoriesToKeep=50;this._minStoriesToKeep=25;this._tickerInSidebarMode=!!Parent.byClass(this._root,'fbChatSidebar');this._ua={flyout:user_action('ticker_flyout').set_namespace('ticker').set_ua_id('flyout'),flyout_prefetch:user_action('ticker_flyout_prefetch').set_namespace('ticker').set_ua_id('flyout_prefetch'),flyout_loadtime:user_action('ticker_flyout_loadtime').set_namespace('ticker').set_ua_id('flyout_loadtime'),stream:user_action('ticker_stream').set_namespace('ticker').set_ua_id('stream')};this._uaCurStoryIDFetch=null;this._uaCurStoryIDPrefetch=null;var c=$N('div',{className:'storyQueue hidden_elem'});this._storyQueue=c;DOM.appendContent(this._root,c);this._initObjectIDs();this._initPageletCache(a);this._initConfig(a);this._resetMorePager();this._initListeners();this._initSubscriptions(a);Arbiter.inform('ticker/init',this,Arbiter.BEHAVIOR_PERSISTENT);this._poll();if(this._prefetchAfterLoad){this._logUserEvent('stream','prefetch');this._fetchStories(this._getInsertedStories().slice(0,5));}},_initPageletCache:function(a){if(window.PageletCacheController){this._cache=PageletCacheController.registerController(this._root.parentNode.id,this);if(this._cache){copy_properties(a,this._cache.loadData());this._cache.registerCleanup('Ticker/cleanup');}}},_initConfig:function(a){copy_properties(this,{_newest:a.newest,_page_newest:a.newest,_timeout:a.timeout,_heartbeatTimeout:Math.max(15000,a.heartbeatTimeout),_pullTimeout:Math.max(30000,a.pullTimeout),_insertTimeout:a.insertTimeout,_friendCount:a.friendCount,_maxQueueLength:a.maxQueueLength,_heartbeatEndpoint:a.heartbeatEndpoint,_maxCustomQueueLength:a.maxCustomQueueLength,_customStoryInsertTimeout:Math.max(5000,a.customStoryInsertTimeout),_nonCustomToCustomStoryRatio:a.nonCustomToCustomStoryRatio,_minForceUpdateInterval:Math.max(a.insertTimeout,a.minForceUpdateInterval),_popupOnHover:a.popupOnHover,_priorityAppId:a.priorityAppId,_prefetchOnHover:a.prefetchStoriesOnHover,_userIdleTimeout:a.userIdleTimeout,_firstCustomStoryDelay:a.firstCustomStoryDelay,_pollOnly:a.pollOnly,_tickerDebug:a.tickerDebug,_tickerSource:a.tickerSource,_prefetchAfterLoad:a.prefetchAfterLoad,_logFlyouts:a.logFlyouts});this._queueCustomStories(a.customStories);},_initListeners:function(){this._listeners=Event.listen(this._root,{click:this._handleClick.bind(this),keydown:this._handleKeydown.bind(this),mouseout:this._handleMouseout.bind(this),mouseover:this._handleMouseover.bind(this),mousedown:this._tickerDeClicker.bind(this),mouseup:this._handleMouseup.bind(this)});this._listeners.scroll=Event.listen(this._container,'scroll',this._handleScroll.bind(this));this._initInfiniteScrollListener.bind(this).defer();},_initSubscriptions:function(a){onleaveRegister(this._cleanup.bind(this));this._subscriptions=[Arbiter.subscribe(NavigationMessage.NAVIGATION_BEGIN,this._onNavHandler.bind(this)),Arbiter.subscribe(PresenceMessage.getArbiterMessageType('ticker_update'),this._handleTickerPush.bind(this)),Arbiter.subscribe('composer/publish',this._handleComposerPublish.bind(this)),Arbiter.subscribe('Ticker/storiesInserted',this._handleStoriesInserted.bind(this)),Arbiter.subscribe('Ticker/fixed',this._setFixed.bind(this,true)),Arbiter.subscribe('Ticker/unfixed',this._setFixed.bind(this,false)),Arbiter.subscribe('Ticker/resized',this._checkInfiniteScroll.bind(this)),Arbiter.subscribe(UFIOptimistic.COMMENT_SEND_EVENT,this._scrollDialogToBottom.bind(this)),Arbiter.subscribe('Ticker/chatOpened',this._handleChatOpened.bind(this))];if(a.pushChannel)this.setPushChannel(a.pushChannel);},_handleClick:function(event){var c=event.getTarget();if(this._getButtonFromNode(c)){this._logUserAction(c,'click',event);this._handleActionButton(event);return;}var b=this._getStoryFromNode(c);var a=Parent.byClass(c,'tickerStoryAllowClick');if(!b||b==this._selectedStory||a)return;if(this._storyIsHidden(b))return;if(b==this._activeStory&&!this._selectedStory)this._selecting=true;this._clearNux();this._logUserEvent('flyout','click');this._logUserEvent('flyout_loadtime','open');if(this._storyCanOpenExternally(b)){this._logUserAction(c,'click',event);this._openStoryExternally(b,event);return;}this._logUserAction(c,'flyout',event);this._activateStory(b,'click');this._selectStory(b);},_handleMouseover:function(event){this._setLocked(true);var d=event.getTarget();var c=this._getOpenableStory(d);if(!c)return;event.kill();if(this._prefetchOnHover||this._popupOnHover){if(!(c.id in this._fetchedStories)){this._logUserEvent('flyout_prefetch','prefetch_on_hover');this._uaCurStoryIDPrefetch=c.id;}this._fetchStory(c);}if(this._selectedStory)return;if(this._popupOnHover){this._clearHoverTimeouts();var b=this._storyCanOpenExternally(c)?500:1000;var a=this._activeStory?75:b;if(!window.addEventListener&&document.createEventObject)event=document.createEventObject(event);this._hoverShowTimeout=this._setTimeout(function(){this._logUserEvent('flyout','hover',a);this._logUserEvent('flyout_loadtime','open');this._activateStory(c,'hover');this._logUserAction(d,'flyout',event);}.bind(this),a);}},_handleMouseout:function(event){var c=event.getTarget();this._setLocked(false);if(c==this._getStoryFromNode(c)){var b=DOM.scry(c.parentNode,'.openToggler');for(var a=0;a<b.length;a++)Selector.toggle(b[a]);}this._clearClickedStory();this._scheduleHide();},_handleKeydown:function(event){this._tickerDeClicker(event);var d=this._activeStory;if(!d)return;var a=Event.getKeyCode(event);switch(a){case KEYS.UP:case KEYS.DOWN:var c=this._getInsertedStories();var b;if(event.getModifiers().any){b=a===KEYS.UP?0:c.length-1;}else b=c.indexOf(d)+(a===KEYS.UP?-1:1);d=c[b];break;case KEYS.ESC:this._deactivateStory(true);return;default:return;}if(!d)return;event.kill();this._activateStory(d,'keypress');this._selectStory(d);},_handleScroll:function(){!this._preventScrollDismiss&&this._deactivateStory(true);this._checkInfiniteScroll();if(!this._scrollLogged){this._scrollLogged=true;var b=this._stories.childNodes.length;var c=this._stories.getAttribute('data-gt');var a={ticker_scroll:1,number_stories:b,source:c};report_data('scroll',{gt:a});}},_handleStoriesInserted:function(){this._initInfiniteScrollListener();this._scrollableArea.adjustGripper();this._logUserEvent('stream','insert');},_handleActionButton:function(event){var d=event.getTarget();var a=this._getButtonFromNode(d);var c=this._getOpenableStory(d);var b=this._getStoryDialog(c);if(b)var e=b.subscribe('beforehide',function(){b.unsubscribe(e);return false;});},_handleScrollToTopClick:function(){this._scrollToTop(this._poll.bind(this));},_scrollToTop:function(a){animation(this._container).to('scrollTop',0).ease(animation.ease.end).ondone(a).go();},_clearHoverTimeouts:function(){clearTimeout(this._hoverShowTimeout);clearTimeout(this._hoverHideTimeout);},_getAllStories:function(){return DOM.scry(this._root,'div.fbFeedTickerStory');},_getInsertedStories:function(){return this._getAllStories().filter(function(a){return !CSS.hasClass(a,'queuedStory')&&!CSS.hasClass(a,'customStory');});},_getQueuedStories:function(){return DOM.scry(this._storyQueue,'.fbFeedTickerStory.queuedStory');},_getQueuedCustomStories:function(){return DOM.scry(this._storyQueue,'.fbFeedTickerStory.customStory');},_getButtonFromNode:function(a){return Parent.byClass(a,'tickerInlineOverlay');},_getStoryFromNode:function(a){return Parent.byClass(a,'fbFeedTickerStory');},_getActionButtonFromStory:function(a){return DOM.scry(a,'.tickerInlineActionButton')[0];},_getOpenableStory:function(a){var b=this._getStoryFromNode(a);return this._storyCanOpenDialog(b)?b:null;},_getStoryDialog:function(a){return window.ContextualDialogX&&ContextualDialogX.getInstance(a)||null;},_getStoryDialogEndpoint:function(a){return a&&a.getAttribute('data-rel')=='async'&&a.getAttribute('data-ajaxify')||null;},_storyCanOpenDialog:function(a){return !!this._getStoryDialogEndpoint(a)&&!this._storyIsHidden(a);},_storyCanOpenExternally:function(a){return !!a.getAttribute('data-href')||!this._storyCanOpenDialog(a);},_storyIsHidden:function(a){return CSS.hasClass(a,'tickerStoryHidden');},hideActiveStory:function(){this._activeStory&&this.hideStory(this._activeStory);},hideStory:function(a){this._deactivateStory();CSS.addClass(a,'tickerStoryHidden');CSS.removeClass(a,'tickerStoryClickable');},undoHideStory:function(a){CSS.addClass(a,'tickerStoryClickable');CSS.removeClass(a,'tickerStoryHidden');},_scheduleHide:function(){if(this._popupOnHover&&!this._selectedStory){this._clearHoverTimeouts();this._hoverHideTimeout=this._setTimeout(this._deactivateStory.bind(this),100);}},_setScrollTopPromptVisible:function(a){this._scrollTopPromptVisible=a;CSS.conditionShow(this._scrollTopPrompt,a);if(a&&!this._listeners.scrollTop){this._listeners.scrollTop=Event.listen(this._scrollTopPrompt,{click:this._handleScrollToTopClick.bind(this)});}else if(!a&&this._listeners.scrollTop){this._listeners.scrollTop.click.remove();this._listeners.scrollTop=null;}},_isUserIdle:function(){return !UserActivity.isActive(this._userIdleTimeout);},_schedulePoll:function(){clearTimeout(this._pollToken);this._pollToken=this._setTimeout(this._poll.bind(this),this._timeout);},_poll:function(){this._debug('poll');if(!this._isTickerVisible()){this._debug('not polling: ticker not visible');return;}if(this._isUserIdle()){this._debug('not polling: idle');return UserActivity.subscribeOnce(this._poll.bind(this));}var e=!this._isScrolledToTop()&&this._getQueuedStories().length;this._setScrollTopPromptVisible(e);var d=Date.now();var j=d-this._lastInsert;if(j<this._insertTimeout||this._isLocked())return this._schedulePoll();var g=this._getQueuedStories();var a=this._getQueuedCustomStories();var i=g.length>0;var h=a.length>0&&(d-this._initTime>this._firstCustomStoryDelay)&&(this._needNonCustomStoryNum===0||(!i&&(d-this._lastCustomStory)>this._customStoryInsertTimeout));if(h){this.insertStory(a.shift());this._lastCustomStory=d;this._needNonCustomStoryNum=this._nonCustomToCustomStoryRatio;this._debug('not polling: should insert custom story');return this._schedulePoll();}if(i){this.insertStory(g.shift());this._needNonCustomStoryNum--;if(this._needNonCustomStoryNum<0)this._needNonCustomStoryNum=0;this._debug('not polling: should insert story');return this._schedulePoll();}var c=a.length===0&&this._needNonCustomStoryNum===0&&this._nonCustomToCustomStoryRatio>0&&UserActivity.isActive(this.ADS_IDLE_MS)&&((d-this._lastUpdate)>this._minForceUpdateInterval);var b=d-this._lastUpdate>this._heartbeatTimeout;if((c&&this._doCustomUpdate)||b){if(c)this._doCustomUpdate=false;var f=false;if(b&&!this._pollOnly)f=(d-this._lastPull>this._pullTimeout);this._debug('polling for new stories');this.update({heartbeat:b,pull:f,fullpoll:this._pollOnly,needcustomstory:c});return;}this._schedulePoll();},update:function(b){var a={newest:(b.fullpoll||b.cache_update)?this._newest:this._page_newest,storyids:this._storyIDs,friendcount:this._friendCount,priorityappid:this._priorityAppId,source:this._tickerSource,needcustomstory:this._nonCustomToCustomStoryRatio>0};copy_properties(a,b);new AsyncRequest().setURI(this._heartbeatEndpoint).setReadOnly(true).setOption('retries',0).setData(a).setHandler(this._handleResponse.bind(this)).setFinallyHandler(this._poll.bind(this)).setAllowCrossPageTransition(true).send();this._lastUpdate=Date.now();if(a.pull)this._lastPull=this._lastUpdate;this._storyIDs=[];},insertStory:function(d,a,c){this._lastInsert=Date.now();window.LiveTimer&&LiveTimer.addTimeStamps(d);CSS.removeClass(d,'queuedStory');CSS.removeClass(d,'customStory');if(a!==false){var b=c?this._fadeStoryIn:this._flyStoryIn;if(this._isScrolledToTop()){this._scrollToTop(b.bind(this,d));}else b.call(this,d);}else DOM.prependContent(this._stories,d);this._removeOldStories();},_removeOldStories:function(){var b=this._getInsertedStories();if(b.length<=this._maxStoriesToKeep)return;var a=this._minStoriesToKeep;b.slice(a).each(DOM.remove);this._resetMorePager();},_resetMorePager:function(){var b=this._getInsertedStories();if(!b||!b.length)return;var c=b[b.length-1].getAttribute('data-ticker-timestamp');var a=DOM.scry(this._root,'.tickerMorePager a')[0];if(!a||!c)return;var d=new URI(a.getAttribute('ajaxify'));d.addQueryData({oldest:c});a.setAttribute('ajaxify',d);},_setLocked:function(a){this._locked=a;},_isLocked:function(){return !!(this._scrollTopPromptVisible||this._locked||this._activeStory);},informAndRemoveStory:function(a,d,e){var b=this._getStoryFromNode(a);var c=b.getAttribute('data-story-key');DOM.setContent(b,d);CSS.addClass(b,'highlightedStory');this._setTimeout(this.removeStory.bind(this,c),e||6000);},_getStoryByStoryKey:function(b){var c=this._getAllStories();for(var a=0;a<c.length;a++){var d=c[a];if(d.getAttribute('data-story-key')==b)return d;}return null;},removeStory:function(c){this._removedStoryIDs[c]=true;var b=this._getStoryByStoryKey(c);if(!b)return;if(b==this._activeStory)this._deactivateStory();var a=this._getStoryDialog(b);a&&a.destroy();this._animateStoryOut(b);},_isScrolledToTop:function(){return this._container.scrollTop<=this._scrollTopThreshold;},_flyStoryIn:function(b){var c=$N('div',{style:{marginTop:'-1000px'}},b);CSS.setStyle(c,'opacity',0);DOM.prependContent(this._stories,c);var a=Vector2.getElementDimensions(c).y;CSS.setStyle(c,'marginTop','-'+a+'px');animation(c).to('marginTop',0).ease(animation.ease.end).checkpoint(.5).to('opacity',1).ondone(function(){DOM.replace(c,b);this._afterInsert(b);}.bind(this)).go();},_fadeStoryIn:function(a){animation(this._stories).to('opacity',.5).ondone(function(){DOM.prependContent(this._stories,a);animation(this._stories).to('opacity',1).ondone(function(){this._afterInsert(a);}.bind(this)).go();}.bind(this)).go();},_animateStoryOut:function(a){var b=$N('div',{style:{overflow:'hidden',position:'relative'}});DOM.insertBefore(b,a);DOM.appendContent(b,a);animation(b).to('top',20).to('height',0).to('opacity',0).ease(animation.ease.end).ondone(function(){DOM.remove.curry(b);Arbiter.inform('Ticker/animateOut');}.bind(this)).go();},_afterInsert:function(a){Arbiter.inform('Ticker/afterInsert');if(a&&CSS.hasClass(a,'tickerSponsoredStory')){ad=DOM.scry(a,'.fbEmuStreamStory')[0];ad&&ad.id&&Arbiter.inform('tickerad_'+ad.id);}},setPushChannel:function(a){this._pushSubscription&&Arbiter.unsubscribe(this._pushSubscription);this._pushSubscription=Arbiter.subscribe(PresenceMessage.getArbiterMessageType(a),this._handleTickerPush.bind(this));require.ensure(['ChatConfig','ChannelConnection'],function(c,b){if(c.get('channel_disconnect_warning')){this._channelConnection=b;this._checkChannelConnection();this._channelConnectionSubscription=this._channelConnection.subscribe([this._channelConnection.CONNECTED,this._channelConnection.RECONNECTING,this._channelConnection.SHUTDOWN,this._channelConnection.MUTE_WARNING,this._channelConnection.UNMUTE_WARNING],this._handleChannelConnection.bind(this));}}.bind(this));},_checkChannelConnection:function(){CSS.conditionClass(this._root,'disconnected',this._channelConnection.disconnected());},setCurrentAppId:function(a){this._priorityAppId=a;},_handleTickerPush:function(e,a){if(this._isUserIdle()){this._debug('discarding story: user is idle');return;}var c=a.obj;if(c.delete_id){this.removeStory(c.delete_id);return;}var b=c.story_xhp;if(!b){this._debug('discarding story: no markup');return;}this._newest=c.story_time;var d=HTML(b).getRootNode();this.queueStory(d,c.flyout_js_cmds);},_handleComposerPublish:function(b,a){a.tickerMarkup&&this.insertStory(a.tickerMarkup);},_clearNux:function(){var a=DOM.scry(document.body,'div.tickerNUXContainer');if(a.length){a.each(function(c){var b=ContextualDialogX.getInstance(c);b&&b.hide();});new AsyncRequest().setURI('/ajax/feed/ticker/nux.php').send();}this._clearNux=bagofholding;},_logRender:function(){if(this._loggedRender)return;var a=this._tickerInSidebarMode;if(a||Parent.byClass(this._content,'home_right_column')){new AsyncSignal('/ajax/log_ticker_render.php',{sidebar_mode:a}).send();this._loggedRender=true;}},_isTickerVisible:function(){var a=(TickerController._activeInstance==this);a&&this._logRender();return a;},_handleResponse:function(c){var b=c.getPayload();if(b.newest)this._newest=this._page_newest=b.newest;if(b.content)if(b.cache_update&&this._cache){this._cache.insertStory(b.content);}else if(b.content instanceof Array){for(var a=0;a<b.content.length;a++)this.queueStoryMarkup(b.content[a]);}else this.queueStoryMarkup(b.content);if(b.custom_stories&&b.custom_stories.length){this._queueCustomStories(b.custom_stories);this._doCustomUpdate=true;}},queueStoryMarkup:function(a){var b=HTML(a).getRootNode();this.queueStory(b);},dedupeStory:function(c){var b=c.getAttribute('data-story-key');var a=b&&(!!this._objectIDs[b]||!!this._removedStoryIDs[b]);if(a)this._debug('discarding story: duplicated object id');b&&(this._objectIDs[b]=true);return a;},queueStory:function(d,a){if(this.dedupeStory(d))return;CSS.addClass(d,'queuedStory');DOM.appendContent(this._storyQueue,d);var b=a&&a.length;if(b)a.each(function(e){new Function(e).apply();});d.setAttribute('id',d.id+'_'+this._root.id);var c=this._getQueuedStories();c.slice(0,-this._maxQueueLength).each(DOM.remove);if(b)this._fetchedStories[d.id]=true;},_queueCustomStories:function(b){while(b.length){var c=b.shift();c=HTML(c).getRootNode();var d=c.getAttribute('data-story-key');if(this.dedupeStory(c))continue;CSS.addClass(c,'customStory');DOM.appendContent(this._storyQueue,c);}var a=this._getQueuedCustomStories();a.slice(0,-this._maxQueueLength).each(DOM.remove);},_cleanup:function(){TickerController._placeholders.pagelet_rhc_ticker=null;if(!Parent.byClass(this._content,'hasRightCol'))return;this._objectIDs=[];this._subscriptions.each(Arbiter.unsubscribe);this._channelConnectionSubscription&&this._channelConnection.unsubscribe(this._channelConnectionSubscription);this._pushSubscription&&Arbiter.unsubscribe(this._pushSubscription);for(var a in this._listeners)this._listeners[a]&&this._listeners[a].remove();clearTimeout(this._pollToken);this._pollToken=null;this._cleanupInputFocusListener();this._cleanupContentResizeListener();Arbiter.inform('Ticker/cleanup');},_onNavHandler:function(c,a){var b=a.params.key;if(b!='lf'&&b!='h')this._cleanup();},registerStoryDialog:function(b,a){if(this._uaCurStoryIDFetch==b.id){this._uaCurStoryIDFetch=null;this._logUserEvent('flyout','fetch_success');}if(this._uaCurStoryIDPrefetch==b.id){this._uaCurStoryIDPrefetch=null;this._logUserEvent('flyout_prefetch','prefetch_success');}this._fetchedStories[b.id]=true;a.setContext(b);a.subscribe('hide',this._deactivateStory.bind(this,true));a.subscribe('success',this._focusStory.bind(this,b));a.subscribe('beforehide',function(){if(this._selecting){this._selecting=false;return false;}}.bind(this));if(this._popupOnHover){a.subscribe('mouseenter',this._clearHoverTimeouts.bind(this));a.subscribe('mouseleave',this._scheduleHide.bind(this));a.subscribe('show',function(){this._highlightDialogScrollbar.bind(this,a).defer();var c=Event.listen(a.getContent(),'click',function(){this._selectStory(b);c.remove();}.bind(this));}.bind(this));}if(b==this._activeStory){this._logUserEvent('flyout_loadtime','show_fetched');this._logUserEvent('flyout','show');this._openDialog(a);}},_highlightDialogScrollbar:function(a){var b=DOM.scry(a.getContent(),'.uiScrollableArea')[0];b&&ScrollableArea.poke(b);},_openStoryExternally:function(d,event){var a=d.getAttribute('data-href');if(!a||a=='#')return;var c=d.getAttribute('data-story-rel');switch(c){case 'theater':this._deactivateAndClearStory();Bootloader.loadComponents('PhotoSnowbox',function(){PhotoSnowbox.bootstrap(a,d);});return;case 'async':this._deactivateAndClearStory();Bootloader.loadComponents('async',function(){AsyncRequest.bootstrap(a,d);});return;}var e=d.getAttribute('data-target');var b=(event.which!=1||event.getModifiers().any||e=='_blank');b?window.open(a,'_blank'):goURI(a);},_deactivateAndClearStory:function(){this._clearHoverTimeouts();this._deactivateStory();},_focusStory:function(a){clearTimeout(this._scrollDismissal);this._preventScrollDismiss=true;this._scrollDismissal=this._setTimeout(function(){this._preventScrollDismiss=false;}.bind(this),100);a.focus();},_selectStory:function(a){this._selectedStory=a;CSS.addClass(a,'tickerStorySelected');CSS.addClass(this._root,'tickerChildSelected');},_activateStory:function(c,b){this._clearHoverTimeouts();if(c==this._activeStory||!this._storyCanOpenDialog(c))return;this._deactivateStory();this._focusStory(c);this._activeStory=c;CSS.addClass(c,'tickerStoryActive');window.Toggler&&Toggler.hide();if(this._logFlyouts){b=b||'unknown';new AsyncSignal('/ajax/feed/ticker/flyout.php',{src:b}).send();}var a=this._getStoryDialog(c);if(a){this._logUserEvent('flyout_loadtime','show_prefetched');this._logUserEvent('flyout','show');this._openDialog(a);return;}if(!(c.id in this._fetchedStories)){this._uaCurStoryIDFetch=c.id;this._logUserEvent('flyout','fetch');}this._fetchStory(c);},_deactivateStory:function(a){if(this._activeStory===this._deactivatingStory)return;this._deactivatingStory=this._activeStory;if(this._dialog){this._dialog.setFadeOnHide(a===true).hide();this._logUserEvent('flyout','close');}if(this._activeStory){CSS.removeClass(this._activeStory,'tickerStoryActive');CSS.removeClass(this._activeStory,'tickerStorySelected');CSS.removeClass(this._root,'tickerChildSelected');}this._dialog=this._selectedStory=this._activeStory=null;this._cleanupInputFocusListener();this._cleanupContentResizeListener();this._deactivatingStory=null;document.activeElement.blur();},_logUserAction:function(a,b,event){user_action(b,a,event,'FORCE',null);},_logUserEvent:function(a,event){if(this._ua[a])this._ua[a].add_event(event);},_fetchStory:function(d){clearTimeout(this._fetchToken);var c=[];var a=this._getInsertedStories();var b=a.indexOf(d);[-2,-1,0,1,2].each(function(f){var e=a[b+f];e&&c.push(e);},this);this._fetchToken=setTimeout(this._fetchStories.bind(this,c),100);},_fetchStories:function(c){var a=[];var d;var b=function(e){clearTimeout(d);c.each(function(f){CSS.conditionClass(f,'tickerStoryFetching',e);});};c=c.filter(function(f){if(f.id in this._fetchedStories)return false;this._fetchedStories[f.id]=true;var e=this._getStoryDialogEndpoint(f);var g=URI(e).getQueryData();if(!e||!g)return false;g.uniq_id=f.getAttribute('id');g.referrer=this._tickerSource;a.push(g);return true;},this);if(!a.length)return;d=this._setTimeout(b.curry(true),500);new AsyncRequest('/ajax/feed/ticker/multi_story').setFinallyHandler(b.curry(false)).setErrorHandler(bagofholding).setData({stories:a}).setAllowCrossPageTransition(this._tickerInSidebarMode).send();},_tickerDeClicker:function(event){var f=event.getTarget();var d=Parent.byTag(f,'a');var e=this._getStoryFromNode(f);var b=this._getButtonFromNode(f);if(e&&d&&!b&&CSS.hasClass(e,'tickerStoryClickable')&&!CSS.hasClass(d,'tickerStoryAllowClick')&&!this._storyIsHidden(e)){d.setAttribute('rel','ignore');d.removeAttribute('onclick');d.removeAttribute('ajaxify');d.removeAttribute('href');}var c=(event.button==2);var a=this._getActionButtonFromStory(e);if(!c&&a)this._setClickedStory(e);},_handleMouseup:function(event){this._clearClickedStory();},_setClickedStory:function(a){this._clearClickedStory();CSS.addClass(a,'tickerStoryClicked');this._clickedStory=a;},_clearClickedStory:function(){if(this._clickedStory){CSS.removeClass(this._clickedStory,'tickerStoryClicked');this._clickedStory=null;}},_initInfiniteScrollListener:function(){var b=this._getInsertedStories();var a=Math.max(0,b.length-this._autoloadStoryIndex);this._infiniteScrollStory=b[a];this._checkInfiniteScroll();},_checkInfiniteScroll:function(){if(this._infiniteScrollStory){var b=Vector2.getElementPosition(this._infiniteScrollStory).y;var e=Vector2.getElementPosition(this._container).y+Vector2.getElementDimensions(this._container).y;if(b<e){var c=DOM.scry(this._root,'.tickerMorePager a')[0];if(c){var d=Parent.byClass(c,'stat_elem')||c;var a=new AsyncRequest(c.getAttribute('ajaxify')).setReadOnly(true).setRelativeTo(c).setStatusElement(d).setAllowCrossPageTransition(true).send();this._logUserEvent('stream','scroll');}this._infiniteScrollStory=null;this._autoloadStoryIndex=5;}}},_setFixed:function(b){if(!this._selectedStory)return;var a=this._getStoryDialog(this._selectedStory);if(a){a.setFixed(b);a.updatePosition();}},_setTimeout:function(b,a){return setTimeout(b,a,!this._tickerInSidebarMode);},_scrollDialogToBottom:function(){var a=this._dialog&&this._dialog.getContent();var c=a&&DOM.scry(a,'.uiScrollableAreaWrap')[0];var b=c&&ScrollableArea.getInstance(c);b&&b.scrollToBottom();},_openDialog:function(a){this._dialog=a.show();this._updateDialogPosition();this._writeSwfFrame(a);this._initCommentFocusListener.bind(this).defer();this._initContentResizeListener.bind(this).defer();this._stupidIE7VideoResizeHack(a);},_stupidIE7VideoResizeHack:function(a){if(ua.ie()===7){var b=DOM.scry(a.getContent(),'.uiVideoThumb .img');b.each(function(c){CSS.setStyle(c,'width','');});}},_updateDialogPosition:function(){var a=this._tickerInSidebarMode||!!Parent.byClass(this._root,'fixed_elem');this._dialog.setFixed(a);this._adjustFlyoutContentHeight();this._dialog.updatePosition();},_writeSwfFrame:function(b){var a=this._dialog&&this._dialog.getContent();var e=DOM.scry(a,'.swfObject')[0];if(!e)return;var d=e.getAttribute('data-swfid');if(d&&window[d]){var c=window[d];c.write(e);}},_initCommentFocusListener:function(){var a=this._dialog&&this._dialog.getContent();var b=a&&DOM.scry(a,'.tickerDialogFooter textarea')[0];if(!b)return;this._listeners.inputFocus=Event.listen(b,'focus',this._scrollDialogToBottom.bind(this));},_cleanupInputFocusListener:function(){if(this._listeners.inputFocus){this._listeners.inputFocus.remove();this._listeners.inputFocus=null;}},_initContentResizeListener:function(){var a=this._dialog&&this._dialog.getContent();if(!a)return;this._listeners.contentResize=Event.listen(a,'click',function(){this._dialog.updatePosition.bind(this._dialog).defer();}.bind(this));},_cleanupContentResizeListener:function(){if(this._listeners.contentResize){this._listeners.contentResize.remove();this._listeners.contentResize=null;}},_adjustFlyoutContentHeight:function(){var e=this._dialog&&this._dialog.getContent();var i=e&&DOM.scry(e,'.uiScrollableAreaWrap')[0];if(!i)return;var j=Vector2.getElementDimensions(i);var d=Vector2.getElementPosition(i);var l=DOM.scry(i,'.uiUfi .uiUfiComment');var f=Vector2.getViewportDimensions().y-this.FLYOUT_VIEWPORT_PADDING;var h=Math.min(this.FLYOUT_MAX_HEIGHT,f);var k=h-this.FLYOUT_TARGET_HEIGHT_OFFSET;for(var g=0;g<l.length;g++){var a=l[g];var c=Vector2.getElementPosition(a);var b=c.y-d.y;if(Math.abs(b-k)<=this.FLYOUT_OFFSET_THRESHOLD){k=b+this.FLYOUT_COMMENT_OFFSET;break;}}if(j.y>k){CSS.setStyle(i,'height',k+'px');CSS.setStyle(i,'max-height',null);}else{CSS.setStyle(i,'max-height',h+'px');CSS.setStyle(i,'height',null);}},_initObjectIDs:function(){stories=this._getAllStories();for(var b=0;b<stories.length;++b){var a=stories[b].getAttribute('data-story-key');a&&(this._objectIDs[a]=true);}},_handleChatOpened:function(){this._deactivateStory(true);},_handleChannelConnection:function(){this._checkChannelConnection();},_debug:function(a){this._tickerDebug&&console.log('ticker: ',a);},getNewest:function(){return this._newest;}};
function HomeAdFirstRightColumnController(){}HomeAdFirstRightColumnController.prototype={init:function(a){copy_properties(this,{_enableSidebar:a.enableSidebar,_tickerHeightOffset:200,contentCol:$('contentCol'),blueBar:$('blueBar'),_tickerMaxHeight:(a.tickerMaxHeight||500),_listeners:[],_subscriptions:[]});this._topOffset=0;this.PADDING_TICKER_TO_TOP=5;this.PADDING_RHC_TO_BOTTOM=60;this._sidebarIsHidden=true;this._listeners.push(Event.listen(window,'resize',this.handleResize.bind(this)));this._blueBarHeight=Vector2.getElementDimensions(this.blueBar).y;this.reloadRightCol();this._initSubscriptions();onunloadRegister(this.cleanup.bind(this));this._listeners.push(Event.listen(window,'scroll',this._handleScroll.bind(this)));if(!CSS.hasClass(document.documentElement,'sidebarMode')){this._onSidebarHide();}else if(this._enableSidebar)this._onSidebarShow();this.handleResize();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('Ticker/storiesInserted',this.handleResize.bind(this)),Arbiter.subscribe('concierge/load',this.handleResize.bind(this)),Arbiter.subscribe(UIIntentionalStreamMessage.INSERT_STORIES,this.handleResize.bind(this))];if(this._enableSidebar){this._subscriptions.push(Arbiter.subscribe('sidebar/hide',this._onSidebarHide.bind(this)));this._subscriptions.push(Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this)));}},_onNavHandler:function(c,a){var b=a.params.key;if(b!='lf'&&b!='h')this.cleanup();},reloadRightCol:function(){this.fixedScrollingContainer=ge('fixed_scrolling_container');this.fixedScrollingWrapper=DOM.scry(this.fixedScrollingContainer,'.fixed_scrolling_wrapper')[0];this.tickerPagelet=ge('pagelet_rhc_ticker');this.tickerContainer=DOM.scry(this.tickerPagelet,'.ticker_container')[0];this.tickerStream=DOM.scry(this.tickerPagelet,'.ticker_stream')[0];return this.tickerContainer&&this.tickerStream;},cleanup:function(){this._subscriptions.each(Arbiter.unsubscribe);this._subscriptions=[];this._listeners.each(function(a){a.remove();});this._listeners=[];},_handleScroll:function(){if(!this._sidebarIsHidden||!this.tickerStream)return;this._topOffset=this.PADDING_TICKER_TO_TOP+this._blueBarHeight;var b=CSS.hasClass(document.documentElement,'tinyViewport');var c=Vector2.getElementPosition(this.fixedScrollingContainer,'viewport').y;var a=!b&&c<this._topOffset;if(a!==CSS.hasClass(this.fixedScrollingWrapper,'fixed_elem'))this._setFixedRightCol(a);},_setFixedRightCol:function(a){var c=a?this._topOffset+'px':'';CSS.setStyle(this.fixedScrollingWrapper,'top',c);CSS.conditionClass(this.fixedScrollingWrapper,'fixed_elem',a);var b=a?'Ticker/fixed':'Ticker/unfixed';Arbiter.inform(b);},handleResize:function(){if(!this._sidebarIsHidden||!this.tickerStream||CSS.hasClass(document.documentElement,'tinyViewport'))return;this._handleScroll();var e=Vector2.getViewportDimensions().y;var b=Vector2.getElementDimensions(this.fixedScrollingWrapper).y-Vector2.getElementDimensions(this.tickerContainer).y;var a=e-this._topOffset-b-this.PADDING_RHC_TO_BOTTOM;var d=Vector2.getElementDimensions(this.tickerStream).y;var c=Math.min(a,d,this._tickerMaxHeight);CSS.setStyle(this.tickerContainer,'height',c+'px');},_onSidebarHide:function(){this._sidebarIsHidden=true;this.reloadRightCol();var a=function(){if(this.reloadRightCol())this.handleResize();};TickerController.show(this.tickerPagelet,a.bind(this));},_onSidebarShow:function(){this._sidebarIsHidden=false;this.reloadRightCol();this._setFixedRightCol(false);TickerController.hide(this.tickerPagelet);}};
function HomeTickerFirstRightColumnController(){}HomeTickerFirstRightColumnController.prototype={_isFixed:false,_forcedStatic:false,_PADDING_RHC_TO_BOTTOM:75,_refreshOn:false,init:function(a){copy_properties(this,{_adsRefreshInterval:a.adsRefreshInterval,_adsRefreshDelay:a.adsRefreshDelay,_adsRefreshOnmove:a.adsRefreshOnmove,_enableSidebar:a.enableSidebar,contentCol:$('contentCol'),blueBar:$('blueBar'),_tickerMaxHeight:(a.tickerMaxHeight||425),_tickerMinHeight:(a.tickerMinHeight||225),_tickerAbsMinHeight:(a.tickerAbsMinHeight||120),_listeners:[],_subscriptions:[]});this._listeners.push(Event.listen(window,'resize',throttle(this.handleResize.bind(this))));this.blueBarHeight=Vector2.getElementDimensions(this.blueBar).y;this.reloadRightCol();this._initSubscriptions();onunloadRegister(this.cleanup.bind(this));this._listeners.push(Event.listen(window,'scroll',throttle(this._handleScroll.bind(this))));if(this._adsRefreshOnmove)this._listeners.push(Event.listen(window,'mousemove',throttle(this._handleMove.bind(this))));this._lastAdLoadTime=Date.now();this._debounceReloadAdsIfNeeded=debounce(this._reloadAdsIfNeeded.bind(this),this._adsRefreshDelay,true);if(!CSS.hasClass(document.documentElement,'sidebarMode')){this._onSidebarHide();}else if(this._enableSidebar)this._onSidebarShow();this.handleResize();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('Ticker/storiesInserted',this.handleResize.bind(this)),Arbiter.subscribe('concierge/load',this.handleResize.bind(this)),Arbiter.subscribe(UIIntentionalStreamMessage.INSERT_STORIES,this.handleResize.bind(this))];if(this._enableSidebar){this._subscriptions.push(Arbiter.subscribe('sidebar/hide',this._onSidebarHide.bind(this)));this._subscriptions.push(Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this)));}},reloadRightCol:function(){this.rightColumn=DOM.scry(ge('rightCol'),'div.home_right_column')[0];this.rightColumnWrapper=DOM.find(this.rightColumn,'div.rightColumnWrapper');this.egoPagelet=ge('pagelet_ego_pane_w');if(!this.egoPagelet)this.egoPagelet=ge('pagelet_ego_pane_m');this._refreshOn=!this.containsPremium();this.tickerPagelet=ge('pagelet_rhc_ticker');this.tickerContainer=DOM.scry(this.tickerPagelet,'.ticker_container')[0];this.tickerStream=DOM.scry(this.tickerPagelet,'.ticker_stream')[0];return this.tickerContainer&&this.tickerStream;},containsPremium:function(){if(this.egoPagelet){var a=DOM.scry(this.egoPagelet,'.fbAdUnit');for(var b=0;b<a.length;b++){var c=JSON.parse(a[b].getAttribute('data-ad')).segment;if(c==='premium')return true;}}return false;},cleanup:function(){this._subscriptions.each(Arbiter.unsubscribe);this._subscriptions=[];this._listeners.each(function(a){a.remove();});this._listeners=[];},_handleScroll:function(){if(this._forcedStatic||!this.tickerStream)return;this._topOffset=this.blueBarHeight+Vector2.getElementPosition(this.blueBar,'viewport').y;var b=this._topOffset;var c=Vector2.getElementPosition(this.rightColumn,'viewport').y;var a=c<=b;if(a!==this._isFixed)this._setFixed(a);this._debounceReloadAdsIfNeeded();},_handleMove:function(){this._debounceReloadAdsIfNeeded();},_reloadAdsIfNeeded:function(){var a=Date.now();if(this._refreshOn&&this._adsRefreshInterval>0&&a-this._lastAdLoadTime>=this._adsRefreshInterval){this._lastAdLoadTime=a;UIPagelet.loadFromEndpoint('WebEgoPane',this.egoPagelet,{pid:27,data:{organic_only:false,ads_only:false,is_refresh:true}},{crossPage:false});}},_setFixed:function(a){this._isFixed=a;var c=a?this._topOffset+'px':'';CSS.setStyle(this.rightColumnWrapper,'top',c);CSS.conditionClass(this.rightColumnWrapper,'fixed_elem',a);var b=a?'Ticker/fixed':'Ticker/unfixed';Arbiter.inform(b);},handleResize:function(){if(!this._sidebarIsHidden||!this.tickerStream||CSS.hasClass(document.documentElement,'tinyViewport'))return;this._handleScroll();var h=Vector2.getViewportDimensions().y;var c=61;var f=Vector2.getElementDimensions(this.rightColumnWrapper).y-Vector2.getElementDimensions(this.tickerContainer).y;var g=Vector2.getElementDimensions(this.tickerStream).y;var b=h-f-this._PADDING_RHC_TO_BOTTOM-this._topOffset-c;var a=this._tickerAbsMinHeight;var e=this._tickerMinHeight;this._forcedStatic=false;if(b<a){this._forcedStatic=true;this._setFixed(false);b=a;}else if(b<e)if(b>(e-c)){b=e;}else b+=c;var d=Math.min(b,g,this._tickerMaxHeight);CSS.setStyle(this.tickerContainer,'height',d+'px');},_onSidebarHide:function(){this._sidebarIsHidden=true;this.reloadRightCol();var a=function(){if(this.reloadRightCol()){this._forcedStatic=false;this._handleScroll();this.handleResize();}};TickerController.show(this.tickerPagelet,a.bind(this));},_onSidebarShow:function(){this._sidebarIsHidden=false;this.reloadRightCol();this._forcedStatic=true;this._setFixed(false);TickerController.hide(this.tickerPagelet);}};
function FansJewel(){}FansJewel.prototype={init:function(a){this.jewel=a;this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));},_markSeenCallback:function(a,b){new AsyncRequest('/ajax/pages/fans_seen.php').setMethod('POST').send();}};
if(!window.JewelX){window.JewelX=function(){};copy_properties(JewelX,{_instancesByName:{},_resizeListener:null});Class.mixin(JewelX,'Arbiter',{init:function(b,a){this.name=a.name;this.root=b;this.countNew=0;this.initialCount=0;this.disableMarkAllRead=a.disableMarkAllRead||false;JewelX._instancesByName[this.name]=this;Toggler.listen(['show','hide'],this.root,function(d){var c=d==='show';c&&this._logFirstClick();if(!this.disableMarkAllRead){this.hasNew()&&this.markSeen();this.reset();}this.inform(c?'opened':'closed');Arbiter.inform(c?'layer_shown':'layer_hidden',{type:'Jewel'});}.bind(this));Arbiter.subscribe('jewel/count-updated',function(c,d){d.jewel==this.name&&this.update(d);}.bind(this));Arbiter.subscribe('jewel/count-initial',function(c,d){d.jewel==this.name&&this.setInitial(d);}.bind(this));Arbiter.subscribe('jewel/reset',function(c,d){d.jewel==this.name&&this.reset();}.bind(this));JewelX._resizeListener=JewelX._resizeListener||(function(){var c=null;return Event.listen(window,'resize',function(event){clearTimeout(c);c=Arbiter.inform.bind(Arbiter,'jewel/resize',event).defer(100,false);});})();},getRoot:function(){return this.root;},hasNew:function(){return CSS.hasClass(this.root,'hasNew');},isOpen:function(){return CSS.hasClass(this.root,'openToggler');},reset:function(){CSS.removeClass(this.root,'hasNew');},setContent:function(b){var a=DOM.find(this.root,'ul.jewelItemList');DOM.setContent(a,HTML(b));},update:function(b){this.countNew=b.count;var a=DOM.find(this.root,'span.jewelCount span');DOM.setContent(a,this.countNew);var c=isNaN(this.countNew)||this.countNew>0;CSS.conditionClass(this.root,'hasNew',c);this.inform('updated',b);},setInitial:function(a){this.initialCount=a;},markSeen:function(){Arbiter.inform('jewel/count-updated',{jewel:this.name,count:0},Arbiter.BEHAVIOR_STATE);this.inform('marked-seen');},_logFirstClick:function(){this._logFirstClick=bagofholding;report_data('jewel_click',{gt:{count:this.countNew,initial:this.initialCount,jewel:this.name}});}});}
__e("MessagingEvents",["array-extensions","arbiter","copyProperties","isEmpty"],function(g,j,i,f){j('array-extensions');var a=j('arbiter');var e=j('copyProperties');var h=j('isEmpty');var d={};var b=new a();function c(k){if(!h(d))return;for(var l in k)b.inform('count/'+l,k[l]);}b.subscribe('mark-as-read',function(k,l){(l.tids||l.chat_ids||[]).forEach(function(n){n=''+n;if(!(n in d)){d[n]=true;var o=function(){b.unsubscribe(p);clearTimeout(m);delete d[n];};var p=b.subscribe('read',function(q,r){if((r.tids||[]).contains(n)||(r.chat_ids||[]).contains(n))o();});var m=o.defer(60000);}});});a.subscribe('presence/message:messaging',function(k,m){var n=e({},m.obj);var event=n.event||'';delete n.type;delete n.event;b.inform(event,n);if('unread_counts' in n){var l=n.unread_counts;c({unread:l.inbox,other_unseen:l.other});}});a.subscribe('presence/message:inbox',function(k,l){var m=e(l.obj);delete m.type;c(m);});g.MessagingEvents=i.exports=b;},3);
function MessagesJewel(){}MessagesJewel.prototype={init:function(c,b){this.jewel=c;this.jewelFlyoutCase=ge('jewelFlyoutContainer');this.jewelFlyout=ge('fbMessagesFlyout');this.newCountSpan=ge('newMessageCount');this.folder=b;var a=ge('messagesMarkReadButton');if(a)Event.listen(a,'click',this._markRead.shield(this,true));this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));this.jewel.subscribe('updated',this._updateCount.bind(this));this.jewel.subscribe('opened',this._overflowHandler.bind(this));Arbiter.subscribe('jewel/resize',this._overflowHandler.bind(this));Arbiter.subscribe('jewel/messages/fetched',this._overflowHandler.bind(this));MessagingEvents.subscribe('count/unread',this._updateInboxUnreadCount.bind(this));MessagingEvents.subscribe('count/unseen',this._updateInboxUnseenCount.bind(this));MessagingEvents.subscribe('count/other_unseen',this._updateInboxOtherUnseenCount.bind(this));},_markRead:function(a,b){Arbiter.inform('jewel/count-updated',{jewel:'messages',count:0});},_markSeenCallback:function(a,b){MenubarMessageController.instance.markSeen(this.folder);},_updateCount:function(a,b){this.countNew=b.count;CSS.conditionClass(this.jewelFlyout,'beeperUnread',this.countNew>0);CSS.conditionClass(this.jewelFlyoutCase,'showMessages',this.countNew>0);if(this.newCountSpan){var c=this.countNew==1?_tx("{num} NEW MESSAGE",{num:this.countNew}):_tx("{num} NEW MESSAGES",{num:this.countNew});DOM.setContent(this.newCountSpan,c);}},_overflowHandler:function(){window.Unibeeper&&Unibeeper.hideOverflow(DOM.scry($('fbMessagesItemList'),'li'),DOM.find(this.jewelFlyout,'.jewelFooter'));},_updateInboxOtherUnseenCount:function(a,b){CounterDisplay.setCount('other_unseen',b);},_updateInboxUnreadCount:function(a,b){CounterDisplay.setCount('messages_unread',b);},_updateInboxUnseenCount:function(a,b){CounterDisplay.setCount('messages_unseen',b);Arbiter.inform('jewel/count-updated',{jewel:'messages',count:b},Arbiter.BEHAVIOR_STATE);}};
function RequestsJewel(){}RequestsJewel.prototype={init:function(d,c,b){this.countNew=0;this.jewel=d;this.jewelFlyoutCase=ge('jewelFlyoutContainer');this.jewelFlyout=ge('fbRequestsFlyout');this.newCountSpan=ge('newRequestCount');this.folder=c;this.doNewMarkRead=b;this._requestList={};this._requestCount=0;var a=ge('requestsMarkReadButton');if(a)Event.listen(a,'click',this._markRead.shield(this));this.jewel.subscribe('marked-seen',this._markSeenCallback.shield(this));this.jewel.subscribe('closed',this._clearNewItems.shield(this));this.jewel.subscribe('updated',this._updateCount.bind(this));this.jewel.subscribe('opened',this._openHandler.bind(this));Arbiter.subscribe('jewel/resize',this._overflowHandler.bind(this));window.Unibeeper&&Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/handled'),this._removeRequest.bind(this));LinkController.registerHandler(this._handleLink.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/add'),this._addRequest.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('jewel/requests/remove_old'),this._removeOldRequest.bind(this));Event.listen(this.jewelFlyout,'submit',function(f){var g=Parent.byClass(f.getTarget(),'objectListItem');if(g){CSS.removeClass(g,'jewelItemNew');CSS.addClass(g,'jewelItemResponded');}}.bind(this));var e=DOM.scry(this.jewelFlyout,'.uiScrollableAreaWrap')[0];if(e){this._scrollableWrap=e;this._lastLinkPosition=0;this._scrollListener=Event.listen(e,'scroll',this._handleScroll.bind(this),Event.Priority._BUBBLE);}return this;},fromDom:function(){DOM.scry(this.jewelFlyout,'.jewelItemList li.objectListItem').each(function(c){var b=c.getAttribute('id');var a=b&&parseInt(this._parseID(b).requester,10);if(a&&!isNaN(a)){this._requestList[a]=b;++this._requestCount;}}.bind(this));this._conditionShowEmptyMessage();},_parseID:function(a){var b=a.match(/^(\d+)_(\d+)/);return (b)?{requester:b[1],type:b[2]}:undefined;},_handleLink:function(b,event){var c=Parent.byClass(b,'jewelItemNew');if(c&&Parent.byClass(c,'fbRequestList')&&Parent.byClass(c,'beeperEnabled')){var a=this._parseID(c.id);a&&this._markSeenCallback(a.requester,a.type);Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});CSS.removeClass(c,'jewelItemNew');}return true;},_handleScroll:function(){var d=DOM.scry(this._scrollableWrap,'.uiMorePager')[0];if(d){var e=Vector2.getElementPosition(d,'viewport').y;if(e>0)CSS.addClass(Parent.byClass(this._scrollableWrap,'uiScrollableArea'),'contentAfter');var b=DOM.find(d,'a');if(!b)return;var c=Vector2.getElementPosition(b,'viewport').y;if(c==this._lastLinkPosition)return;var a=Vector2.getElementPosition(this._scrollableWrap,'viewport').y+Vector2.getElementDimensions(this._scrollableWrap).y;if(c-300<a&&c>0){this._lastLinkPosition=c;var f=b.getAttribute('ajaxify');if(f){new AsyncRequest(f).setRelativeTo(b).setStatusElement(Parent.byClass(b,'stat_elem')).send();}else FriendBrowserCheckboxController.getInstance('jewel').showMore();}}},_addRequest:function(a,b){if(!b||this._requestList[b.obj.from])return;var c=DOM.find(this.jewelFlyout,'.jewelItemList');elem=DOM.prependContent(c,b.obj.markup)[0];CSS.hide(DOM.find(c,'img.loadingIndicator'));var d={jewel:'requests',count:++this.countNew};Arbiter.inform('jewel/count-updated',d);this._requestList[b.obj.from]=elem.id;++this._requestCount;this._conditionShowEmptyMessage();},_removeOldRequest:function(a,b){if(!b)return;var d=this._requestList[b.obj.from];var c=d&&ge(d);if(c){CSS.hasClass(c,'jewelItemNew')&&Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});if(!CSS.hasClass(c,'jewelItemResponded')){DOM.remove(c);delete this._requestList[d];--this._requestCount;this._conditionShowEmptyMessage();}}},_markRead:function(){this.jewel.markSeen();this._clearNewItems();},_markSeenCallback:function(b,c){new AsyncSignal('/ajax/gigaboxx/endpoint/UpdateLastSeenTime.php',{folder:this.folder}).send();var a=typeof b!='undefined'&&typeof c!='undefined'?{requester:b,type:c}:{};this.doNewMarkRead&&new AsyncSignal('/ajax/requests/mark_read/',a).send();},_removeRequest:function(a,b){var c=b.obj.item_id;if(c){var d=ge(c);var e=d&&CSS.hasClass(d,'jewelItemNew');d?DOM.remove(d):false;e&&Arbiter.inform('jewel/count-updated',{jewel:'requests',count:--this.countNew});}},_clearNewItems:function(a,b){DOM.scry(this.jewel.root,'li.jewelItemNew').each(function(c){CSS.removeClass(c,'jewelItemNew');});},_updateCount:function(a,b){this.countNew=b.count;CSS.conditionClass(this.jewelFlyout,'beeperUnread',this.countNew>0);CSS.conditionClass(this.jewelFlyoutCase,'showRequests',this.countNew>0);if(this.newCountSpan){var c=this.countNew==1?_tx("{num} NEW REQUEST",{num:this.countNew}):_tx("{num} NEW REQUESTS",{num:this.countNew});DOM.setContent(this.newCountSpan,c);}},_conditionShowEmptyMessage:function(){DOM.scry(this.jewelFlyout,'li.empty').each(function(a){CSS.conditionShow(a,this._requestCount<=0);}.bind(this));},_openHandler:function(){var a=DOM.scry(this.jewelFlyout,'.uiScrollableArea')[0];a&&ScrollableArea.poke(a);this._overflowHandler();},_overflowHandler:function(){window.Unibeeper&&Unibeeper.hideOverflow(DOM.scry($('fbRequestsList'),'li'),DOM.find(this.jewelFlyout,'.jewelFooter'));}};
function IframeShim(a){this._element=a;this._shim=null;}IframeShim.prototype={show:function(){this._shim||this._buildShim();return this._updatePosition();},hide:function(){if(this._shim){DOM.remove(this._shim);this._shim=null;}return this;},_buildShim:function(){this._shim=$N('iframe',{frameBorder:0,scrolling:'no',src:'about:blank',style:{position:'absolute',filter:'progid:DXImageTransform.Microsoft.Alpha(style=0,opacity=0)'}});DOM.prependContent(document.body,this._shim);},_updatePosition:function(){var a=new Rect(this._element);a.getPositionVector().setElementPosition(this._shim);a.getDimensionVector().setElementDimensions(this._shim);}};
function DoublyLinkedListMap(){this._head=null;this._tail=null;this._nodes={};}DoublyLinkedListMap.prototype={get:function(a){return this._nodes[a]?this._nodes[a].data:null;},_insert:function(c,a,f,b){f&&!this._nodes[f]&&(f=null);var d=(f&&this._nodes[f])||(b?this._head:this._tail),e={data:a,key:c,next:null,prev:null};if(d){this.remove(c);if(b){e.prev=d.prev;d.prev&&(d.prev.next=e);d.prev=e;e.next=d;}else{e.next=d.next;d.next&&(d.next.prev=e);d.next=e;e.prev=d;}}e.prev===null&&(this._head=e);e.next===null&&(this._tail=e);this._nodes[c]=e;return this;},insertBefore:function(b,a,c){return this._insert(b,a,c,true);},insertAfter:function(b,a,c){return this._insert(b,a,c,false);},prepend:function(b,a){return this.insertBefore(b,a,this._head&&this._head.key);},append:function(b,a){return this.insertAfter(b,a,this._tail&&this._tail.key);},remove:function(b){var a=this._nodes[b];if(a){var c=a.next,d=a.prev;c&&(c.prev=d);d&&(d.next=c);this._head===a&&(this._head=c);this._tail===a&&(this._tail=d);delete this._nodes[b];}return this;},find:function(b){for(var a=this._head;a;a=a.next)if(b(a.data))return a.key;return null;},reduce:function(b,a){for(var c=this._head;c;c=c.next)a=b(c.data,a);return a;},exists:function(a){return !!this._nodes[a];},isEmpty:function(){return !this._head;}};
__e("maxlength-form-listener",["event-extensions","function-extensions","dom","input-methods","input-selection","object-core-utils"],function(e,h,g,d){h('event-extensions');h('function-extensions');var a=h('dom');var b=h('input-methods');var c=h('input-selection');d.enforce=function(k,m){var q=b.getValue(k);var l=q.length;var n=l-m;if(n>0){var o;var i;try{o=c.get(k);i=o.end;}catch(j){o=null;i=0;}if(i>=n)l=i;var p=l-n;if(p&&(q.charCodeAt(p-1)&64512)===55296)p--;i=Math.min(i,p);b.setValue(k,q.slice(0,p)+q.slice(l));if(o)c.set(k,Math.min(o.start,i),i);}};function f(event){var i=event.getTarget();var j=i.getAttribute&&parseInt(i.getAttribute('maxlength'),10);if(j>0&&a.isNodeOfType(i,['input','textarea']))d.enforce.bind(null,i,j).defer();}Event.listen(document.documentElement,{keydown:f,paste:f});h('object-core-utils').add_properties('Input',{enforceMaxLength:d.enforce});},3);
function startMessagingNavCountUpdater(h){var d=FutureSideNav.getInstance().getNodeForKey('inbox');if(!d)return;var c=DOM.scry(d,'span.count')[0];var b=DOM.scry(c,'span.countValue')[0];var a=new CounterDisplay('messages_unread',b,c,null,null,true);var f=FutureSideNav.getInstance().getNodeForKey('other');var g=DOM.scry(f,'span.count')[0];var e=DOM.scry(g,'span.countValue')[0];var i=DOM.scry(g,'span.maxCountIndicator')[0];new CounterMaxDisplay('other_unseen',e,g,null,null,true).setMaxCounter(h,i);}function CounterMaxDisplay(){this._maxValue=null;this._maxIndicatorNode=null;var a=[this].concat($A(arguments));return this.parent.construct.apply(this.parent,a);}Class.extend(CounterMaxDisplay,'CounterDisplay');copy_properties(CounterMaxDisplay.prototype,{setMaxCounter:function(a,b){this._maxValue=a;this._maxIndicatorNode=b;},paint:function(){var b=this._maxValue&&this._count>this._maxValue;var a=b?this._maxValue:this._count;if(this._maxIndicatorNode){DOM.setContent(this._maxIndicatorNode,b?'+':'');}else if(b)a=a+'+';DOM.setContent(this._valueNode,a);this._toggleNodes();}});
var MessagingConst={APP_ID:313785040330,XD_MESSAGE:{SANDBOX_READY:'sandbox_ready',SET_CONTENT:'set_content',HTML_SIZE:'html_size',REFRESH_SIZE:'refresh_size'},SHINGLE_SCROLL_TRIGGER:5,EVENTS:{MESSAGE_SENT:'messaging/message_sent'}};
function MessagingJewelMenubarController(b,a){this.parent.construct(this);this._content=ge(a);this._open=false;this._ua=new UserNoOp();Arbiter.subscribe([MessagingConst.EVENTS.MESSAGE_SENT,'chat/message-sent'],this._onSend.bind(this));Toggler.listen(['show','hide'],$(b),this._onToggle.bind(this));this._init();}Class.extend(MessagingJewelMenubarController,'MenubarMessageController');copy_properties(MessagingJewelMenubarController,{FETCH_URI:'/ajax/messaging/jewel_fetch.php',MARK_SEEN_URI:'/ajax/messaging/jewel_mark_seen.php',USER_ACTION_CONTEXT:'jewel',USER_ACTION_NAMESPACE:'messaging',ensureInitialized:function(d,c,a,b){if(MessagingJewelMenubarController.initialized||!ge(c))return false;var e=new MessagingJewelMenubarController(d,c);MessagingJewelMenubarController.instance=e;MenubarMessageController.instance=e;e.ensureInitialized(d,c,a,b);MessagingJewelMenubarController.initialized=true;}});copy_properties(MessagingJewelMenubarController.prototype,{_ua:null,_init:function(){this.initializeEvents();},initializeEvents:function(){var a=null;Event.listen(this._content,{mouseover:function(event){var b=event.getTarget();a=Parent.byTag(b,'li');if(a&&a!=b)CSS.addClass(a,'selected');},mouseout:function(event){a&&CSS.removeClass(a,'selected');a=null;}});},_fetch:function(){new AsyncRequest().setURI(MessagingJewelMenubarController.FETCH_URI).setMethod('GET').setData({action:'jewelPreview',seen:!this.fetchOnHover}).setReadOnly(true).setHandler(this._onFetchSuccess.bind(this)).setAllowCrossPageTransition(true).send();},_onFetchSuccess:function(){this._ua.add_event('fetch_success');Arbiter.inform.bind(Arbiter,'jewel/messages/fetched').defer(100);},_onSend:function(){this._dirty=true;},onCounterUpdate:function(){this.parent.onCounterUpdate();if(this._open)this.doRefetch();},_onToggle:function(b,a){this._open=(b=="show");this._ua=user_action(MessagingJewelMenubarController.USER_ACTION_CONTEXT).set_namespace(MessagingJewelMenubarController.USER_ACTION_NAMESPACE).set_ua_id('jewel_menu').add_event(b);if(this._open)this.doRefetch();},markSeen:function(){if(this.fetchOnHover)new AsyncSignal(MessagingJewelMenubarController.MARK_SEEN_URI,{action:'markSeen'}).send();}});
__e("HideContextualLayerOnScroll",["event-extensions"],function(c,e,d,b){e("event-extensions");function a(f){this.layer=f;f.subscribe('contextchange',this._handleContextChange.bind(this));f.subscribe('show',this.attach.bind(this));f.subscribe('hide',this.detach.bind(this));}a.prototype={attach:function(){if(this._listener)return;var f=this.layer.getScrollParent();if(f===window)return;this._listener=Event.listen(f,'scroll',this.layer.hide.bind(this.layer));},detach:function(){this._listener&&this._listener.remove();this._listener=null;},_handleContextChange:function(){this.detach();if(this.layer.isShown())this.attach();}};d.exports=a;});
__e("Quickling",["string-extensions","AjaxPipeRequest","arbiter","dom","PageTransitions","DataStore","DocumentTitle","copyProperties","isEmpty"],function(k,n,m,j){n("string-extensions");var a=n("AjaxPipeRequest");var b=n("arbiter");var c=n("dom");var f=n("PageTransitions");var d=n("DataStore");var e=n("DocumentTitle");var i=n("copyProperties");var l=n("isEmpty");var h={isActive:function(){return h._is_active||false;},init:function(q,p,o){if(h._is_initialized)return;i(h,{_is_initialized:true,_is_active:true,_session_length:p,_is_in_transition:false,_title_interval:false,_ie_cache_title:'',_version:q});h._instrumentTimeoutFunc('setInterval');h._instrumentTimeoutFunc('setTimeout');h._inactivePageRegex=new RegExp(o);f.registerHandler(h._transitionHandler,1);},_startQuicklingTransition:function(){h._is_in_transition=true;},_stopQuicklingTransition:function(){(function(){h._is_in_transition=false;}).defer();},isPageActive:function(r){if(r=='#')return false;r=new URI(r);if(r.getDomain()&&r.getDomain()!=URI().getDomain())return false;if(r.getPath()=='/l.php'){var p=r.getQueryData().u;if(p){p=URI(unescape(p)).getDomain();if(p&&p!=URI().getDomain())return false;}}var q=r.getPath();var o=r.getQueryData();if(!l(o))q+='?'+URI.implodeQuery(o);return !h._inactivePageRegex.test(q);},_setHTML:function(o,p){if(ua.ie()<=6){o.innerHTML=p;}else c.setContent(o,HTML(p).setDeferred(true));},_transitionHandler:function(o){a.setCurrentRequest(null);if(h._isTimeToRefresh())return false;if(!h.isPageActive(o))return false;window.ExitTime=(new Date()).getTime();removeHook('onafterloadhooks');removeHook('onloadhooks');_runHooks('onleavehooks');b.inform('onload/exit',true);h._startQuicklingTransition();new g(o).setCanvasId('content').send();return true;},_changePageTitle:function(o){o=o||'Facebook';e.set(o);if(ua.ie()){h._ie_cache_title=o;if(!h._title_interval)h._title_interval=window.setInterval(function(){var p=h._ie_cache_title;var q=e.get();if(p!=q)e.set(p);},5000,false);}},_replaceSyndicationLinks:function(r){var q=document.getElementsByTagName('link');for(var p=0;p<q.length;++p){if(q[p].rel!='alternate')continue;c.remove(q[p]);}if(r.length){var o=c.find(document,'head');o&&c.appendContent(o,HTML(r[0]));}},_isTimeToRefresh:function(){h._load_count=(h._load_count||0)+1;return h._load_count>=h._session_length;},_instrumentTimeoutFunc:function(o){window[o+'_native']=(function(q){var p=function p(s,r){return q(s,r);};return p;})(window[o]);window[o]=function _setTimeout(r,q,p){var s=window[o+'_native'](r,q);if(q>0)if(p!==false)onleaveRegister(function(){clearInterval(s);});return s;};}};function g(p){var o={version:h._version};this.parent.construct(this,p,{quickling:o});}Class.extend(g,'AjaxPipeRequest');g.prototype={_preBootloadFirstResponse:function(o){return true;},_fireDomContentCallback:function(){this._request.cavalry&&this._request.cavalry.setTimeStamp('t_domcontent');h._stopQuicklingTransition();f.transitionComplete();this._onPageDisplayed&&this._onPageDisplayed(this.pipe);this.parent._fireDomContentCallback();},_fireOnloadCallback:function(){if(this._request.cavalry){this._request.cavalry.setTimeStamp('t_hooks');this._request.cavalry.setTimeStamp('t_layout');this._request.cavalry.setTimeStamp('t_onload');}this.parent._fireOnloadCallback();},isPageActive:function(o){return h.isPageActive(o);},_versionCheck:function(o){if(o.version!=h._version){var p=['quickling','ajaxpipe','ajaxpipe_token'];go_or_replace(window.location,URI(o.uri).removeQueryData(p),true);return false;}else return true;},_processFirstResponse:function(q){var p=q.getPayload();h._changePageTitle(p.title);h._replaceSyndicationLinks(p.syndication||[]);window.scrollTo(0,0);var o=p.body_class||'';CSS.setClass(document.body,o);},getSanitizedParameters:function(){return ['quickling'];}};m.exports=h;});
var MusicEvents=new Arbiter();var MusicProviders={SPOTIFY:'open.spotify.com'};var MusicConstants=window.MusicConstants||{DEBUG:false,sameURLs:function(a,b){var c=/\/$/;return a&&b&&a.replace(c,'')==b.replace(c,'');},OP:{RESUME:'RESUME',PAUSE:'PAUSE',PLAY:'PLAY',VERSION:'VERSION'},STATUS_CHANGE_OP:{STATUS:'STATUS',LOGIN:'LOGIN',REINFORM:'REINFORM'},STATUS_CHANGE_EVENT:{playing:'PLAY_STATE_CHANGED',track:'TRACK_CHANGED'},DIAGNOSTIC_EVENT:{ALL_PAUSED:'ALL_PAUSED',ALL_OFFLINE:'ALL_OFFLINE',OFFLINE:'OFFLINE',ONLINE:'ONLINE',SEARCHING:'SEARCHING',HIT:'HIT',MISS:'MISS',RESIGN:'RESIGN',IFRAME_POLLING:'IFRAME_POLLING',RELAUNCH:'RELAUNCH',STATE_CHANGE:'STATE_CHANGE',WRONG_VERSION:'WRONG_VERSION',SERVICE_ERROR:'SERVICE_ERROR'},ALLOWED_STATUS_PARAMS:{playing:'playing',track:'track',context:'context',client_version:'client_version',start_time:'start_time',expires_in:'expires_in',open_graph_state:'open_graph_state'},ALLOWED_EXTERNAL_CONTEXT_PARAMS:{uri:true,song:true,radio_station:true,album:true,playlist:true,musician:true,song_list:true,offset:true,title:true,request_id:true,listen_with_friends:true,needs_tos:true},LIVE_LISTEN_OP:{NOW_LEADING:'NOW_LEADING',NOW_LISTENING:'NOW_LISTENING',END_SESSION:'END_SESSION',SONG_PLAYING:'SONG_PLAYING',LISTENER_UPDATE:'LISTENER_UPDATE',QUEUE_SESSION:'QUEUE_SESSION',PLAY_ERROR:'PLAY_ERROR',SESSION_UPDATED:'SESSION_UPDATED',QUEUING_SESSION:'QUEUING_SESSION'},MUSIC_BUTTON:{ACTIVATE:'ACTIVATE'},ERROR:{1:'SERVICE_UNAVAILABLE_WITHOUT_PREMIUM',2:'SERVICE_UNAVAILABLE_WITHOUT_PREMIUM_OR_WAIT',3:'SERVICE_UNAVAILABLE_BILLING_ISSUE',4:'SERVICE_UNAVAILABLE_TECHNICAL_ISSUE',5:'AUDIO_AD_PLAYING',99:'SERVICE_TEMPORARILY_UNAVAILABLE',101:'SONG_UNAVAILABLE_WITHOUT_PURCHASE',102:'SONG_UNAVAILABLE_WITHOUT_PREMIUM',103:'SONG_UNAVAILABLE_INDEFINITELY'}};
var MusicButton=function(d,a,f,b,c,e){this.provider=d;this.buttonElem=a;this.url=f;this.context=b||{};this.mediaType=c;this.setState(this.STATES.OFFLINE);this.tooltip=e||'';MusicEvents.subscribe(MusicConstants.MUSIC_BUTTON.ACTIVATE,this.processClick.bind(this));};copy_properties(MusicButton,{tracksetableTypes:[]});copy_properties(MusicButton.prototype,{SHOW_LOADING_TIMEOUT:500,HIDE_LOADING_TIMEOUT:4000,RECENTLY_ONLINE_TIMEOUT:6000,STATES:{PLAYING:'music_playing',PAUSED:'music_paused',LOADING:'music_loading',DISABLED:'music_disabled',OFFLINE:'music_offline'},setState:function(a){if(a!==this.STATES.LOADING){this.resetLoadingTimers();this.previousState=this.state||a;}if(a===this.STATES.PLAYING){Tooltip.set(this.buttonElem,this.tooltip);}else Tooltip.set(this.buttonElem,'');var b=this.buttonElem.parentNode;this.state&&CSS.removeClass(b,this.state);this.state=a;CSS.addClass(b,this.state);},isTracksetable:function(a){return MusicButton.tracksetableTypes.indexOf(this.mediaType)!==-1;},handleIncomingEvent:function(d,b){clearTimeout(this._showLoadingTimer);if(b&&b.provider&&b.provider!=this.provider)return;switch(d){case MusicConstants.DIAGNOSTIC_EVENT.ONLINE:case MusicConstants.STATUS_CHANGE_EVENT.track:case MusicConstants.STATUS_CHANGE_EVENT.playing:var c=b&&b.track&&b.track.uri;var a=b&&b.context&&b.context.uri;if(b&&b.playing&&(MusicConstants.sameURLs(c,this.url)||MusicConstants.sameURLs(a,this.url))){this.setState(this.STATES.PLAYING);}else if(this.state===this.STATES.LOADING&&(this.previousState===this.STATES.PAUSED||this.previousState===this.STATES.OFFLINE)){clearTimeout(this._attemptingPlayTimer);this._attemptingPlayTimer=this.setState.bind(this,this.STATES.PAUSED).defer(this.RECENTLY_ONLINE_TIMEOUT,false);}else if(!this._attemptingPlayTimer)this.setState(this.STATES.PAUSED);break;case MusicConstants.DIAGNOSTIC_EVENT.OFFLINE:this.setState(this.STATES.OFFLINE);break;case MusicConstants.DIAGNOSTIC_EVENT.ALL_OFFLINE:this.setState(this.STATES.OFFLINE);break;}},processClick:function(a,g){if(g!=this.buttonElem){if(this.state===this.STATES.LOADING)this.previousState&&this.setState(this.previousState);return;}var d=this.isTracksetable()&&Parent.byClass(this.buttonElem,'music_trackset_container');var k=[];if(d){var j=d.getAttribute('data-trackset-title');var f=this.provider;var e=DOM.scry(d,'.music_button');for(var h=0;h<e.length;h++){var c=MusicButtonManager.getButton([e[h].id]);if(c&&c.provider==f&&c.isTracksetable())k.push(c.url);}}var i=function(){return (d&&k.length>1)?Music.playPauseSongList(this.provider,this.url,k,j,this.context):Music.playPauseSong(this.provider,this.url,this.context);}.bind(this);if(!window.Music){this.showLoading(true);Bootloader.loadComponents('Music',i);return;}var b=i();this.showLoading(!b);},showLoading:function(a){this.resetLoadingTimers();this._hideLoadingTimer=this._timeout.bind(this,a).defer(this.HIDE_LOADING_TIMEOUT,false);this._showLoadingTimer=this.setState.bind(this,this.STATES.LOADING).defer(this.SHOW_LOADING_TIMEOUT,false);},resetLoadingTimers:function(){clearTimeout(this._hideLoadingTimer);clearTimeout(this._showLoadingTimer);clearTimeout(this._attemptingPlayTimer);this._attemptingPlayTimer=null;},destroy:function(){this.resetLoadingTimers();this.buttonElem=null;},_timeout:function(a){window.Music&&Music.reInform([this.provider]);if(!a&&this.state===this.STATES.LOADING)this.setState(this.STATES.PAUSED);}});
var MusicButtonManager=(function(){var g=null;var b={};var a={};function c(event){var j=$E(event).getTarget();var i=Parent.byClass(j,'music_button');i=i||(!event.getModifiers().any&&d(j));if(!i)return;return f(i,event);}function d(k){var j=Parent.byClass(k,'music_button_trigger')&&Parent.byClass(k,'music_button_trigger_group');if(j){var i=DOM.scry(j,'.music_button');if(i.length)return i[0];}return null;}function f(i,event){event&&$E(event).stop();MusicEvents.inform(MusicConstants.MUSIC_BUTTON.ACTIVATE,i);return false;}function h(i){window.Music&&Music.reInform(i);}function e(k,j){for(var i in b)if(b[i].noGC||ge(i)){b[i].handleIncomingEvent(k,j);}else MusicButtonManager.removeButton(i);}return {init:function(i){if(g)return;g=true;MusicButton.tracksetableTypes=i||[];Event.listen(document.body,'click',c);MusicEvents.subscribe([MusicConstants.STATUS_CHANGE_EVENT.playing,MusicConstants.STATUS_CHANGE_EVENT.track,MusicConstants.DIAGNOSTIC_EVENT.OFFLINE,MusicConstants.DIAGNOSTIC_EVENT.ALL_OFFLINE,MusicConstants.DIAGNOSTIC_EVENT.ONLINE],e);},getButton:function(i){return b[i];},addButton:function(m,i,n,j,l,o){g||MusicButtonManager.init();if(!ge(i))return;b[i];b[i]=new MusicButton(m,$(i),n,copy_properties({button_id:i},j),l,o);var k=Parent.byClass($(i),'uiOverlay');if(k){b[i].noGC=true;Overlay.getInstance(k).subscribe('destroy',MusicButtonManager.removeButton.curry(i));}if(m&&!a[m])a[m]=function(){var p=keys(a);p.length&&h(p);a={};}.defer();return b[i];},removeButton:function(i){b[i]&&b[i].resetLoadingTimers();delete b[i];}};})();
function NotificationList(a,b){this._list=new DoublyLinkedListMap();this.unreadCount=0;this.contentRoot=a;this.noItemsElement=null;this.ITEM_TAG='li';this.ITEM_CLASS='notification';this.NO_ITEMS_ID='jewelNoNotifications';this.NO_ITEMS_CLASS='empty';this.compare=b.compare||this.compare;}copy_properties(NotificationList,{ITEM_UNREAD_CLASS:'jewelItemNew',MARK_READ_TYPE:'mark_read',UNREAD_COUNT_CHANGE_TYPE:'unread_count_change',getIdFromDom:function(a){return a.getAttribute('id').replace('notification_','');},localizeUrls:function(a){DOM.scry(a,'a').each(function(b){URI(b.href).isFacebookURI()&&(b.href=URI(b.href).getUnqualifiedURI().getQualifiedURI().setSubdomain(URI(b.href).getSubdomain()).toString());});}});Class.mixin(NotificationList,'Arbiter',{_getField:function(c,b){var a=this._list.get(c);return a&&a[b];},getDomObj:function(a){return this._getField(a,'obj');},fromDom:function(){var e=this.ITEM_TAG+'.'+this.ITEM_CLASS;var c=DOM.scry(this.contentRoot,e);for(var d=0;d<c.length;++d){var b=c[d];var a=NotificationList.getIdFromDom(b);this.insert(a,b.getAttribute('data-notiftime'),null);}},compare:function(b,a){return b.time<=a.time;},insert:function(c,e,d,i,b){var h=true,g=0;if(this._list.exists(c))if(!(i&&d)){return false;}else{h=this._getField(c,'unread');g=this._getField(c,'time');if(g>e)return false;this.remove(c);}var f=(d&&HTML(d).getRootNode())||$('notification_'+c),j=Math.max(e,g),k=CSS.hasClass(f,NotificationList.ITEM_UNREAD_CLASS),a={id:c,obj:f,time:j,unread:k};this._insert(a);NotificationList.localizeUrls(f);hide(this.NO_ITEMS_ID);if(k){this.unreadCount=this.getUnreadIds().length;this.inform(NotificationList.UNREAD_COUNT_CHANGE_TYPE);b&&!h&&this.markRead([c]);}Arbiter.inform('notif/insert',{id:c,obj:f});return true;},showNoNotifications:function(){if(null==this.noItemsElement)this.noItemsElement=ge(this.NO_ITEMS_ID);if(null==this.noItemsElement){this.noItemsElement=$N(this.ITEM_TAG,{id:this.NO_ITEMS_ID,className:this.NO_ITEMS_CLASS},"No new notifications.");DOM.appendContent(this.contentRoot,this.noItemsElement);}CSS.show(this.NO_ITEMS_ID);},_insert:function(a){this._list.remove(a.id);var c=null;this._list.find(function(d){var e=this.compare(d,a);!e&&(c=d.id);return e;}.bind(this));var b=this.getDomObj(c);if(b){this._list.insertAfter(a.id,a,c);DOM.insertAfter(b,a.obj);}else{this._list.prepend(a.id,a);DOM.prependContent(this.contentRoot,a.obj);}},remove:function(a){var b=this._getField(a,'obj');if(!b)return false;this.markRead([a]);this._list.remove(a);DOM.remove(b);this._list.isEmpty()&&this.showNoNotifications();return true;},getUnreadIds:function(){return this._list.reduce(function(a,b){a.unread&&b.push(a.id);return b;},[]);},isUnreadId:function(a){return this._getField(a,'unread');},markRead:function(a){a=a?a.filter(this.isUnreadId.bind(this)):this.getUnreadIds();for(var b=0;b<a.length;b++){var c=this._list.get(a[b]);if(c){this.inform(NotificationList.MARK_READ_TYPE,c.obj);c.unread=false;this._insert(c);}}if(a.length){this.unreadCount=this.getUnreadIds().length;this.inform(NotificationList.UNREAD_COUNT_CHANGE_TYPE);}},insertMany:function(d,a){if('object'==typeof d&&!is_empty(d)){for(var c in d){var b=d[c];this.insert(c,b.time,b.markup,true,a);}hide(this.NO_ITEMS_ID);}else this.isEmpty()&&this.showNoNotifications();},isEmpty:function(){return this._list.isEmpty();}});function Notifications(a){this.updateTime=a.updateTime||Date.now();this.user=Env.user;this.cache_version=a.cacheVersion||0;this.allowDesktopNotifications=a.allowDesktopNotifications||false;this.latest_notif_time=a.latestNotif||0;this.latest_read_notif_time=a.latestReadNotif||0;this.update_period=a.updatePeriod||60000;this.notifReceivedType=a.notifReceivedType||'notification';this.wrapperID=a.wrapperID||'notificationsWrapper';this.contentID=a.contentID||'jewelNotifs';this.timeElement='small.time';this.ua=new UserNoOp();this._init();}Notifications.BEEPS_EXPIRED='beeper/beeps_expired';Notifications.prototype={_init:function(){this.cookieName='notifications_'+this.user;this.beepsExpiredToken=null;this.updateCheckCount=0;this.needMarkRead=false;this.currentFetchRequest=null;this.wrapper=ge(this.wrapperID);this.content=ge(this.contentID);this.jewelFlyout=ge('fbNotificationsFlyout');this.loadingIndicator=ge(this.contentID+'_loading_indicator');NotificationCounter.init();this.alertList=new NotificationList(this.content,this._getListParams());this._updateCount();window.MinNotifications&&MinNotifications.fetched()&&(this.fetch=bagofholding);Arbiter.subscribe(PresenceMessage.getArbiterMessageType(this.notifReceivedType),this._handleNotificationMsg.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('notifications_read'),this._handleNotificationsReadMsg.bind(this));this.alertList.subscribe(NotificationList.UNREAD_COUNT_CHANGE_TYPE,this._updateCount.bind(this));this._poller=new Poller(this.update_period,this._update.bind(this),true);if(this.wrapper)this.countSpan=DOM.find(this.wrapper,'span.jewelCount span');this.initializeEvents();this.fromDom();},_getListParams:function(){return {};},fromDom:function(){this.alertList.fromDom();},initializeEvents:function(){var a=null;Event.listen(this.content,{mouseover:function(event){var b=event.getTarget();a=Parent.byTag(b,'li');if(a&&b!=a)CSS.addClass(a,'selected');},mouseout:function(event){a&&CSS.removeClass(a,'selected');a=null;}});Event.listen(this.wrapper,'mouseover',this.onMouseOver.bind(this));Toggler.listen('show',this.wrapper,this.onClick.bind(this));Toggler.listen('hide',this.wrapper,this.onHide.bind(this));},onMouseOver:function(event){this.ua=user_action('jewel',event.target,event).set_namespace('notifs').set_ua_id('prefetch').add_event('hover');this.fetch();},onClick:function(){window.ArbiterMonitor&&this.fetch!=bagofholding&&Arbiter.registerCallback(bagofholding,['notifs/fetched']);this.ua.add_event('show');this.fetch();this.markRead(true);},onHide:function(){this.ua.add_event('hide');this.markRead(true);},signalMarkRead:function(a){a=a||[];if(a.length===0&&this.currentFetchRequest){this.needMarkRead=true;return;}data={};for(var b=0;b<a.length;++b)data['alert_ids['+b+']']=a[b];new AsyncSignal(URI('/ajax/notifications/mark_read.php').getQualifiedURI().toString(),data).send();},markRead:function(b,a){if(this.alertList.unreadCount===0)return;b&&this.signalMarkRead(a);this.alertList.markRead(a);this._updateCount();},_updateErrorHandler:function(a){},_updateURI:'/ajax/presence/update.php',_update:function(a){a.setHandler(this._handleUpdate.bind(this)).setOption('suppressErrorAlerts',true).setErrorHandler(this._updateErrorHandler.bind(this)).setData({user:this.user,notif_latest:this.latest_notif_time,notif_latest_read:this.latest_read_notif_time}).setURI(this._updateURI).setAllowCrossPageTransition(true);},_handleUpdate:function(b){var a=b.payload.notifications;if(!a.no_change){this.updateTime=b.payload.time;this.latest_notif_time=a.latest_notif;this.latest_read_notif_time=a.latest_read_notif;this._updateDisplayDelayed();this.alertList.insertMany(a.notifications);}},_updateDisplayDelayed:function(){if(typeof Beeper!='undefined'){this.beepsExpiredToken=Arbiter.subscribe(Notifications.BEEPS_EXPIRED,this._updateDisplay.bind(this));}else this._updateDisplay();},_updateDisplay:function(){if(!this.content)return;this._updateCount();if(this.beepsExpiredToken)Arbiter.unsubscribe(this.beepsExpiredToken);},_updateCount:function(){Arbiter.inform('jewel/count-updated',{jewel:'notifications',count:this.alertList.unreadCount},Arbiter.BEHAVIOR_STATE);},fetch:function(){var a=URI('/ajax/notifications/get.php');if(this.currentFetchRequest)return true;this.ua.add_event('fetch');a.setQueryData({time:this.latest_notif_time,user:this.user,version:this.cache_version,locale:Env.locale});this.currentFetchRequest=new AsyncRequest().setURI(a).setStatusElement(this.loadingIndicator).setMethod('GET').setReadOnly(true).setTimeoutHandler(30000,this.fetchErrorHandler.bind(this)).setHandler(this.fetchHandler.bind(this)).setErrorHandler(this.fetchErrorHandler.bind(this)).setAllowCrossPageTransition(true);!this.currentFetchRequest.send()&&this.fetchErrorHandler();return true;},fetchErrorHandler:function(a){this.currentFetchRequest=null;this.ua.add_event('fetch_error');},fetchHandler:function(b){this.ua.add_event('fetch_success');var a=b.getPayload();this.alertList.insertMany(a.notifications,true);this.loadingIndicator&&CSS.hide(this.loadingIndicator);this.loadingIndicator=null;this.currentFetchRequest=null;this.fetch=bagofholding;if(this.needMarkRead){this.needMarkRead=false;this.signalMarkRead();}window.ArbiterMonitor&&Arbiter.inform('notifs/fetched','',Arbiter.BEHAVIOR_STATE);},_mergeNotification:function(b,d,c){var a=!this.alertList.isUnreadId(b);this.alertList.insert(b,d,c,true);this.latest_notif_time=0;if(a)this._updateCount();if(this.isTabOpen())this._merged_mouseover_handler=Event.listen(this.content,'mouseover',(function(){this._merged_mouseover_handler.remove();this.markRead(true);}).bind(this));},_handleNotificationMsg:function(d,a){var b=a.obj;if(typeof this.useDesktopNotifications=='undefined'){var c;this.useDesktopNotifications=this.allowDesktopNotifications&&window.webkitNotifications&&window.webkitNotifications.checkPermission()===0;}if(this.useDesktopNotifications)Bootloader.loadComponents('desktop-notifications',function(){DesktopNotifications.addNotification(b.alert_id);});b.time=b.time||Date.now();if(b.markup){this._mergeNotification(b.alert_id,b.time,b.markup);}else this._poller.requestNow();},_handleNotificationsReadMsg:function(c,a){var b=a.obj;if(typeof Beeper!='undefined')Beeper.getInstance().markRead(false,b.alert_ids);this.markRead(false,b.alert_ids);},isTabOpen:function(){return this.wrapper&&CSS.hasClass(this.wrapper,'openToggler');}};
function OriginalNotifications(a){this.parent.construct(this,a);}Class.extend(OriginalNotifications,'Notifications');copy_properties(OriginalNotifications.prototype,{_init:function(){this.parent._init();this.alertList.subscribe(NotificationList.MARK_READ_TYPE,this._animateMarkRead.bind(this));Arbiter.subscribe('jewel/resize',this._hideOverflow.shield(this));},fetchHandler:function(c){this.parent.fetchHandler(c);var b=c.getPayload();var d=b.generated;var a=Math.round((new Date()).getTime()/1000);if(a-d>15)d=a;Bootloader.loadComponents('live-timer',function(){LiveTimer.restart(d);LiveTimer.startLoop(0);});this._hideOverflow();},_mergeNotification:function(a,c,b){this.parent._mergeNotification(a,c,b);var d=this.alertList.getDomObj(a);if(d)Bootloader.loadComponents('live-timer',function(){LiveTimer.addTimeStamps(d);});},_animateMarkRead:function(a,b){animation(b).duration(5000).checkpoint().from('backgroundColor','#EFF1F7').to('backgroundColor','#FFFFFF').duration(2250).ondone(CSS.removeClass.bind(null,b,NotificationList.ITEM_UNREAD_CLASS)).go();},onClick:function(){this.parent.onClick();this._hideOverflow();},_updateCount:function(){this.parent._updateCount();this._hideOverflow();},_hideOverflow:function(a,d){a=a||DOM.find(this.jewelFlyout,'.jewelFooter');d=d||DOM.scry($('fbNotificationsList'),'.notification');if(!d.length||(CSS.hasClass(document.documentElement,'tinyViewport')&&!CSS.hasClass(document.body,'fixedBody'))){d.each(CSS.show);return;}var b=Vector2.getViewportDimensions().y-Vector2.getElementPosition(d[0],'viewport').y-Vector2.getElementDimensions(a).y,c=0;for(;c<d.length&&b>0;++c){CSS.show(d[c]);b-=Vector2.getElementDimensions(d[c]).y;}b<0&&--c;for(;c<d.length;++c)CSS.hide(d[c]);}});
function SearchDataSource(b){this._token=b.token||'';this._lazyonload=b.lazyonload===false?false:true;this._leanOnAllTypes=b.leanOnAllTypes;this._extraTypes=b.extraTypes;this._buckets=b.buckets;this._noMultiFetch=b.noMultiFetch||false;var a=b.maxResults||8;this.parent.construct(this,b);this._numResults={min:3,max:a};this._genTime=b.genTime;}Class.extend(SearchDataSource,'DataSource');SearchDataSource.prototype={init:function(){this.parent.init();this._leanPayload=null;this._bootstrapRequestsPending=0;this._criticalOnly=true;this._updateMaxResults();Event.listen(window,'resize',this._updateMaxResults.bind(this));},dirty:function(){this.parent.dirty();this._fetchOnUseRequests=[];},asyncErrorHandler:function(a){if(window.Dialog&&Dialog.getCurrent()==null&&a.getError()==1400003)AsyncResponse.verboseErrorHandler(a);},fetch:function(b,a,c){c=c||{};c.fetch_start=Date.now();this.parent.fetch(b,a,c);},fetchHandler:function(e,c){var d=e.getPayload();var f=copy_properties({fetch_end:Date.now()},c);var b=f.value?Arbiter.BEHAVIOR_EVENT:Arbiter.BEHAVIOR_PERSISTENT;if(c.type=='lean'){this._leanPayload=d;this._processLean();}else{this.parent.fetchHandler(e,c);if(c.bootstrap&&!e.getRequest().getData().no_cache)f.browserCacheHit=(d.timestamp<this._genTime);if(c.bootstrap&&!d.no_data&&this._bootstrapRequestsPending>0){c.bootstrap=false;--this._bootstrapRequestsPending;!this._bootstrapRequestsPending&&this._bootstrapPostProcess();}if(d.no_data||d.token!==this._token){var a=copy_properties({},e.getRequest().getData());if(a.lazy){delete a.lazy;a.token=this._token;this._fetchOnUse(a,c);}}}this.inform('endpointStats',f,b);},_bootstrapPostProcess:function(){var a={time:Date.now()};this.inform('bootstrapped',a,Arbiter.BEHAVIOR_PERSISTENT);this._processLean();},_processLean:function(){if(this._leanPayload){var b;var a=this._leanPayload.entries;for(var c in a){b=this.getEntry(c);b&&(b.index=a[c]);}this.setExclusions(this._leanPayload.blocked);this._leanPayload=null;}},_updateMaxResults:function(){var a=window.innerHeight||document.documentElement.clientHeight;this.setMaxResults(Math.max(this._numResults.min,Math.min(this._numResults.max,Math.ceil(2+((a-370)/56)))));},_bootstrapFetch:function(c,b){var a=copy_properties(b,this.bootstrapData);if(this._criticalOnly&&this._lazyonload)a.lazy=1;this.fetch(this.bootstrapEndpoint,a,{bootstrap:true,type:c});++this._bootstrapRequestsPending;},_fetchOnUse:function(a,b){for(var c in this.bootstrapData)!a.hasOwnProperty(c)&&(a[c]=this.bootstrapData[c]);if(this._criticalOnly){this._fetchOnUseRequests.push({args:a,ctx:b});}else this.fetch(this.bootstrapEndpoint,a,b);},_fetchLean:function(){var a={filter:['user'],no_cache:1};if(this._leanOnAllTypes)a={no_cache:1};a.options=$A(a.options);a.options.push('lean');this._fetchOnUse(a,{type:'lean'});},bootstrap:function(b){if(!b){this._criticalOnly=false;this._flushFetchOnUseRequests();}if(this._bootstrapped)return;var c={filter:['event'],no_cache:1};this._fetchOnUse(c,{type:'event'});var d=['app','page','group','friendlist'];d=d.concat(this._extraTypes||[]);if(this._noMultiFetch){d.push('user');this._bootstrapFetch('user',{filter:d});}else{this._bootstrapFetch('other',{filter:d});if(this._buckets){for(var e=0;e<this._buckets.length;++e){var a={filter:['user'],buckets:this._buckets[e]};this._bootstrapFetch('user',a);}}else this._bootstrapFetch('user',{filter:['user']});}this._fetchLean();this._bootstrapped=true;},_flushFetchOnUseRequests:function(){var c=this._fetchOnUseRequests.length;for(var b=0;b<c;++b){var a=this._fetchOnUseRequests[b];this.fetch(this.bootstrapEndpoint,a.args,a.ctx);}this._fetchOnUseRequests=[];},onLoad:function(a,b){this.inform('onload',{time:Date.now()},Arbiter.BEHAVIOR_PERSISTENT);if(a)this.bootstrap.bind(this,b).defer();}};
function SearchTypeaheadCore(a){this.parent.construct(this,a);}Class.extend(SearchTypeaheadCore,'TypeaheadCore');SearchTypeaheadCore.prototype={init:function(a,f,d){this.parent.init(a,f,d);var b=Parent.byTag(d,'form'),c=this.reset.bind(this);if(b){var e=DOM.find(b,'input.search_sid_input');Event.listen(b,'submit',function(){if(this.data&&this.data.queryData)e.value=this.data.queryData.sid;c.defer();}.bind(this),Event.Priority.URGENT);}},select:function(){this.reset();this.element.focus();(function(){this.element.blur();}).bind(this).defer();},handleTab:function(event){var a=this.view.getQuerySuggestion(this.value);if(a){Input.setValue(this.element,a);this.checkValue();event.kill();}else this.parent.handleTab(event);}};
__e("hide-contextual-layer-on-scroll",["HideContextualLayerOnScroll"],function(a,b){a.HideContextualLayerOnScroll=b('HideContextualLayerOnScroll');},3);
function ContextualTypeaheadView(a,b){this.parent.construct(this,a,b);}Class.extend(ContextualTypeaheadView,'TypeaheadView');ContextualTypeaheadView.prototype={init:function(){this.parent.init();this.initializeLayer();},initializeLayer:function(){this.context=this.element.parentNode;this.wrapper=$N('div');DOM.appendContent(this.wrapper,this.element);this.layer=new ContextualLayer().init(this.wrapper).addBehaviors([HideContextualLayerOnScroll]).setContext(this.context).setPosition('below').show();},show:function(){this.layer&&this.layer.show();CSS.setStyle(this.wrapper,'width',this.context.offsetWidth+'px');return this.parent.show();},hide:function(){this.layer&&this.layer.hide();return this.parent.hide();},refresh:function(){if(this.isVisible())this.layer&&this.layer.show();}};
function BucketedTypeaheadView(a,b){this.parent.construct(this,a,b);}Class.extend(BucketedTypeaheadView,'ContextualTypeaheadView');BucketedTypeaheadView.prototype={render:function(c,a,b){a=this.buildBuckets(c,a);return this.parent.render(c,a,b);},highlight:function(a,b){if(a==-1&&this.index!==0)a=this.index;if(a>=0&&a<this.items.length&&this.results[a].type=='header')a=a+1;this.parent.highlight(a,b);},buildBuckets:function(i,f){if(!this.typeObjects)return f;var b=[];var h={};for(var d=0;d<f.length;++d){var c=f[d];var g=c.render_type||c.type;if(!h.hasOwnProperty(g)){h[g]=b.length;b.push([this.buildBucketHeader(g)]);}c.classNames=g;c.groupIndex=h[g];c.indexInGroup=b[c.groupIndex].length-1;b[c.groupIndex].push(c);}var a=[];for(var e=0;e<b.length;++e)a=a.concat(b[e]);return a;},buildBucketHeader:function(b){var a=this.typeObjects[b];if(a.markup){a.text=a.markup;delete a.markup;}return this.typeObjects[b];},buildResults:function(b){var a=this.parent.buildResults(b);return $N('div',{className:'bucketed'},[a]);},select:function(a){var b=this.results[this.index];if(b&&b.type!='header')this.parent.select(a);},getDefaultIndex:function(c){var a=(this.autoSelect&&!this.disableAutoSelect);var b=c.length===0?-1:(c[0].type=='header'?1:0);return this.index<0&&!a?-1:b;},prev:function(){var a=this.results[this.index-1];if(a&&a.type=='header')this.index--;return this.parent.prev();},next:function(){var a=this.results[this.index+1];if(a&&a.type=='header')this.index++;return this.parent.next();}};
function SearchTypeaheadView(a,b){this.parent.construct(this,a,b);}Class.extend(SearchTypeaheadView,'BucketedTypeaheadView');SearchTypeaheadView.prototype={initializeLayer:function(){this.parent.initializeLayer();this.layer.setOffsetY(-1);},ignoreClick:function(event){event.prevent();},shouldShowSeeMore:true,queryData:{init:'quick'},buildBuckets:function(c,b){var a=b.length;b=this.parent.buildBuckets(c,b);if(c&&this.shouldShowSeeMore)b.push(this.buildSeeMore(c,a));return b;},buildSeeMore:function(e,c){var d=c>0?_tx("See more results for {query}",{query:e}):_tx("See results for {query}",{query:e});var a=c==1?"Displaying top result":_tx("Displaying top {number} results",{number:c});var b=$N('li',{className:'calltoaction'},[$N('a',{href:this.getSeeMoreEndpoint(e),rel:'ignore'},[$N('span',{className:'text'},[$N('span',{className:'seeMore'},[d,$N('span',{className:'arrow'})]),$N('span',{className:'subtext'},[a])])])]);return {uid:'search',node:b,search:true};},searchPageQueryData:function(a){return copy_properties({q:a},this.queryData||{});},select:function(b){var d=this.index;var e=this.results[d];if(!e||e.type=='header')return;var c=this.items[d];var a=DOM.scry(c,'a')[0];if(e.song){if(a)MusicEvents.inform(MusicConstants.MUSIC_BUTTON.ACTIVATE,a);b&&this.inform('highlight',{index:d,selected:e});}else{this.parent.select(b);if(a&&a.href)if(a.target=='_blank'){window.open(a.href);}else goURI(a.href);}},setSid:function(a){this.queryData.tas=a;},getSeeMoreEndpoint:function(a){return URI(this.seeMoreEndpoint).addQueryData(this.searchPageQueryData(a)).toString();},show:function(){Arbiter.inform('layer_shown',{type:'SearchTypeahead'});this.parent.show();},hide:function(){Arbiter.inform('layer_hidden',{type:'SearchTypeahead'});this.parent.hide();},getQuerySuggestion:function(c){var a=this.results[this.index];var b=a&&a.type!='header'?a.text.toLowerCase():'';return b==c.toLowerCase()?'':b;}};
function SearchTypeaheadRecorder(a){this.init(a);this.initEvents();}SearchTypeaheadRecorder.prototype={_endPoint:'/ajax/typeahead/record_metrics.php',init:function(a){this.core=a.getCore();this.data=a.getData();this.view=a.getView();this.element=this.core.getElement();this.initTime=Date.now();this._onloadTime=0;this.initStartTime=$('search_first_focus').value;this.bootstrapStats={bootstrapped:0};this._reset();},_reset:function(){this.stats={};this.avgStats={};this.appendStats={};this._backspacing=false;this._inflightRequests={};var a=Math.random();this.data.setQueryData({sid:a});this.view.setSid(a);this.recordStat('sid',a);},initEvents:function(){this.core.subscribe('focus',function(event){if(!this.stats['session_start_time'])this.recordStat('session_start_time',Date.now());}.bind(this));this.core.subscribe('blur',function(event){var b=Date.now();for(var d in this._inflightRequests){var c=this._inflightRequests[d];var a=b-c;this.recordAvgStat('search_endpoint_ms_from_js',a);}this.recordStat('session_end_time',b);this.submit();}.bind(this));this.view.subscribe('select',function(a,b){this.recordSelectInfo(b);}.bind(this));this.view.subscribe('render',function(a,b){this.recordRender(b);}.bind(this));this.data.subscribe('activity',function(a,b){this.recordStat('pending_request',b.activity);}.bind(this));this.data.subscribe('beforeQuery',function(a,b){if(!b.value)return;if(!this.stats.first_query_time)this.recordStat('first_query_time',Date.now());this.query=b.value;this.recordCountStat('num_queries');}.bind(this));this.data.subscribe('queryEndpoint',function(a,b){this.recordCountStat('num_search_ajax_requests');this.recordAvgStat('endpoint_query_length',b.value.length);this._inflightRequests[b.value]=Date.now();}.bind(this));this.data.subscribe('onload',function(a,b){this._onloadTime=b.time;}.bind(this));this.data.subscribe('bootstrapped',function(a,b){this.bootstrapStats.endTime=b.time;this.bootstrapStats.bootstrapped=1;}.bind(this));this.data.subscribe('endpointStats',function(a,c){var b=c.fetch_end-c.fetch_start;if(c.value){this.recordAvgStat('search_endpoint_ms_from_js',b);}else this.bootstrapStats[c.type]=b;if(typeof c.browserCacheHit!='undefined')this.recordCountStat(c.browserCacheHit?'bootstrap_cachehits':'bootstrap_cachemisses');if(this._inflightRequests[c.value])delete this._inflightRequests[c.value];}.bind(this));this.data.subscribe('query',function(a,b){this.recordAvgStat('num_results_from_cache',b.results.length);}.bind(this));Event.listen(this.element,'keydown',function(event){if(Event.getKeyCode(event)==KEYS.BACKSPACE){if(!this._backspacing){this._backspacing=true;this.recordAppendStat('before_backspace_queries',this.query);}}else this._backspacing=false;}.bind(this));},recordStat:function(a,b){this.stats[a]=b;},recordCountStat:function(a){var b=this.stats[a];this.stats[a]=b?b+1:1;},recordAvgStat:function(a,b){if(this.avgStats[a]){this.avgStats[a][0]+=b;++this.avgStats[a][1];}else this.avgStats[a]=[b,1];},recordAppendStat:function(a,b){if(!this.appendStats.hasOwnProperty(a))this.appendStats[a]=[];this.appendStats[a].push(b);},recordRender:function(a){this.results=a.filter(function(b){return b.uid!='search'&&b.type!='header';});if(this.results.length>0&&!this.stats.first_result_time)this.recordStat('first_result_time',Date.now());},recordSelectInfo:function(c){var f=c.selected;var b=c.index-f.groupIndex-1;var d={href:f.path};var a=f.dataGT?{gt:JSON.parse(f.dataGT)}:{};user_action('click',d,null,null,a);if(f.uid=='search'){this.recordStat('selected_search',1);}else{var g=f.rankType||f.render_type||f.type;var e=(g=='friend'?'user':g);this.recordStat('selected_'+e,1);this.recordStat('selected_position',b);this.recordStat('selected_type',g);this.recordStat('selected_name_length',f.text.length);this.recordStat('selected_id',f.uid);this.recordStat('selected_degree',f.bootstrapped?1:2);}this.recordStat('selected_with_mouse',c.clicked?1:0);},_dataToSubmit:function(){this.recordStat('candidate_results',this.buildResults());this.recordStat('query',this.query);this.recordStat('init_time',this.initTime);if(this.initStartTime){this.recordStat('init_start_time',this.initStartTime);this.recordStat('onload_time',this._onloadTime);this.initStartTime=0;}this.recordStat('bootstrapped',this.bootstrapStats.bootstrapped);if(this.bootstrapStats.endTime){this.recordStat('bootstrapped_time',this.bootstrapStats.endTime);this.recordStat('user_bootstrap_ms',this.bootstrapStats.user);this.recordStat('other_bootstrap_ms',this.bootstrapStats.other);this.bootstrapStats.endTime=0;}this.recordStat('max_results',this.data._maxResults);var b=this.stats;for(var d in this.avgStats){var c=this.avgStats[d];b[d]=c[0]/c[1];}for(var a in this.appendStats)b[a]=JSON.stringify(this.appendStats[a]);return b;},buildResults:function(){var a=(this.results||[]).map(function(d,c){var e=d.rankType||d.render_type||d.type;var b=d.bootstrapped?1:0;if(typeof d.groupIndex=='number')return [d.groupIndex,d.indexInGroup,d.uid,e,b];return [0,c,d.uid,e,b];});return JSON.stringify(a);},submit:function(){var a=this._dataToSubmit();if(count(a)>0)new AsyncRequest().setURI(this._endPoint).setMethod('POST').setData({stats:a}).setOption('handleErrorAfterUnload',true).setErrorHandler(function(b){a.retry=true;new AsyncRequest().setURI(this._endPoint).setMethod('POST').setData({stats:a}).setOption('asynchronous',false).send();}.bind(this)).send();this._reset();}};
add_properties('TypeaheadBehaviors',{searchRecorderBasic:function(a){a.subscribe('init',function(b,c){new SearchTypeaheadRecorder(a);});}});
add_properties('TypeaheadRenderers',{search:function(d,f){var h=[];if(d.photo){h.push($N('img',{className:'photo',alt:'',src:d.photo}));if(d.song){h.push($N('span',{className:'playButton'}));h.push($N('span',{className:'playLoader'}));}}if(d.text){var a=d.alias;var l=this.value;var j=d.text;var k=[j];if(a&&TypeaheadUtil.isQueryMatch(l,a)&&!TypeaheadUtil.isQueryMatch(l,j))k.push($N('span',{className:'alias'},[' \xB7 '+a]));h.push($N('span',{className:'text'},k));}if(d.category){var b=[d.category];if(d.is_external)b.push($N('span',{className:'arrow'}));h.push($N('span',{className:'category'},b));}if(d.subtext)h.push($N('span',{className:'subtext'},[d.subtext]));var c=d.classNames||d.type||'';var i=d.is_external?'_blank':'';var e=!d.song&&d.path||'';if(e){if(!(/^https?\:\/\//).test(e))e=Env.www_base+e.substr(1);e+=(e.indexOf('?')>0?'&':'?')+'ref=ts';}var g=$N('a',{href:e,rel:'ignore',target:i},h);if(d.song){g.id='mb_'+(Math.random()*1e+06|0);MusicButtonManager.addButton.curry(d.song.provider,g.id,d.song.url,d.song.context,d.song.media_type).defer();g.onclick=this.ignoreClick;}return $N('li',{className:c},[g]);}});
void(0);
add_properties('TypeaheadBehaviors',{initFilters:function(a){Arbiter.subscribe('search/typeahead/updateFilter',function(c,b){a.getView().queryData.type=b.filter_type;});Arbiter.subscribe('page_transition',function(c,b){delete a.getView().queryData.type;},Arbiter.SUBSCRIBE_NEW);}});
function UIIntentionalStream(j,e,h,i,c,m,n,d,g,b,f,a,k,l){if(!j)throw new Error('UIIntentionalStream instantiated with no root.');copy_properties(this,{id:j.id,root:j,instanceName:e,newest:h,oldest:i,oldestMR:i,firstLoadIDs:d,shouldShowHidden:false,defaultFilter:c,currentFilterKey:b,sourceType:m,streamStoryCount:n,maxUnseenStoryCount:g,lastSeenTime:f,hasPendingRefresh:false,pauseAutoInsert:false,unseenStoryCount:0,streamHeader:ge('pagelet_stream_header'),error:DOM.scry(j,'div.UIIntentionalStream_Error')[0],pager:DOM.scry(j,'div.uiMorePager')[0],filterNullState:DOM.scry(j,'div.friendListFilterNullState')[0],streamContent:DOM.find(j,'.UIIntentionalStream_Content'),requestNum:0,scrollLoadCount:1,maxScrollLoadCount:1,boulderFeed:a,scrollPosition:k,lastViewStateID:0,shouldRenderCount:l,scrollListener:null,conowingoCount:0,conowingoNewest:0});this.setUpStreamHeader();if(this.streamStoryCount>0)this.updateLiveFeedCount(this.streamStoryCount);onleaveRegister(this.unload.bind(this));if(!UIIntentionalStream.instances)UIIntentionalStream.instances={};UIIntentionalStream.instances[e]=this;UIIntentionalStream.instance=this;this.setupAutoInsert();this.setupSubscriptions();Arbiter.inform(UIIntentionalStreamMessage.INITIALIZE_COMPLETE,{},Arbiter.BEHAVIOR_PERSISTENT);}UIIntentionalStream.isHighlightsFilter=function(a){if(!a)return false;var b=a.startsWith(UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS);return b;};UIIntentionalStream.prototype.subscribeToComposerPublish=function(){this.subscriptions.push(Arbiter.subscribe('composer/publish',function(event,a){if(a.streamStory)this.addComposerContent(a.streamStory,500);}.bind(this)));};UIIntentionalStream.prototype.setupSubscriptions=function(){this.subscriptions=[];this.subscribeToComposerPublish();this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,this.updateStream.bind(this)));this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,this.refreshStream.bind(this)));if(this.boulderFeed){this.scrollListener=Event.listen(window,'scroll',this.checkScroll.bind(this));this.checkScroll();}};UIIntentionalStream.prototype.tearDownSubscriptions=function(){if(!this.subscriptions)return;this.subscriptions.forEach(Arbiter.unsubscribe);this.subscriptions=null;if(this.scrollListener){this.scrollListener.remove();this.scrollListener=null;}};UIIntentionalStream.prototype.unload=function(){this.tearDownSubscriptions();UIIntentionalStream.instance=null;UIIntentionalStream.instances[this.instanceName]=null;this.clearScrollLoader(true);window.disableScrollLoad=null;UIIntentionalStreamRefresh.instance&&UIIntentionalStreamRefresh.instance.unload();};UIIntentionalStream.getInstance=function(a){return UIIntentionalStream.instances[a];};UIIntentionalStream.prototype._getUpdateInsertType=function(){if(this.isOnNewHighlights()&&(!this.boulderFeed||this.shouldRenderCount))return UIIntentionalStream.REFRESH_COUNT;return UIIntentionalStream.REFRESH_PREPEND;};UIIntentionalStream.prototype.updateStream=function(a){if(a!=UIIntentionalStreamMessage.UPDATE_STREAM||this.hasPendingRefresh||this.isAutoRefreshPaused())return;this.loadNewer({showLoader:false,ignoreSelf:true,insertType:this._getUpdateInsertType()});};UIIntentionalStream.prototype.clearScrollLoader=function(a){if(this.currentScrollListener){this.currentScrollListener.remove();this.currentScrollListener=null;}if(a||this.scrollLoadCount>=this.maxScrollLoadCount)window.disableScrollLoad=true;};UIIntentionalStream.prototype.loadOlderPosts=function(b){var a={filter:this.getCurrentFilterKey(),oldest:this.oldest,oldestMR:this.oldestMR,last_seen_time:this.lastSeenTime,scroll_count:this.scrollLoadCount,scroll_position:this.scrollPosition,last_viewstate_id:this.lastViewStateID};a=merge(a,b);this.loadWithParams(a);};UIIntentionalStream.prototype.loadWithParams=function(a){var b=DOM.scry(this.root,'div.fbStreamPager.hasMorePosts')[0];if(b){if(CSS.hasClass(b,'async_saving'))return;CSS.addClass(b,'async_saving');}UIPagelet.loadFromEndpoint('MoreStoriesPagelet','home_stream',a,{usePipe:true,append:true});};UIIntentionalStream.prototype.setScrollLoadCount=function(a){this.maxScrollLoadCount=a;};UIIntentionalStream.prototype.loadMoreOnScroll=function(b,a,c){if(window.disableScrollLoad)return;var e=function(){if(window.disableScrollLoad)return;if(window.ArbiterMonitor){var h=user_action('scroll',null,null,'FORCE',{gt:{ua_id:'stream:scroll:auto'}});h.set_namespace('stream');ArbiterMonitor.initUA(h);}var g={delay_load_count:a};if(!this.boulderFeed&&this.scrollLoadCount==1&&this.firstLoadIDs&&this.firstLoadIDs.length>0)g=merge(g,{first_load_ids:this.firstLoadIDs,show_hidden:this.shouldShowHidden,query_time:c});this.loadOlderPosts(g);}.bind(this);var f=DOM.scry(this.root,'ul.uiStream li.genericStreamStory');if(!f.length)return;var d=f[f.length-b-1];if(d){this.currentScrollListener=new OnVisible(d,e,null,0,{detect_speed:this.scrollLoadCount>1});}else e();};UIIntentionalStream.prototype.updateTimeRange=function(a,b){if(!this.newest||this.newest<a)this.newest=a;if(!this.oldest||(b&&(b<this.oldest)))this.oldest=b;};UIIntentionalStream.prototype.updateOldestMR=function(a){if(!this.oldestMR||a<this.oldestMR)this.oldestMR=a;};UIIntentionalStream.prototype.getID=function(){return this.id;};UIIntentionalStream.prototype.getCurrentFilterKey=function(){if(this.currentFilterKey)return this.currentFilterKey;var a=URI.getMostRecentURI().getQueryData();if(a&&a.sk){this.currentFilterKey=a.sk;}else if(a&&a.filter){this.currentFilterKey=a.filter;}else if(this.defaultFilter)this.currentFilterKey=this.defaultFilter;return this.currentFilterKey;};UIIntentionalStream.prototype.resetFilterKey=function(a){this.currentFilterKey=a;};UIIntentionalStream.prototype.loadOlder=function(a){a=a||{};if(!this.oldest)return;var b=this.getCurrentParams();b.oldest=this.oldest;this.refresh(UIIntentionalStream.REFRESH_APPEND,b,a);return this;};UIIntentionalStream.prototype.loadNewer=function(b){if(!this.newest)return;b=b||{};var a=this.getCurrentParams();a.newest=this.newest;if(b.ignoreSelf)a.ignore_self=true;a.load_newer=true;var c=coalesce(b.insertType,UIIntentionalStream.REFRESH_PREPEND);this.refresh(c,a,b);return this;};UIIntentionalStream.prototype.expandRecentStories=function(){if(!this.shouldRenderCount)return;this.shouldRenderCount=false;var c=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer');var b=this.getCurrentParams();b.newest=this.newest;b.active_mode=true;b.pager_count=this.conowingoCount;if(this.conowingoNewest>this.newest)this.newest=this.conowingoNewest;var e=bagofholding;var d=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');CSS.addClass(d,'async_saving');var a=c.childNodes.length;if(this.conowingoCount==a){e=function(){CSS.hide(d);this.shiftPrefetchStories();}.bind(this);}else if(this.conowingoCount>20){b.replace_pager=true;b.delay_load_count=20-a;}this.slideIn(c,d,e);this.refresh(UIIntentionalStream.REFRESH_BUBBLE,b,{});};UIIntentionalStream.prototype.showRecentStoriesPager=function(a){if(!a)return;this.verifyPagerStyling();animation(a).from('opacity',0).to('opacity',1).show().ondone(function(){Arbiter.inform('reflow');}).go();new AsyncSignal('/ajax/feed/show_pager.php',{count:this.conowingoCount}).send();};UIIntentionalStream.prototype.verifyPagerStyling=function(){if(!this.shouldRenderCount)return;DOM.prependContent(this.streamContent,$N('li'));};UIIntentionalStream.prototype.slideIn=function(f,e,a){var g=f.parentNode;var c=$N('div',{style:{marginTop:'-10000px'}},f);var d=$N('div',{style:{overflow:'hidden'}},c);CSS.setStyle(c,'opacity',0);CSS.show(f);DOM.prependContent(g,d);var b=Vector2.getElementDimensions(c).y;CSS.setStyle(c,'marginTop','-'+b+'px');animation(e).from('opacity',1).to('opacity',0).ondone(function(){var h=e.offsetHeight;CSS.setStyle(c,'paddingBottom',h+'px');CSS.hide(e);animation(c).duration(1000).to('marginTop',0).to('paddingBottom',0).to('opacity',1).ease(animation.ease.both).ondone(function(){DOM.replace(d,f);a();}).go();}).go();};UIIntentionalStream.prototype.shiftPrefetchStories=function(){var a=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer');if(!a.childNodes.length)return;DOM.prependContent(this.streamContent,$A(a.childNodes));CSS.hide(a);var b=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');CSS.removeClass(b,'async_saving');Arbiter.inform('reflow');};UIIntentionalStream.prototype.checkScroll=function(){if(this.scrollListener&&Vector2.getScrollPosition().y>0){new AsyncSignal('/ajax/feed/scroll_detect.php').send();this.scrollListener.remove();this.scrollListener=null;}};UIIntentionalStream.prototype.getCurrentParams=function(){var a={};var b=URI.getMostRecentURI().getQueryData();b.filter=this.getCurrentFilterKey();var c=this.getValidParams();if(c){c.forEach(function(d){a[d]=b[d];});}else a=b;return a;};UIIntentionalStream.prototype.setHomeFilter=function(a){this._homeFilter=a;};UIIntentionalStream.prototype.setHomeFilterLoading=function(a){if(this._homeFilter)this._homeFilter.setLoading(a);};UIIntentionalStream.prototype.setConowingoCount=function(a){this.conowingoCount=a;this.shouldRenderCount=!!this.conowingoCount;};UIIntentionalStream.prototype.setConowingoNewest=function(a){if(a>this.conowingoNewest)this.conowingoNewest=a;};UIIntentionalStream.prototype.updateRecentStoryCount=function(b){this.setConowingoCount(b);if(this.boulderFeed){var c=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');if(this.shouldRenderCount){var d=DOM.find(c,'span.fbStreamRecentStoriesText');var a;if(this.conowingoCount==1){a=_tx("{count} NEW STORY",{count:b});}else if(b<=100){a=_tx("{count} NEW STORIES",{count:b});}else a="100+ NEW STORIES";DOM.setContent(d,a);if(CSS.hasClass(c,'hidden_elem'))this.showRecentStoriesPager(c);}else CSS.hide(c);}};UIIntentionalStream.prototype.updateRenderedStories=function(b){if(this.boulderFeed&&this.shouldRenderCount){var a=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer');DOM.setContent(a,HTML(b));}};UIIntentionalStream.prototype.incrementTransitionalNux=function(a){if(this.incrementedTransitionalNux)return;this.incrementedTransitionalNux=true;var c='/ajax/feed/nux/transitional_increment';var b={location:a};new AsyncSignal(c,b).send();};UIIntentionalStream.prototype.refresh=function(j,a,f){Arbiter.inform(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME);this.currentFilterKey=a.filter;if(a.filter==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED){this.currentFilterKey=this.defaultFilter;}else if(UIIntentionalStream.isHighlightsFilter(a.filter)||a.filter===UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED)this.defaultFilter=this.currentFilterKey;f=f||{};var h=++this.requestNum;var i=coalesce(f.showLoader,true);var e=this.instanceName;var d=function(k){UIIntentionalStream.getInstance(e).handleResponse(h,j,k,f);};var b=function(k){UIIntentionalStream.getInstance(e).handleError(h,j,k,f);};var c=function(k){UIIntentionalStream.getInstance(e).handleFinally(j,a.filter,k);};if(!(a.request_type=j))a.request_type='none';if(a.filter){f.show_hidden=a.show_hidden?a.show_hidden:false;}else f.show_hidden=this.shouldShowHidden;a=copy_properties(this.getCurrentParams(),a);this.hasPendingRefresh=true;var g;if(j==UIIntentionalStream.REFRESH_APPEND&&i)g=this.pager;new AsyncRequest().setURI(this.getEndpoint()).setReadOnly(true).setOption('retries',0).setMethod(this.getRefreshMethod()).setData(a).setHandler(d).setStatusElement(g).setErrorHandler(b).setFinallyHandler(c).send();if(j==UIIntentionalStream.REFRESH_TRANSITION){hide(this.pager);this.clearScrollLoader(true);this.oldest=this.newest=null;}if(i)this.setHomeFilterLoading(true);};UIIntentionalStream.prototype.addComposerContent=function(a,b){if(this.boulderFeed&&this.isOnNewsFeedFilter()){CSS.addClass(a,'uiStreamBoulderHighlight');}else CSS.removeClass(a,'uiStreamBoulderStyle');this.addContentPrepend(a,b);};UIIntentionalStream.prototype.addContentPrepend=function(a,b){if(a.length){$A(a).reverse().forEach(function(h){this.addContentPrepend(h,b);}.bind(this));return;}var d;var f=Vector2.getScrollPosition().y;var c=Vector2.getElementPosition(this.streamContent).y;var g=this.scrollOnPrepend&&f>=c;if(g){var e=function(h){var i=DOM.find(h,'^li.uiStreamStory');if(!i)return;DataStore.set(i,'origHeight',i.offsetHeight);Event.listen(h,'load',function(){var j=DataStore.get(i,'origHeight');if(i.offsetHeight!=j){window.scrollBy(0,i.offsetHeight-j);DataStore.set(i,'origHeight',i.offsetHeight);}});};d=animation.insert.curry(this.streamContent,a,(function(i,h){DOM.prependContent(this.streamContent,h);Arbiter.inform('reflow');window.scrollBy(0,h.offsetHeight);DOM.scry(h,'img').forEach(e);}).bind(this));}else d=(function(){CSS.setStyle(a,'opacity',0);DOM.prependContent(this.streamContent,a);Arbiter.inform('reflow');animation(a).from('opacity',0).to('opacity',1).duration(400).go();}).bind(this);if(b){setTimeout(d,b);}else d();};UIIntentionalStream.prototype.addContentAppend=function(a){DOM.appendContent(this.streamContent,a);};UIIntentionalStream.getStoriesByAssoc=function(a){return DOM.scry(UIIntentionalStream.instance.root,'div.aid_'+a);};UIIntentionalStream.prototype.handleResponse=function(e,h,f,c){c=c||{};var d=f.getPayload();this.filterNullState&&DOM.remove(this.filterNullState);if(is_empty(d))return;if(d.streamHeader&&this.streamHeader){DOM.setContent(this.streamHeader,HTML(d.streamHeader));if(this.isOnNewsFeedFilter())this.setUpStreamHeader();NewHigh.reset();}if(d.autoRefreshConfig)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,d.autoRefreshConfig);this.setHomeFilterLoading(false);if(h==UIIntentionalStream.REFRESH_EXPAND){var g=DOM.find($(c.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.hide(g);CSS.removeClass(g,'UIIntentionalStory_CollapsedStoriesLoading');}if(this.error)hide(this.error);if(e!=this.requestNum)return;if('show_hidden' in c)this.shouldShowHidden=c.show_hidden;if('newestStoryTime' in d&&d.newestStoryTime>this.newest)this.newest=d.newestStoryTime;if('oldestStoryTime' in d&&(!this.oldest||d.oldestStoryTime<this.oldest))this.oldest=d.oldestStoryTime;if('streamStoryCount' in d)this.updateLiveFeedCount(d.streamStoryCount);if(this.boulderFeed&&'conowingoCount' in d){this.updateRecentStoryCount(d.conowingoCount);if('conowingoHTML' in d)this.updateRenderedStories(d.conowingoHTML);if('conowingoNewest' in d)this.setConowingoNewest(d.conowingoNewest);}else if(d.storyCount&&!this.boulderFeed)this.updateLiveFeedCount(d.storyCount,true);if(!d.html){if(h==UIIntentionalStream.REFRESH_BUBBLE)this.shiftPrefetchStories();}else{var a=HTML(d.html).getNodes();switch(h){case UIIntentionalStream.REFRESH_BUBBLE:if(d.replaceCurrentStories){DOM.empty(this.streamContent);this.scrollPosition=d.scrollPosition;this.lastViewStateID=d.lastViewStateID;this.oldest=d.oldest;}this.addContentPrepend(a);this.shiftPrefetchStories();break;case UIIntentionalStream.REFRESH_COUNT:case UIIntentionalStream.REFRESH_PREPEND:this.addContentPrepend(a);break;case UIIntentionalStream.REFRESH_APPEND:this.addContentAppend(a);this.clearScrollLoader(true);break;case UIIntentionalStream.REFRESH_TRANSITION:DOM.setContent(this.streamContent,a);var b=this.streamContent.firstChild;if(!c.noScroll)DOMScroll.scrollTo(new Vector2(0,0,"document"),false);break;case UIIntentionalStream.REFRESH_EXPAND:DOM.insertAfter($(c.expandStoryID),a);break;case UIIntentionalStream.DELAYED_STREAM:this.addContentAppend(a);break;}this.verifyPagerStyling();Arbiter.inform(UIIntentionalStreamMessage.UPDATE_HTML_CONTENT);}};UIIntentionalStream.prototype.updateLiveFeedCount=function(c,b){var d=(this.unseenStoryCount==0||!b);if(b){this.unseenStoryCount+=c;}else this.unseenStoryCount=c;if(this.unseenStoryCount>0&&this.liveFeedCount){var a='';if(this.unseenStoryCount>this.maxUnseenStoryCount){a=this.maxUnseenStoryCount+'+';}else a=this.unseenStoryCount.toString();DOM.setContent(this.liveFeedCount,HTML(a));if(d)CSS.show(this.liveFeedBubble);}};UIIntentionalStream.prototype.handleError=function(c,f,d,b){if(c!=this.requestNum)return;this.setHomeFilterLoading(false);var a=d.getError();if(a==1357001)AsyncResponse.defaultErrorHandler(d);if(f==UIIntentionalStream.REFRESH_EXPAND){var e=DOM.find($(b.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.removeClass(e,'UIIntentionalStory_CollapsedStoriesLoading');}if(!b.delayLoadCount&&f!=UIIntentionalStream.REFRESH_PREPEND&&this.error)CSS.setStyle(this.error,'display','block');};UIIntentionalStream.prototype.handleFinally=function(b,a){if(b==UIIntentionalStream.REFRESH_TRANSITION){PageTransitions.transitionComplete();Arbiter.inform(NavigationMessage.NAVIGATION_COMPLETED);}this.hasPendingRefresh=false;};UIIntentionalStream.prototype.getValidParams=function(){return UIIntentionalStream.VALID_PARAMS;};UIIntentionalStream.prototype.getEndpoint=function(){return UIIntentionalStream.ENDPOINT;};UIIntentionalStream.prototype.getRefreshMethod=function(){return UIIntentionalStream.REFRESH_METHOD;};UIIntentionalStream.prototype.isOnNewHighlights=function(){var a=this.getCurrentFilterKey();return (UIIntentionalStream.isHighlightsFilter(a)||(a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED&&UIIntentionalStream.isHighlightsFilter(this.defaultFilter)));};UIIntentionalStream.prototype.isLiveStreamBox=function(){var a=this.getCurrentFilterKey();return a&&a.indexOf(UIIntentionalStream.FEED_FILTER_KEY_LIVE_STREAM_BOX)==0;};UIIntentionalStream.prototype.isOnNewsFeedFilter=function(){var a=this.getCurrentFilterKey();return (a==UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED||UIIntentionalStream.isHighlightsFilter(a)||a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED);};UIIntentionalStream.prototype.setupAutoInsert=function(){Arbiter.subscribe(UIIntentionalStreamMessage.SET_AUTO_INSERT,UIIntentionalStream.setAutoInsert);};UIIntentionalStream.setAutoInsert=function(b,a){if(b!=UIIntentionalStreamMessage.SET_AUTO_INSERT)return;var c=UIIntentionalStream.instance;if(c)c.pauseAutoInsert=a.pause;};UIIntentionalStream.prototype.isAutoRefreshPaused=function(){if(this.isOnNewHighlights()||this.isLiveStreamBox())return false;return this.pauseAutoInsert;};UIIntentionalStream.prototype.setUpStreamHeader=function(){if(!this.streamHeader)return;this.liveFeedBubble=DOM.scry(this.streamHeader,'span.uiBubbleCount')[0];if(!this.liveFeedBubble)return;this.liveFeedCount=DOM.scry(this.liveFeedBubble,'span.number')[0];if(!this.maxUnseenStoryCount)this.maxUnseenStoryCount=UIIntentionalStream.MAX_UNSEEN_STORY_COUNT;};UIIntentionalStream.prototype.refreshStream=function(e,a){if(e!=UIIntentionalStreamMessage.REFRESH_STREAM)return;var c=this.getCurrentFilterKey();if(this.isOnNewsFeedFilter()&&a.shouldOverride)c=UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS;var f=UIIntentionalStream.isHighlightsFilter(c);var b={filter:c};if(f)b.pending=f;var d={filter:c};a.noScroll&&(d.noScroll=1);this.refresh(UIIntentionalStream.REFRESH_TRANSITION,b,d);};copy_properties(UIIntentionalStream,{ANIMATION_DURATION:300,REFRESH_METHOD:'GET',REFRESH_TRANSITION:1,REFRESH_PREPEND:2,REFRESH_APPEND:3,REFRESH_COUNT:4,REFRESH_EXPAND:5,DELAYED_STREAM:6,REFRESH_BUBBLE:7,FEED_FILTER_KEY_NEW_HIGHLIGHTS:'h',FEED_FILTER_KEY_NEWS_FEED:'lf',FEED_FILTER_KEY_DUAL_NEWS_FEED:'nf',FEED_FILTER_KEY_LIVE_STREAM_BOX:'pub',VALID_PARAMS:['filter','show_hidden'],ENDPOINT:'/ajax/intent.php',MAX_UNSEEN_STORY_COUNT:300});
function UIIntentionalStreamRefresh(a,b){copy_properties(this,{isAutoRefreshing:false,lastRefresh:Date.now()});UIIntentionalStreamRefresh.instance=this;this.setAutoRefreshConfig(a);this.updateConfigHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,this.updateAutoRefreshConfig.bind(this));this.updateRefreshTimeHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME,this.updateLastRefreshTime.bind(this));onleaveRegister(this.unload.bind(this));this.userActivity();this.uaToken=UserActivity.subscribe(this.userActivity.bind(this));this.autoRefreshInterval=setInterval(this.checkAutoPageRefresh.bind(this),this.checkAutoRefreshTimeInterval);this.activeRefreshInterval=setInterval(this.checkActiveRefresh.bind(this),this.checkActiveRefreshTimeInterval);this.enableAutoRefresh(b);Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,LiveTimer.loop.bind(LiveTimer,true));Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,LiveTimer.loop.bind(LiveTimer,true));if(this.usePresence)UIIntentionalStreamRefresh.presenceRegister();}copy_properties(UIIntentionalStreamRefresh,{_presenceInit:false,DISABLE_AUTOREFRESH_TIME:4*60*1000,CHECK_AUTOREFRESH_INTERVAL:5*60*1000,AUTOREFRESH_INACTIVE_TIME:30*60*1000,HIGHLIGHTS_OVERRIDE_TIME:360*60*1000,CHECK_ACTIVE_REFRESH_TIME:5*60*1000,ACTIVE_REFRESH_TIME:30*1000});UIIntentionalStreamRefresh.presenceRegister=function(){if(UIIntentionalStreamRefresh._presenceInit)return true;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('feedpub'),UIIntentionalStreamRefresh.handleNewStoryMessage);UIIntentionalStreamRefresh._presenceInit=true;};UIIntentionalStreamRefresh.prototype.updateAutoRefreshConfig=function(b,a){if(b==UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG)this.setAutoRefreshConfig(a);};UIIntentionalStreamRefresh.prototype.updateLastRefreshTime=function(a){if(a==UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME)this.lastRefresh=Date.now();};UIIntentionalStreamRefresh.prototype.setAutoRefreshConfig=function(a){a=a||{};var b=24*60*60*1000;if(!this.storyInterval)this.storyInterval=coalesce(a.story_interval,null);this.allowAutoRefresh=coalesce(a.allow_auto_refresh,false);this.inactiveThreshold=coalesce(a.inactive_threshold,0);this.activeRefreshTime=coalesce(a.fast_refresh_rate,b);this.inactiveRefreshTime=coalesce(a.slow_refresh_rate,b);this.allowPolling=coalesce(a.allow_polling,false);this.refreshFactor=coalesce(a.refresh_factor,10);this.minRefreshInterval=coalesce(a.min_refresh_interval,60*1000);this.usePresence=coalesce(a.use_presence,false);this.activeRefresh=coalesce(a.active_refresh,false);this.checkActiveRefreshTimeInterval=coalesce(a.check_active_refresh_interval,UIIntentionalStreamRefresh.CHECK_ACTIVE_REFRESH_TIME);this.activeRefreshTimeInterval=coalesce(a.active_refresh_interval,UIIntentionalStreamRefresh.ACTIVE_REFRESH_TIME);this.disableAutoRefreshTime=coalesce(a.disable_autorefresh_time,UIIntentionalStreamRefresh.DISABLE_AUTOREFRESH_TIME);this.checkAutoRefreshTimeInterval=coalesce(a.check_autorefresh_time_interval,UIIntentionalStreamRefresh.CHECK_AUTOREFRESH_INTERVAL);this.autoRefreshInactiveTime=coalesce(a.autorefresh_inactive_time,UIIntentionalStreamRefresh.AUTOREFRESH_INACTIVE_TIME);this.highlightsOverrideTime=coalesce(a.highlights_override_time,UIIntentionalStreamRefresh.HIGHLIGHTS_OVERRIDE_TIME);return this;};UIIntentionalStreamRefresh.prototype.unload=function(){this.enableAutoRefresh(false);this.cleanupRefreshInterval();UserActivity.unsubscribe(this.uaToken);this.updateConfigHandler&&Arbiter.unsubscribe(this.updateConfigHandler);this.updateRefreshTimeHandler&&Arbiter.unsubscribe(this.updateRefreshTimeHandler);};UIIntentionalStreamRefresh.prototype.userActivity=function(){var a=this.isInactive();this.lastActivity=Date.now();this.isAutoRefreshing=true;if(a&&this.canAutoRefresh())this.runAutoRefresh();return true;};UIIntentionalStreamRefresh.prototype.isInactive=function(){return this.getMSSinceLastActivity()>this.inactiveThreshold;};UIIntentionalStreamRefresh.prototype.getMSSinceLastActivity=function(){return Date.now()-this.lastActivity;};UIIntentionalStreamRefresh.prototype.getMSSinceLastRefresh=function(){return Date.now()-this.lastRefresh;};UIIntentionalStreamRefresh.prototype.getRefreshInterval=function(){if(this.isInactive()){return this.inactiveRefreshTime;}else if(this.storyInterval!=null){var a=this.storyInterval*this.refreshFactor;return Math.max(a,this.activeRefreshTime);}else return this.activeRefreshTime;};UIIntentionalStreamRefresh.prototype.canAutoRefresh=function(){return this.isAutoRefreshing&&this.allowAutoRefresh;};UIIntentionalStreamRefresh.handleNewStoryMessage=function(b,a){if(b!=PresenceMessage.getArbiterMessageType('feedpub'))return;Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cancelUpdate=function(){if(this.updateTask){clearTimeout(this.updateTask);this.updateTask=null;}};UIIntentionalStreamRefresh.prototype.runUpdatePoll=function(){this.updateTask=null;if(this.canAutoRefresh())this.runAutoRefresh();};UIIntentionalStreamRefresh.prototype.runAutoRefresh=function(){var a=50;if(this.getMSSinceLastRefresh()>=this.minRefreshInterval-a)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);this.schedulePoll(this.getRefreshInterval());};UIIntentionalStreamRefresh.prototype.schedulePoll=function(a){this.cancelUpdate();if(this.allowPolling)this.updateTask=setTimeout(this.runUpdatePoll.bind(this),a);};UIIntentionalStreamRefresh.prototype.enableAutoRefresh=function(b,c){this.isAutoRefreshing=b;if(b){var a=c?0:this.getRefreshInterval();this.schedulePoll(a);}else this.cancelUpdate();};UIIntentionalStreamRefresh.prototype.checkAutoPageRefresh=function(){if(!this.allowAutoRefresh)return;if(this.isAutoRefreshing&&(this.getMSSinceLastActivity()>this.disableAutoRefreshTime))this.isAutoRefreshing=false;if(this.getMSSinceLastRefresh()<this.autoRefreshInactiveTime)return;var a=this.getMSSinceLastActivity();if(a>this.autoRefreshInactiveTime){var b=(a>this.highlightsOverrideTime);Arbiter.inform(UIIntentionalStreamMessage.REFRESH_STREAM,{shouldOverride:b});}};UIIntentionalStreamRefresh.prototype.checkActiveRefresh=function(){if(!this.allowAutoRefresh)return;if(this.getMSSinceLastRefresh()<this.activeRefreshTimeInterval)return;if(this.getMSSinceLastActivity()<this.activeRefreshTimeInterval)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cleanupRefreshInterval=function(){if(this.autoRefreshInterval){clearInterval(this.autoRefreshInterval);this.autoRefreshInterval=null;}};
onloadRegister(function(){add_properties('__behaviors',{});if(__behaviors.Scrollable)return;__behaviors.Scrollable=true;var c='scrollable';var b=function(event){var j=Parent.byClass(event.getTarget(),c);if(!j)return;if((typeof event.axis!=='undefined'&&event.axis===event.HORIZONTAL_AXIS)||(event.wheelDeltaX&&!event.wheelDeltaY)){event.prevent();return;}var e=event.wheelDelta?event.wheelDelta:-event.detail;var h=j.scrollHeight;var d=j.clientHeight;if(h>d){var i=j.scrollTop;if((e>0&&i===0)||(e<0&&i>=h-d)){event.prevent();}else if(ua.ie()<9){var g=CSS.getStyle(j,'font-size');if(g.indexOf('px')<0){var f=$N('div');f.style.fontSize=g;f.style.height='1em';g=f.style.pixelHeight;}else g=parseInt(g,10);j.scrollTop=i-Math.round(e/120*g);event.prevent();}}};var a=document.documentElement;if(ua.firefox()){a.addEventListener('DOMMouseScroll',b,false);}else Event.listen(a,'mousewheel',b);});
add_properties('TypeaheadBehaviors',{ie6Hacks:function(a){a.subscribe('init',function(){var b=new IframeShim(a.getView().getElement());a.subscribe(['reset','blur'],b.hide.bind(b));a.subscribe(['render','focus'],b.show.bind(b));});}});